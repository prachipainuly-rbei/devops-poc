@withportfolios
Feature: metrics
    These tests require the package cs.portfolios.


Scenario Outline: Change QC status to valid
    GIVEN a <type> quality characteristics definition exists
        AND a class association <description> exists
    WHEN the status of the quality characteristics definition is changed to valid
    THEN the quality characteristics objects are created

        Examples:
            | type   | description      |
            | class  |                  |
            | class  | with grouping    |
            | class  | with object rule |
            | object |                  |
            | object | with object rule |


Scenario Outline: Compute quality characteristics
    GIVEN a <type> quality characteristics definition exists
        AND a class association with a <rule> computation rule <description> exists
        AND the status of the quality characteristics definition is changed to valid
    WHEN the quality characteristics are computed
    THEN the quality characteristics are computed correctly

        Examples:
            | type            | rule           | description   |
            | class           | sql statistics |               |
            | class           | sql statistics | with grouping |
            | class           | custom         |               |
            | computed object | expression     |               |
            | computed object | custom         |               |


Scenario: Change a value in a tree structure and check aggregation
    GIVEN a object quality characteristics definition exists
        AND a class association exists
        AND the class association has aggregation
        AND the status of the quality characteristics definition is changed to valid
    WHEN the value of the quality characteristics of a children is changed
    THEN the aggregate value of the quality characteristics of the parent is changed


Scenario: Change a value in a tree structure and check automatic set of actual value
    GIVEN a object quality characteristics definition exists
        AND a class association which takes the aggregate value as actual value exists
        AND the class association has aggregation
        AND the status of the quality characteristics definition is changed to valid
    WHEN the value of the quality characteristics of a children is changed
    THEN the actual value of the quality characteristics of the parent is changed


@public
Scenario: Change a manual quality characteristic value in object kpi
    GIVEN the cdbqc_test_002 object with code=test001 exists
        AND it has a quality characteristic for QC_TEST_EMEA_PRICE
        AND the quality characteristic QC_TEST_EMEA_PRICE is not computed
        AND no history values exists for the quality characteristic QC_TEST_EMEA_PRICE 
    WHEN the user opens the object kpi cockpit on that object
        AND the user enters a value and submits it changes
    THEN the changed value is saved
        AND a new history entry with the value and quality grade manual has been created


Scenario: Compute sql statistics on class assignments with object rules which contain filter rules
    GIVEN the cdb_org object with name=QCTestOrganisation2 exists
        AND the angestellter object with personalnummer=cdbqc_test_user_001 exists
        AND the cdb_org object with name=QCTestOrganisation exists
        AND it has a quality characteristic for cdbqc_test_filter_rule
        AND the quality characteristic definition has a class association for cdb_organization
        AND the class association for cdb_organization has the object rule cdbqc_test_rule_for_filter_rule_test
        AND the class association for cdb_organization has the computation rule Count
    WHEN the user computes the quality characteristic cdbqc_test_filter_rule for it
    THEN the computed result is equal to the number of elements found by the object rule
