var global_hover_object = "";
var global_hover_subject = "";
var global_hover_semantic = "";

(function($) {    
	$.fn.hasVerticalScrollBar = function() {
		return (this.get(0)) ? this.get(0).scrollHeight > this.innerHeight() : false;
	}
})(jQuery);

(function($) {
	$.fn.hasHorizontalScrollBar = function() {
		return (this.get(0)) ? this.get(0).scrollWidth > this.innerWidth() : false;
	}
})(jQuery);

$(document).ready(function() {

	// fix for https://github.com/twitter/bootstrap/issues/4497
	$('body')
	  .off('click.dropdown touchstart.dropdown.data-api', '.dropdown')
	  .on('click.dropdown touchstart.dropdown.data-api', '.dropdown form', function (e) { 
		  e.stopPropagation();
	  });

	$(window).resize(optimizeTableHeight);
	
	$('div.block-content.collapse').on('shown hidden', function(ev) {
		optimizeTableHeight();
	});
	  
	$('#table_container').scroll(function() {
		if($('#matrix_content').hasVerticalScrollBar()){
			$("#column_container").css('margin-right','18px');
		} else {
			$("#column_container").css('margin-right','0px');
		}
		var l = $(this).scrollLeft();
		$("#column_container").scrollLeft(l);
	});

	$('#column_container').scroll(function(){
		var l = $(this).scrollLeft();
		$("#table_container").scrollLeft(l);
	});

	bindDropdown();
	bindHover();
	
	$('#row_treeview').treeview({
		collapsed: true
	});

	$('#row_treeview').on('click','div.hitarea', function() {
		expand_row_tree(this);
	});

	$('#col_treeview').on("click", "div.col_hitarea",function() {
		expand_column_tree(this);
	});

	$('table#col_treeview  td:last > div.col_line').addClass("col_last");
	$('table#col_treeview  td:not(td:last) > div.col_line').addClass("col_with_connector");

	updateMatrixPosition();
	$('#matrix_subject select').on('change', function() {
		lookupTypes(config_object_id,1);
		changeRelation(context_object_id, config_object_id);
	});
	$('#matrix_object select').on('change', function() {
		lookupTypes(config_object_id);
		changeRelation(context_object_id, config_object_id);
	});
	$('#matrix_object').on('submit','form', function(ev) {
		ev.stopPropagation();
		ev.preventDefault();
	});
	$('#matrix_subject').on('submit','form', function(ev) {
		ev.stopPropagation();
		ev.preventDefault();
	});
	$('#matrix_subject').on('keyup','input.filter_search', function(ev) {
		ev.stopPropagation();
		ev.preventDefault();
		if(ev.keyCode==13){
			search($(this).val(), context_object_id, config_object_id, 0);
		}
	});
	$('#matrix_object').on('keyup','input.filter_search', function(ev) {
		ev.stopPropagation();
		ev.preventDefault();
		if(ev.keyCode==13){
			search($(this).val(), context_object_id, config_object_id, 0, 1);
		}
	});
	$("#save-btn").on('click',function(ev){
		ev.preventDefault();
		ev.stopPropagation();
		save();
	});
		
	$("#reset-btn").on('click',function(ev){
		ev.preventDefault();
		ev.stopPropagation();
		reset();
	});
	$('input[placeholder]').placeholder();
	optimizeTableHeight();
});

function openElement(cdb_object_id, config_object_id, row_classname, col_classname, type_switch) {
	var data = {"cdb_object_id": cdb_object_id,
			    "config_object_id": config_object_id,
			    "row_classname": row_classname,
			    "col_classname": col_classname,
			    };
	if (type_switch) {
		data["classname"] = col_classname;
	} else {
		data["classname"] = row_classname;
	}
	$.ajax({
		url: window.location.pathname + "/determine_parent_tree",
		data: data,
		async: false,
		success: function(data) {
			if(data.success == 1){
				$(data.result).each(function() {
					if (type_switch) {
						if ($('div.col_hitarea', $('td.header_td[data-cdb_object_id='+this+']')).hasClass('col_hitarea collapsed')) {
				    		$('div.col_hitarea', $('td.header_td[data-cdb_object_id='+this+']')).trigger('click');
						}
					} else {
						if ($('div.hitarea', $('li.expandable[data-cdb_object_id='+this+']')).hasClass('hitarea')) {
				    		$('div.hitarea', $('li.expandable[data-cdb_object_id='+this+']')).trigger('click');
				    	}
					}
			    });
			} else {
				cdb.elink.alertCDBMessage(data.message);
			}
		}
	});
}

function scrollToSubject(element) {
	var matrix_content = $("#matrix_content");
	var links = $('div#row_container').find('a');
	var link = element.children('a').first();
	links.removeClass('search_highlight');
	link.addClass('search_highlight');
	link.attr('name', 'v_'+element.data('cdb_object_id'));
	window.location.hash=link.attr('name');
}

function scrollToObject(element) {
	var table_container = $("#table_container");
	var td = element.closest('tr').children('td');
	var link = element.find('a').first();
	td.removeClass('search_highlight');
	element.addClass('search_highlight');
	link.attr('name', 'h_'+element.data('cdb_object_id'));
	window.location.hash=link.attr('name');
}

function search_open(cdb_object_id, type_switch) {
	var func = function() {
		search_open1(cdb_object_id, type_switch);
	}
	cdb.elink.waiting(func, true);
}

function search_open1(cdb_object_id, type_switch) {
	var object_type_classname = $("#matrix_object select option:selected").data("cls_name");
	var subject_type_classname = $("#matrix_subject select option:selected").data("cls_name");
	openElement(cdb_object_id, config_object_id, subject_type_classname, object_type_classname, type_switch);
	if (type_switch) {
		var td_obj = $("td.header_td[data-cdb_object_id="+cdb_object_id+"]");
		scrollToObject(td_obj);
	} else {
		var li_obj = $("li[data-cdb_object_id="+cdb_object_id+"]");
		scrollToSubject(li_obj);
	}
}

function search(querystr, context_object_id, config_object_id, pageno, type_switch, no_waiting) {
	var func = function() {
		search1(querystr, context_object_id, config_object_id, pageno, type_switch);
	}
	if (!no_waiting) {
		cdb.elink.waiting(func, true);
	} else {
		func();
	}
}

function search1(querystr, context_object_id, config_object_id, pageno, type_switch) {
	var object_type_classname = $("#matrix_object select option:selected").data("cls_name");
	var subject_type_classname = $("#matrix_subject select option:selected").data("cls_name");
	var data = {"context_object_id": context_object_id,
			    "config_object_id": config_object_id,
			    "row_classname": subject_type_classname,
			    "column_classname": object_type_classname,
			    "querystr": querystr,
			    "pageno": pageno};
	if (type_switch) {
		data["classname"] = object_type_classname;
	} else {
		data["classname"] = subject_type_classname;
	}
	$.ajax({
		url: window.location.pathname + "/search",
		data: data,
		async: false,
		success: function(data){
			var data = $(data);
			var modalDialog = $("#myModal");
			var modalBody = modalDialog.children("div.modal-body"); 
			modalBody.empty();
			if($("#search_res", data).data('cdb-elink-search_res_count') == 0){
				var modalDia = $("#modalDialogNoSearch");
				cdb.elink.stopWaiting();
				modalDia.modal('show');
			} else if($("#search_res", data).data('cdb-elink-search_res_count') == 1){
				var found_cdb_object_id = $("#search_res", data).children('div').first().data('cdb-elink-cdb_object_id');
				search_open(found_cdb_object_id, type_switch);
			} else {
				modalBody.append(data.html());	
				modalBody.find('div.search_res a').each(function() {
					$(this).on("click", function(ev) {
						ev.preventDefault();
						var div = $(this).parent();
						var cdb_object_id = div.data("cdb-elink-cdb_object_id");
						modalDialog.modal("hide");
						search_open(cdb_object_id, type_switch);
					});
				});
				modalBody.find('div.pagination li').each(function(){
					$(this).on("click", function(ev) {
						var li = $(this);
						ev.preventDefault();
						var page_tab = $(this);
						var page_number = parseInt(li.data("elink-paginator-page"));
						search(querystr, context_object_id, config_object_id, page_number, type_switch, true);
					});
				});
				modalDialog.modal('show');
			}
		}
	});	
}

function optimizeTableHeight() {
	$("#matrix_content").css('max-height', "250px");
	var usable_height = $(window).height()-($("#matrix_content").offset().top+$("#matrix_content").height());
	var cur_max_height = parseInt($("#matrix_content").css('max-height').replace('px',''));
	if(usable_height>0){
		$("#matrix_content").css('max-height', usable_height+cur_max_height+'px');
	}
}

function changeRelation(context_object_id, config_object_id) {
	var object_type_classname = $("#matrix_object select option:selected").data("cls_name");
	var subject_type_classname = $("#matrix_subject select option:selected").data("cls_name");
	window.location.href = ("?context_object_id="+context_object_id+
						   "&config_object_id="+config_object_id+
						   "&rel_col_cls_name="+object_type_classname+
						   "&rel_row_cls_name="+subject_type_classname);
}

function lookupTypes(config_object_id, type_switch) {
	var subject_type_classname = $("#matrix_subject select option:selected").data("cls_name");
	var object_type_classname = $("#matrix_object select option:selected").data("cls_name");
	var type_selector;
	if (type_switch) {
		type_selector = $('#matrix_object');
		if (object_type_classname) {
			var data = {"config_object_id": config_object_id,
					    "object_type_classname": object_type_classname};
		} else {
			var data = {"config_object_id": config_object_id,
						"result_types": 1};
		}
	} else {
		type_selector = $('#matrix_subject');
		if (subject_type_classname) {
			var data = {"config_object_id": config_object_id,
					    "subject_type_classname": subject_type_classname};
		} else {
			var data = {"config_object_id": config_object_id};
		}
	}
	$.ajax({
		url: window.location.pathname + "/get_types",
		data: data,
		async: false,
		success: function(data) {
			if(data.success == 1) {
				var result_select = type_selector.find('select').first();
				var old_selected_type = type_selector.find("select option:selected").first().data('cls_name');
				var has_matches = false;
				result_select.empty();
				$(data.result).each(function(){
					var option_elem = $('<option></option>');
					option_elem.data('cls_name', this.cls_name);
					option_elem.text(this.label);
					if (this.cls_name == old_selected_type) {
						option_elem.attr("selected", "selected");
						has_matches = true;
					}
					option_elem.appendTo(result_select);
				});
				if (!has_matches) {
					result_select.children('option').first().attr("selected", "selected");
				}
			} else {
				cdb.elink.alertCDBMessage(data.message);
			}
		}
	});
}

function updateMatrixPosition() {
	$('#row_container').width(); //this helps IE to determine the width (first call returns 0, second call retuns real width)
	$('#table_container').css('margin-left',$('#row_container').width()+50 +"px");
	$('#column_container').css('margin-left',$('#row_container').width()+50 +"px");
	$('#matrix_object').css('margin-left',$('#row_container').width()+50 +"px");
}

function get_row_data(li) {
	var visible_columns = "";
	var subject_type_classname = $("#matrix_subject select option:selected").data("cls_name");
	var object_type_classname = $("#matrix_object select option:selected").data("cls_name");
	$('#matrix_table tr:first td').each(function() {
		visible_columns += $(this).data('cdb_object_id')+";";
	});
    $.ajax({
        url : window.location.pathname + "/row_data_loader",
        type : "POST",
        data : {'parent_object_id': li.data('cdb_object_id'),
        	    'config_object_id': config_object_id,
        	    'visible_columns':visible_columns,
        	    'context_object_id': context_object_id,
        	    'rel_row_cls_name': subject_type_classname,
        	    'rel_col_cls_name': object_type_classname},
        dataType : "html",
        cache : false,
        async: false,
        success : function(html) {
        	$('ul',li).empty();
        	var newhtml = $("div#row_data > ul", html).appendTo(li);
        	$("#row_treeview").treeview({add: newhtml});
            var currtr = $('#matrix_table tr[data-cdb_object_id='+li.data('cdb_object_id')+']');
            $("#matrix_rows tr", html).each(function() {
            	new_tr = $(this);
            	currtr.after(new_tr);
            	currtr = new_tr;
            	$('td',this).each(function() {
	            	var saved = $("#cell_container > div[data-row_object_id="+
	            				  new_tr.data('cdb_object_id')+"][data-col_object_id="+
	            				  $(this).data('cdb_object_id')+"]");
	            	if(saved.length) {
	            		var newtd = $('td[data-cdb_object_id='+$(this).data('cdb_object_id')+']',new_tr);
	            		newtd.data('value',saved.html());
	            		newtd.data('link_type_object_id', saved.data('link_type_object_id'));
	            		newtd.data('link_object_id',saved.data('link_object_id'));
	            		newtd.data('orig_value',saved.data('orig_value'));
	            		newtd.addClass('changed');
	            		var val = saved.html();
	            		if(val == "") {
	            			val = "&nbsp;";
	            		}
	            		newtd.find('a.dropdown-toggle').html(val);
	            		saved.remove();
	            	}
            	});
            });
            updateChangedAlert();
        	updateMatrixPosition();
        }
    });
}

function get_column_data(td) {
    var next_depth = parseInt(td.data('depth'))+1;
	var visible_rows = "";
	var subject_type_classname = $("#matrix_subject select option:selected").data("cls_name");
	var object_type_classname = $("#matrix_object select option:selected").data("cls_name");
	$('#matrix_table tr').each(function() {
		visible_rows += $(this).data('cdb_object_id')+";";
	});
    $.ajax({
        url : window.location.pathname + "/column_data_loader",
        type : "POST",
        data : {'parent_object_id': td.data('cdb_object_id'),
        	    'config_object_id': config_object_id,
        	    'depth': next_depth,
        	    'visible_rows': visible_rows,
        	    'context_object_id': context_object_id,
        	    'rel_row_cls_name': subject_type_classname,
        	    'rel_col_cls_name': object_type_classname},
        dataType : "html",
        cache : false,
        async: false,
        success : function(html) {
        	var newhtml;
            if ($("table#col_data td", html).length > 0) {
                var html_obj = $(html);
            } else {
            	return;
            }
            if(td.length > 0) {
                $("table#col_data td", html_obj).data("depth",next_depth);
                $("table#col_data td div.col_line:not(.col_last,.col_with_connector)", html_obj).each(function() {
                    var prev_line = $('div.col_line[data-layer='+$(this).data('layer')+']',td);
                    if(prev_line.length <= 0 || prev_line.hasClass('col_last')) {
                        $(this).removeClass('col_line').addClass('col_spacer');
                    }
                });
                newhtml = $("table#col_data td", html_obj).insertAfter(td);
            } else {
                $("table#col_data td", html_obj).data("depth", 0);
                newhtml = $("table#col_data tr", html_obj).appendTo($("#col_treeview"));
            }
            $("#matrix_columns tr", html).each(function() {
            	var newtd = $('td', $(this)).insertAfter($("#matrix_table tr[data-cdb_object_id="+
            											   $(this).data('cdb_object_id')+"] td[data-cdb_object_id="+
            											   td.data('cdb_object_id')+"]"));
            	var saved = $("#cell_container > div[data-col_object_id="+
            				  newtd.data('cdb_object_id')+"][data-row_object_id="+
            				  $(this).data('cdb_object_id')+"]");
            	if(saved.length) {
            		newtd.data('value',saved.html());
            		newtd.data('link_type_object_id', saved.data('link_type_object_id'));
            		newtd.data('link_object_id',saved.data('link_object_id'));
            		newtd.data('orig_value',saved.data('orig_value'));
            		newtd.addClass('changed');
            		var val = saved.html();
            		if(val == "") {
            			val = "&nbsp;";
            		}
            		newtd.find('a').html(val);
            		saved.remove();
            	}
            });
            updateChangedAlert();
        }
    });
}

function expand_row_tree(obj) {
	if($(obj).parent().hasClass('collapsable')) {
		get_row_data($(obj).parent());
	} else {
		collapse_row_tree($(obj).parent());
        $('ul', obj).empty();
        var newhtml = $("<li>loading...</li>").appendTo($('ul', obj));
        $("#row_treeview").treeview({
            add: newhtml
        });
	}
	optimizeTableHeight();
}

function expand_column_tree(obj) {
    if($(obj).hasClass("collapsed")) {
        $(obj).removeClass("collapsed").addClass("expanded");
    	get_column_data($(obj).parent());
    } else {
        collapse_column_tree(obj);
        $(obj).addClass("collapsed").removeClass("expanded");
    }
}

function collapse_column_tree(obj) {
	$('td[data-parent_object_id='+$(obj).parent().data('cdb_object_id')+']').each(function() {
		collapse_column_tree($('div.col_hitarea',this));
		$(this).remove();
		var changed = $("#matrix_table td[data-cdb_object_id="+$(this).data("cdb_object_id")+"].changed");
		changed.each(function() {
			var elem = "<div data-link_type_object_id=\""+
			$(this).data('link_type_object_id')+
			"\" data-link_object_id=\""+
			$(this).data('link_object_id')+
			"\" data-orig_value=\""+
			$(this).data('orig_value')+
			"\" data-col_object_id=\""+
			$(this).data("cdb_object_id")+
			"\" data-row_object_id=\""+
			$(this).parent('tr').data('cdb_object_id')+
			"\">"+$(this).data('value')+"</div>";
			$('#cell_container').append(elem);
		});
		if(changed.length) {
			updateChangedAlert();
		}
		$("#matrix_table td[data-cdb_object_id="+$(this).data("cdb_object_id")+"]").remove();
	});
}

function collapse_row_tree(obj) {
	obj.children("ul").each(function() {
		$(this).children("li").each(function() {
			var changed = $("#matrix_table tr[data-cdb_object_id="+
					        $(this).data("cdb_object_id")+"] > td.changed");
			changed.each(function() {
				var elem ="<div data-link_type_object_id=\""+
				$(this).data('link_type_object_id')+
				"\" data-link_object_id=\""+
				$(this).data('link_object_id')+
				"\" data-orig_value=\""+
				$(this).data('orig_value')+
				"\" data-col_object_id=\""+
				$(this).data("cdb_object_id")+
				"\" data-row_object_id=\""+
				$(this).parent('tr').data('cdb_object_id')+
				"\">"+$(this).data('value')+"</div>";
				$('#cell_container').append(elem);
			});
			if(changed.length) {
				updateChangedAlert();
			}
			$("#matrix_table tr[data-cdb_object_id="+$(this).data("cdb_object_id")+"]").remove();
			collapse_row_tree($(this));
		});
	});
	updateMatrixPosition();	
	optimizeTableHeight();
}

function bindDropdown() {
	var link_type_clone = $("#linktypeslink");
	$('#matrix_table').off('click','.cell-dropdown .dropdown-toggle');
	$('#matrix_table').on('click','.cell-dropdown .dropdown-toggle', function(ev) {
		ev.preventDefault();
		ev.stopPropagation();
		var cell = $(this).parent().parent();
			link_type_clone.parent().off('click');
			link_type_clone.parent().on('click', 'li', function(event) {
				event.preventDefault();
				//event.stopPropagation();
				var val = print_val = $(this).children('a').html();
	            var link_type_object_id = $(this).children('a').data('link_type_object_id');
				if(val == "("+empty_link+")") {
					val = "";
					print_val = "&nbsp;";
	                cell.data('link_type_object_id','');
				}
				$('.dropdown-toggle',cell).html(print_val);
				cell.data('value', val);
	            cell.data('link_type_object_id', link_type_object_id);
				if(val != cell.data('orig_value')) {
					cell.addClass('changed');
				} else {
					cell.removeClass('changed');
				}
			});
		$('#linktypeslink').trigger("click");
		var target = $(ev.currentTarget);
		$('#linktypeslink').parent().css('top',target.offset().top+'px');
		$('#linktypeslink').parent().css('left',target.offset().left+'px');
	});
	$('#linktypeslink').dropdown();
}

function bindHover() {	
	$("#matrix_table").on({
	    mouseenter: function() {
			$('li[data-cdb_object_id='+$(this).data('cdb_object_id')+']').children('a').css('color','red');
			$('li[data-cdb_object_id='+$(this).data('cdb_object_id')+']').children('a').addClass("hover_highlight");
		},
	    mouseleave: function() {
			$('li[data-cdb_object_id='+$(this).data('cdb_object_id')+']').children('a').css('color','');
			$('li[data-cdb_object_id='+$(this).data('cdb_object_id')+']').children('a').removeClass("hover_highlight");
		}},'tr');
	$('#matrix_table').on({
		mouseenter: function() {
			$('td.header_td[data-cdb_object_id='+$(this).data('cdb_object_id')+']').find('a').css('color','red');
			$('td.header_td[data-cdb_object_id='+$(this).data('cdb_object_id')+']').addClass("hover_highlight");
			set_hover_semantic($(this));
			show_hover_semantic();
			$(this).addClass("focus");
		},
		mouseleave: function() {
			$('td.header_td[data-cdb_object_id='+$(this).data('cdb_object_id')+']').find('a').css('color','');
			$('td.header_td[data-cdb_object_id='+$(this).data('cdb_object_id')+']').removeClass("hover_highlight");
			reset_hover_semantic();
			show_hover_semantic();
			$(this).removeClass("focus");
		}
	}, "td.cell");
}

function show_hover_semantic(){
	var visualization_container = $("#sem_visualization");
	if (visualization_container) {
		var subject_container = $(".sem_subject", visualization_container);
		var semantic_container = $(".sem_semantic", visualization_container);
		var object_container = $(".sem_object", visualization_container);
		if(subject_container && semantic_container && object_container) {
			subject_container.text(global_hover_subject);
			semantic_container.text(global_hover_semantic);
			object_container.text(global_hover_object);
		}
	}	
};

function set_hover_semantic(td_cell) {
	var object_id = td_cell.data('cdb_object_id');
	var subject_id = td_cell.parent().data('cdb_object_id');
	global_hover_subject = $.trim($('li[data-cdb_object_id='+subject_id+']').children('a').text());
	global_hover_object = $.trim($('td.header_td[data-cdb_object_id='+object_id+']').find('a').text());
	var semantic = $.trim(td_cell.children('div').children('a').text());
	var readonly_semantic = $.trim(td_cell.children('div').children('span').text());
	if(semantic == "") {
		global_hover_semantic = readonly_semantic;
	} else {
		global_hover_semantic = semantic;
	}
};

function reset_hover_semantic() {
	global_hover_subject ="";
	global_hover_object ="";
	global_hover_semantic ="";
	global_subject_id = "";
};

function save() {
	cdb.elink.waiting(save1, true);	
}

function save1() {
	var save_failed_elems = [];
	$("#matrix_table td.changed").each(function() {
		var td = $(this);
		ajaxdata = {link_object_id : $(this).data('link_object_id'),
					row_object_id: $(this).parent().data('cdb_object_id'),
					column_object_id: $(this).data('cdb_object_id'),
					link_type_object_id: $(this).data('link_type_object_id'),
		};
        $.ajax({
            url : window.location.pathname + "/save",
            type : "POST",
            data : ajaxdata,
            dataType : "json",
            cache : false,
            async: false,
            success : function(response, textStatus, XMLHttpRequest) {
            	if(response.success) {
            		td.data('orig_value',td.data('value'));
            		td.removeClass('changed');
                    if(td.data('value') == "") {
                        td.data('link_object_id','');
                    }
                    else {
                    	td.data('link_object_id',response.link_object_id);
                    }
            	} else {
            		save_failed_elems.push(ajaxdata.column_object_id);
    				cdb.elink.alertCDBMessage(response.message);
    			}
            }
        });
	});
	$("#cell_container div").each(function() {
		var td = $(this);
		ajaxdata = {link_object_id : $(this).data('link_object_id') ? $(this).data('link_object_id') : '',
				row_object_id: $(this).data('row_object_id'),
				column_object_id: $(this).data('col_object_id'),
				link_type_object_id: $(this).data('link_type_object_id') ? $(this).data('link_type_object_id') : '',
		};
        $.ajax({
            url : window.location.pathname + "/save",
            type : "POST",
            data : ajaxdata,
            dataType : "json",
            cache : false,
            async: false,
            success : function(response, textStatus, XMLHttpRequest) {
            	if(response.success) {
            		td.remove();
            	} else {
            		save_failed_elems.push(ajaxdata.column_object_id);
    				cdb.elink.alertCDBMessage(response.message);
    			}
            }
        });
	});
	$.ajax({
        url : window.location.pathname + "/save_hook",
        type : "POST",
        data : {'context_object_id': context_object_id},
        dataType : "json",
        cache : false,
        async: false,
        success : function(response, textStatus, XMLHttpRequest) {
        	if(response.success) {
        		update_all_cells(save_failed_elems);
        	} else {
				cdb.elink.alertCDBMessage(response.message);
			}
        }
    });
	updateChangedAlert();
}

function update_all_cells(save_failed_elems) {
	var ajaxdata = {links: []
					};
	var i=0;
	$("#matrix_table td").each(function() {
		if(save_failed_elems === undefined || save_failed_elems.indexOf($(this).data('cdb_object_id'))==-1){
			ajaxdata.links.push([$(this).data('cdb_object_id'),
			                     $(this).parent().data('cdb_object_id')]);
		}
	});
    $.ajax({
        url : window.location.pathname + "/fetchall",
        type : "POST",
        data : ajaxdata,
        dataType : "json",
        cache : false,
        async: false,
        success : function(response, textStatus, XMLHttpRequest) {
        	if(response.success) {
        		$.each(response.result, function(k,v) {
                    $.each(v, function(k2, v2) {
                        var td = $("tr[data-cdb_object_id="+k+"] > td[data-cdb_object_id="+k2+"]");
                        if(v2[1] == "") {
                            v2[1] = "&nbsp;";
                        }
                        td.data('orig_value',v2[1]);
                        $("a.dropdown-toggle", td).html(v2[1]);
                        $("span.readonly", td).html(v2[1]);
                        td.data("link_type_object_id",v2[0]);
                    });
        		});
        	}
        }
    });
}

function updateChangedAlert(count) {
	$("#changed_cells_alert").data('count',$("#cell_container").children().length);
	$("#changed_cells_alert").html($("#changed_cells_alert").data('count')+" "+
								   $('#cdb_link_matrix_change_count').html());
	$("#changed_cells_alert").show();
	if($("#changed_cells_alert").data('count') == "0") {
		$("#changed_cells_alert").hide();
	}
}

function reset() {
	$("#matrix_table td.changed").each(function() {
		$(this).data('value',$(this).data('orig_value'));
		var val = $(this).data('value');
		if(val == "") {
			val = "&nbsp;";
		}
		$(this).find('a.dropdown-toggle').html(val);
		$(this).removeClass('changed');
	});
	$("#cell_container").empty();
	updateChangedAlert();
}

var collapsibleBlocks = new cdbElinkCollapsibleBlocks();
collapsibleBlocks.blockSettingID = 'cs.tools.semanticlinks.linkmatrix';
cdb.elink.addApplication('cdb.elink.collapsibleblocks', collapsibleBlocks);