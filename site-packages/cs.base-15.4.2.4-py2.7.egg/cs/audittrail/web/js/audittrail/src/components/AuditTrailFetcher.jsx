/*
 * Copyright (C) 2017 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: AuditTrailFetcher.jsx 181644 2018-08-03 12:02:09Z ssa $"
 */

import React from 'react';
import {Alert} from 'react-bootstrap';
import {PropTypes, ImmutablePropTypes, connect} from 'cs-web-components-externals';
import {SearchApi, getJSON, postJSON} from 'cs-web-components-base';

const removeSearchInstance = SearchApi.Actions.removeSearchInstance;

function getSearchResult(state, instanceName) {
    return state.search.instances.getIn([instanceName, 'searchResult']);
}

function getSearchError(state, instanceName) {
    return state.search.instances.getIn([instanceName, 'searchError']);
}

function createRelshipSearchInstance(instanceName, parentObject, relshipName, tableName) {
    return {
        type: 'cs-web-components-base-SEARCH:CREATE_RELSHIP_SEARCH_INSTANCE',
        payload: {instanceName, parentObject, relshipName, tableName}
    };
}

function loadRelshipSearchForm(instanceName, formURL, submitURL) {
    return {
        type: 'cs-web-components-base-SEARCH:LOAD_RELSHIP_SEARCH_FORM',
        payload: {instanceName, formURL, submitURL}
    };
}

function getInstance(state, instanceName) {
    return state.search.instances.get(instanceName);
}

function relshipHasSearch(state, instanceName) {
    const instance = getInstance(state, instanceName);
    return instance.has('searchFormData') && instance.has('submitURL');
}

function getRelshipUrl(object) {
    return "/api/v1/collection/audittrail?object_id=" + object.get("cdb_object_id");
}

function getSubmitUrl(state, instanceName) {
    const instance = getInstance(state, instanceName);
    if (relshipHasSearch(state, instanceName)) {
        return instance.get('submitURL');
    }
    else {
        const relship_url =
            getRelshipUrl(instance.get('parentObject'));
        if (relship_url === undefined) {
            return undefined;
        }
        return `${relship_url}`;
    }
}

function getSearchRequestData(state, instanceName) {
    const instance = getInstance(state, instanceName);
    if (relshipHasSearch(state, instanceName)) {
        return {
            object_navigation_id: null,
            values: instance.get('searchValues') /* ,
            operation_state: instance.getIn(['searchFormData', 'original', 'operation_state']) */
        };
    }
    else {
        return {};
    }
}

const runSearch = (instanceName) => (dispatch, getState) => {
    const state = getState();
    const searchUrl = getSubmitUrl(state, instanceName);
    if (relshipHasSearch(state, instanceName)) {
        const request_data = getSearchRequestData(state, instanceName);
        postJSON(searchUrl, request_data).then(
            (result) => {
                if (result.error_message) {
                    return;
                }
                else {
                    dispatch({
                        type: 'cs-web-components-base-SEARCH:RELSHIP_SEARCH_DONE',
                        payload: {instanceName, result}
                    });
                }
            }
        );
    }
    else {
        // Just GET the data from the relationship URL
        getJSON(searchUrl).then(
            (result) => {
                if (result.error_message) {
                    return;
                }
                else {
                    dispatch({
                        type: 'cs-web-components-base-SEARCH:RELSHIP_SEARCH_DONE',
                        payload: {instanceName, result}
                    });
                }
            }
        );
    }
};

class RelationshipFetcher extends React.Component {
    constructor(props) {
        super(props);
        this.refreshTable = this.refreshTable.bind(this);
    }

    componentDidMount() {
        const {
            instanceName, active, contextObject, relshipName, tableName,
            createRelshipSearchInstance, runSearch
        } = this.props;
        createRelshipSearchInstance(instanceName, contextObject, relshipName, tableName);
        if (active) {
            runSearch(instanceName);
        }
    }

    componentWillUnmount() {
        this.props.removeSearchInstance(this.props.instanceName);
    }

    componentWillReceiveProps(nextProps) {
        if (!this.props.active && nextProps.active) {
            nextProps.runSearch(this.props.instanceName);
        }
        if (nextProps.searchAgainOpInfo &&
            nextProps.searchAgainOpInfo !== this.props.searchAgainOpInfo)
        {
            nextProps.loadRelshipSearchForm(
                nextProps.instanceName,
                nextProps.searchAgainOpInfo.get('form_url'),
                nextProps.searchAgainOpInfo.get('submit_url'));
        }
    }

    refreshTable() {
        if (this.props.active) {
            this.props.runSearch(this.props.instanceName);
        }
    }

    render() {
        const {searchAgainOpInfo, searchResult, searchError} = this.props;
        if (searchError !== null) {
            // On error, ignore the children and just render an error indication
            return <Alert bsStyle="warning">{searchError}</Alert>;
        }
        if (searchResult === null) {
            return null;
        }
        else {
            // Normal case, we have data and call the child function
            return this.props.children(
                searchResult.get('tabledef'),
                searchResult.get('rows'),
                this.refreshTable,
                searchAgainOpInfo);
        }
    }
}
RelationshipFetcher.propTypes = {
    instanceName: PropTypes.string.isRequired,
    contextObject: ImmutablePropTypes.map,
    relshipName: PropTypes.string.isRequired,
    tableName: PropTypes.string,
    active: PropTypes.bool,
    // store
    searchResult: ImmutablePropTypes.map,
    searchError: PropTypes.any,
    searchAgainOpInfo: ImmutablePropTypes.map,
    // actions
    createRelshipSearchInstance: PropTypes.func.isRequired,
    removeSearchInstance: PropTypes.func.isRequired,
    runSearch: PropTypes.func.isRequired,
    loadRelshipSearchForm: PropTypes.func.isRequired
};

RelationshipFetcher.defaultProps = {
    tableName: '',
    active: true
};

function searchAgainOperation(state, ownProps) {
    const {contextObject, relshipName} = ownProps;
    const refOpInfos = state.operationsByRelship.getIn(
        [contextObject.get('@id'), relshipName, 'reference_opinfo', 1]);
    if (!refOpInfos) {
        return undefined;
    }
    const opInfo = refOpInfos.find(op => op.get('opname') === 'CDB_SearchAgain');
    if (!opInfo || !opInfo.get('form_url') || !opInfo.get('submit_url')) {
        return undefined;
    }
    return opInfo;
}

function mapStateToProps(state, ownProps) {
    const {instanceName} = ownProps;
    return {
        searchResult: getSearchResult(state, instanceName),
        searchError: getSearchError(state, instanceName),
        searchAgainOpInfo: searchAgainOperation(state, ownProps)
    };
}

const actions = {
    createRelshipSearchInstance, removeSearchInstance,
    runSearch, loadRelshipSearchForm
};

export default connect(mapStateToProps, actions)(RelationshipFetcher);
