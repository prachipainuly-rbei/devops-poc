/**
 * Picture Uploader Application
 * @param appContext: the selector of the context element for this
 *                application.
 */
function cdbElinkPictureUploader(appContext) {
  // Application Name
  this.appName = 'PictureUploader';
  // Application event namespace
  this.eventNS = '.pictureuploader.cdbelink';
  this.checkURL = cdb.elink.baseURL +
                  "/powerscript/cs.shared.elink_plugins.picture_uploader/check_file_extension";

};

//Inherites elinkBase
cdbElinkPictureUploader.prototype = new cdbElinkBase();

// Event handler
cdbElinkPictureUploader.prototype.mouseEnterHandler = function(event) {
  var target = $(event.currentTarget);
  var picturePos = target.position();
  var tbutton = target.find('button');
  tbutton.show();
};

cdbElinkPictureUploader.prototype.mouseLeaveHandler = function(event) {
  var target = $(event.currentTarget);
  if (!target.find('img').hasClass('default-image')){
    target.find('button').hide();
  }
};

// Helper method to set the window title
cdbElinkPictureUploader.prototype.setWindowTitle = function(title) {
  this.popupWindow.find(".modal-header-content i.title-placeholder").text(title);
}

// Helper to disable/enable the submit button
cdbElinkPictureUploader.prototype.disableSubmit = function() {
  this.popupWindow.find('.btn.btn-primary').addClass('disabled');
}
cdbElinkPictureUploader.prototype.enableSubmit = function() {
  this.popupWindow.find('.btn.btn-primary').removeClass('disabled');
}
cdbElinkPictureUploader.prototype.submitDisabled = function() {
  return this.popupWindow.find('.btn.btn-primary').hasClass('disabled');
}


// prepare the upload window
cdbElinkPictureUploader.prototype.prepareModal = function(event){
  // To be impl. by caller/container page to set form data
}

//opens the upload window
cdbElinkPictureUploader.prototype.openModal = function(event){
  var target = $(event.currentTarget);
  var self = this;
  if(!target.hasClass('.disabled')){
    this.prepareModal(event);
    this.popupWindow.modal({show: true});
    this.disableSubmit();
  }
};

// submits form
cdbElinkPictureUploader.prototype.submit = function(event) {
  if (!this.submitDisabled()) {
    this.popupWindow.find('form').submit();
  } else {
    event.preventDefault();
    event.stopPropagation();
  }
};


//check the file type of upload window
cdbElinkPictureUploader.prototype.checkFileExtension = function(event) {
  var target = $(event.currentTarget);
  var filePath = target.val();

  this.disableSubmit();
  if (filePath.indexOf('.') > -1) {
	  var app = this;
	  $.ajax({ url: app.checkURL,
		  	   data: { "filename": filePath },
		  	   dataType: 'json',
		  	   type: 'POST',
		  	   success: function(data) {
		  		   if (data.success) {
			  		   if (data.result) {
			  			   app.enableSubmit();
			  		   }
		  		   } else {
		  			   alert(data.message);
		  		   }
		  	   }
	  		});
  }
}


cdbElinkPictureUploader.prototype.start = function() {
  this.popupWindow = $('#popup_image_modal', this.context);
  //Button position
  this.context.on(
      this.nsEvents('mouseenter'),
      '.elink-picture-preview',
      this.appEventHandler('mouseEnterHandler')
  ).on(
      this.nsEvents('mouseleave'),
      '.elink-picture-preview',
      this.appEventHandler('mouseLeaveHandler')
  ).on(
      this.nsEvents('click'),
      '.elink-picture-preview button',
      this.appEventHandler('openModal')
  );

  this.popupWindow.find('.btn.btn-primary').on(
    this.nsEvents('click'),
    this.appEventHandler('submit'));

  this.popupWindow.find('input:file').on(
      this.nsEvents('change'),
      this.appEventHandler('checkFileExtension'));

  $('.elink-picture-preview', this.context).has('img.default-image').each(function(){
    $(this).trigger('mouseenter');
  });
};


