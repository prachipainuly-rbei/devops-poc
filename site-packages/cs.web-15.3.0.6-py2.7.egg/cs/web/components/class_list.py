#!/usr/bin/env powerscript
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 2017 CONTACT Software GmbH
# All rights reserved.
# http://www.contact-software.com
#

"""
App that generates a simple HTML page with links to all class overview pages.
"""

__revision__ = "$Id: class_list.py 184543 2018-09-28 08:56:49Z heiko $"

import morepath

from cdb import sqlapi
from cs.platform.web import root
from cs.web.components.generic_ui import get_ui_app
from cs.web.components.generic_ui.class_view import ClassViewModel


class ClassListApp(morepath.App):
    pass


@root.Internal.mount(path="class-list", app=ClassListApp)
def _mount():
    return ClassListApp()


@ClassListApp.path(path="")
class ClassListModel(object):
    pass


@ClassListApp.html(model=ClassListModel)
def _html(_model, request):
    rs = sqlapi.RecordSet2(sql="SELECT DISTINCT(rest_visible_name)"
                               " FROM switch_tabelle"
                               " WHERE rest_visible_name <> ''"
                               " AND rest_api_active = 1"
                               " ORDER BY rest_visible_name")
    links = []
    ui_app = get_ui_app(request)
    for rec in rs:
        try:
            class_ui_link = request.class_link(ClassViewModel,
                                               {"rest_name": rec.rest_visible_name},
                                               app=ui_app)
            links.append('<li><a href="%s">%s</a></li>'
                         % (class_ui_link, rec.rest_visible_name))
        except morepath.error.LinkError:
            pass
    return """<!DOCTYPE html>
<html>
    <head>
        <title>Class List</title>
    </head>
    <body>
        <h1>REST visible classes:</h1>
        <ul>%s</ul>
    </body>
</html>""" % '\n'.join(links)
