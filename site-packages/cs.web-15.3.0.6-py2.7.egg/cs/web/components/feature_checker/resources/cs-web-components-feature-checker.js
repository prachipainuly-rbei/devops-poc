/*
 * Copyright (C) 2017 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: cs-web-components-feature-checker.js 163835 2017-08-24 07:42:54Z gwe $"
 */

function checkWebGL(canvas, hwSupport) {
    var attributes = {failIfMajorPerformanceCaveat: hwSupport};
    var gl =
        canvas.getContext("webgl", attributes) ||
        canvas.getContext("experimental-webgl", attributes);
    return (gl && gl instanceof WebGLRenderingContext);
}

function checkWebGL2(canvas, attributes) {
    var gl = canvas.getContext("webgl2", attributes);
    return (gl && gl instanceof WebGLRenderingContext);
}

function checkCanvas() {
    var paragraph = document.querySelector("#canvas-features");
    var canvas = document.querySelector("#the-canvas");
    var result = {};
    if (checkWebGL(canvas, true)) {
        result.webgl = "hardware";
    }
    else if (checkWebGL(canvas, false)) {
        result.webgl = "software";
    }
    else {
        result.webgl = "none";
    }
    if (checkWebGL2(canvas, true)) {
        result.webgl2 = "hardware";
    }
    else if (checkWebGL2(canvas, false)) {
        result.webgl2 = "software";
    }
    else {
        result.webgl2 = "none";
    }
    paragraph.innerHTML = "WebGL Support: " + result.webgl + ", WebGL2 Support: " + result.webgl2;
    return result;
}

function getCSRFToken() {
    var re = /CSRFToken=([^;]+)/;
    var cookieValue = re.exec(document.cookie);
    if (cookieValue) {
        return unescape(cookieValue[1]);
    }
    else {
        return undefined;
    }
}

function doCheck() {
    var resultData = {canvas: checkCanvas()};
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("POST", window.feature_checker_link);
    xmlhttp.setRequestHeader("Content-Type", "application/json");
    xmlhttp.setRequestHeader("X-Csrf-Token", getCSRFToken());
    xmlhttp.send(JSON.stringify(resultData));
}

window.addEventListener("load", doCheck, false);
