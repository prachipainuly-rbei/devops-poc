#!/usr/bin/env powerscript
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 2018 CONTACT Software GmbH
# All rights reserved.
# http://www.contact-software.com
#

"""
Test for Relship metadata API
"""

__revision__ = "$Id: test_relships.py 176920 2018-05-07 13:23:57Z gwe $"

import unittest
from webtest import TestApp as Client
from cs.platform.web.root import Root
from cdb import testcase


class TestRelships(testcase.RollbackTestCase):

    maxDiff = None

    def setUp(self):
        try:
            from cs.restgenericfixture import RelshipParent
        except ImportError:
            raise unittest.SkipTest("this test needs cs.restgenericfixture")
        self.c = Client(Root())

        # NEVER!!! raise after initializing the transaction context of
        # RollbackTestCase
        super(TestRelships, self).setUp()

    def test_1_n(self):
        response = self.c.get('/api/v1/class/rest_rel_parent/relships')
        json = response.json
        self.assertEqual(json, {u'DD_Children': {u'hide': False,
                                                 u'icon_url': u'',
                                                 u'is_one_on_one': False,
                                                 u'label': u'Children',
                                                 u'pos': 10,
                                                 u'reference_classname': u'rest_rel_child',
                                                 u'show_in_mask': True}})

    def test_1_1(self):
        response = self.c.get('/api/v1/class/rest_rel_child/relships')
        json = response.json
        self.assertEqual(json, {u'DD_Parent': {u'hide': False,
                                               u'icon_url': u'',
                                               u'is_one_on_one': True,
                                               u'label': u'Parent',
                                               u'pos': 10,
                                               u'reference_classname': u'rest_rel_parent',
                                               u'show_in_mask': True}})

    def test_n_m(self):
        response = self.c.get('/api/v1/class/fixture_nm_parent/relships')
        json = response.json
        self.assertEqual(sorted(json.keys()), ['Children', 'ChildrenRO'])
        self.assertEqual(json['Children'], {u'hide': False,
                                            u'icon_url': u'',
                                            u'is_one_on_one': False,
                                            u'label': u'Aggregierte Objekte',
                                            u'pos': 10,
                                            u'reference_classname': u'fixture_nm_target',
                                            u'show_in_mask': True})
        self.assertEqual(json['ChildrenRO'], {u'hide': False,
                                              u'icon_url': u'',
                                              u'is_one_on_one': False,
                                              u'label': u'Readonly NM',
                                              u'pos': 20,
                                              u'reference_classname': u'fixture_nm_target',
                                              u'show_in_mask': True})
