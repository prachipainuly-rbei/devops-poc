/*
 * Copyright (C) 2017 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: helpers.js 183876 2018-09-14 08:36:43Z cla $"
 */

import Immutable from 'immutable';
import {Console, getAppSetup} from '../helpers.js';

export const searchFavouritesLink = getAppSetup().getIn(
    ['links', 'common', 'searchFavourites']);

export function getClassViewSetup() {
    return getAppSetup().get('class_view');
}

export function getClassOpInfo(classname, action) {
    const setup = getClassViewSetup();
    if (setup) {
        const opInfos = setup.get('classOpInfos');
        for (const groupOps of opInfos.values()) {
            for (const opInfo of groupOps.values()) {
                if ((opInfo.get("opname") === action) &&
                    (opInfo.get("classname") === classname)) {
                    return opInfo;
                }
            }
        }
    } else {
        Console.warn('Trying to access appSetup[\'class_view\'] out of class context.');
    }

    return undefined;
}

export const FTS_ATTRNAME = 'cdb::argument.textindex';

export function filterRelevantValues(currValues, searchFields) {
    const searchParams = searchFields
        .map(fld => ({attribute: fld, value: currValues.get(fld, '')}));

    const ftsParam = currValues.get(FTS_ATTRNAME, '');
    if (ftsParam !== '' && !searchFields.includes(FTS_ATTRNAME)) {
        return searchParams.unshift({
            attribute: FTS_ATTRNAME,
            value: ftsParam
        });
    }

    return searchParams;
}

export function encodeSearchAttrs(values, searchFields) {
    const searchParams = filterRelevantValues(values, searchFields);
    const searchAttrs =
        Immutable.Map(searchParams.map(({attribute, value}) => [attribute, value]));
    return encodeURIComponent(JSON.stringify(searchAttrs.toJS()));
}
