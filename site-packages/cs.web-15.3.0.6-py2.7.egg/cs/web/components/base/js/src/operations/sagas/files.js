/*
 * Copyright (C) 2016 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: files.js 174905 2018-03-22 15:28:51Z cla $"
 */

import {ReduxSaga} from 'cs-web-components-externals';
import {fetchAndCheck} from '../../fetch.js';
import {addFiles, removeFiles} from '../../form/actions/form_with_operations.js';
import {ACTIONS} from '../constants.js';

const {put, call, takeEvery} = ReduxSaga.effects;

/** Add a file to the store */
function* addFileSaga(action) {
    yield put(addFiles(action.payload.instanceName, action.payload.files));
}

/** Remove a file from the store */
function* removeFileSaga(action) {
    yield put(removeFiles(action.payload.instanceName, action.payload.files));
}

/**
 * Handles uploading of files to ``object``.
 * This is called directly from operations.js.
 */
export function* uploadFiles(object, files) {
    const results = [];
    const uploadUrl = object['relship:files']['@id'];

    for (const file of files) {
        const formData = new FormData();
        formData.append('content', file);
        formData.append('metadata', JSON.stringify({
            cdbf_name: file.name,
            cdbf_primary: '1',
        }));

        try {
            const response = yield call(
                fetchAndCheck,
                uploadUrl,
                {method: 'POST', body: formData}
            );
            results.push({
                success: true,
                file: file.name,
                object: yield call([response, response.json]),
            });
        } catch (error) {
            results.push({
                success: false,
                file: file.name,
            });
        }
    }

    return results;
}

export default function* setupSagas() {
    yield takeEvery(ACTIONS.ADD_FILES, addFileSaga);
    yield takeEvery(ACTIONS.REMOVE_FILES, removeFileSaga);
}
