/*
 * Copyright (C) 2017 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: TableSelectionHelper.jsx 162336 2017-07-28 09:30:38Z gwe $"
 */

import Immutable from 'immutable';
import React from 'react';
import {connect, PropTypes, ImmutablePropTypes} from 'cs-web-components-externals';
import {setContextObjects} from '../../actions/context-objects.js';

class TableSelectionHelper extends React.Component {
    constructor(props) {
        super(props);
        this.onSelectionChanged = this.onSelectionChanged.bind(this);
    }

    /*
     * Convert the selectionIds from the table to the object IDs for the actual
     * REST objects.
     */
    selectedObjectIDs(selectedIds) {
        const {rows} = this.props;
        // Build a mapping selection ID => object ID for the selected entries
        const idMap = Immutable.Map(
            rows.filter(row => selectedIds.includes(row.get('id')))
                .map(row => [row.get('id'), row.get('restLink')])
        );
        // For the result, keep the selection order from the table.
        return selectedIds.map(id => idMap.get(id)).filter(oid => oid !== undefined);
    }

    onSelectionChanged(selection) {
        const {selectionName} = this.props;
        const {setContextObjects, onSelect} = this.props;
        const selectionIds = this.selectedObjectIDs(selection).toArray();
        setContextObjects(selectionName, ...selectionIds);
        if (onSelect) {
            onSelect(...selectionIds);
        }
    }

    render() {
        return this.props.children(this.onSelectionChanged);
    }
}
TableSelectionHelper.propTypes = {
    selectionName: PropTypes.string.isRequired,
    rows: ImmutablePropTypes.list,
    onSelect: PropTypes.func,
    // injected by connect
    setContextObjects: PropTypes.func.isRequired
};

export default connect(undefined, {setContextObjects})(TableSelectionHelper);
