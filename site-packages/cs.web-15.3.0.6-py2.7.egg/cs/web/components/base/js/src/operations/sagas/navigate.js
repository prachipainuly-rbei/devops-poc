/*
 * Copyright (C) 2016 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: navigate.js 174943 2018-03-23 09:00:39Z cla $"
 */

import {ReduxSaga} from 'cs-web-components-externals';
import {ACTIONS} from '../constants.js';
import {setWindowLocation} from '../helpers.js';

const {takeEvery, take, race, call} = ReduxSaga.effects;

function* handleTabAsyncSaga({payload}) {
    function selectTabAction(actionType) {
        return action => (
            actionType === action.type &&
            action.payload.tabId === payload.tabId
        );
    }

    const handle = window.open('about:blank', '_blank');
    const {onNavigate} = yield race({
        onNavigate: take(selectTabAction(ACTIONS.NAVIGATE_TAB_ASYNC)),
        close: take(selectTabAction(ACTIONS.CLOSE_TAB_ASYNC)),
    });

    if (onNavigate) {
        yield call(setWindowLocation, handle, onNavigate.payload.url);
    } else {
        yield call([handle, handle.close]);
    }
}

export default function* setupSagas() {
    yield takeEvery(ACTIONS.OPEN_TAB_ASYNC, handleTabAsyncSaga);
}
