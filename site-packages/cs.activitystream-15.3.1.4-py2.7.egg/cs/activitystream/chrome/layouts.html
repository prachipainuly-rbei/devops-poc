<!--! This macro should be used once in the application context element
      to get the label text pattern. -->
<metal:labels define-macro="label_texts">
  <div class="hide cdbblog-label-texts">
    <input type="hidden" data-elink-label="cdbblog_replying_to" value="${options.labels['cdbblog_replying_to']}" />
    <input type="hidden" data-elink-label="cdbblog_default_posting_title" value="${options.labels['cdbblog_default_posting_title']}" />
    <input type="hidden" data-elink-label="cdbblog_writing_comment_title" value="${options.labels['cdbblog_placeholder_reply']}" />
  </div>
</metal:labels>

<metal:defaulticon define-macro="default_posting_icon">
  <img src="${options.getIcon('cdbblog_posting')}"/>
</metal:defaulticon>

<metal:footer define-macro="posting_footer">
  <div class="posting-footer" tal:define="disable_comment disable_comment|False">
    <span class="posting-date muted">${postingtools.format_posting_date(blogitem.cdb_mdate)}</span>
    <span class="posting-footer-separator muted" tal:condition="not disable_comment">&bull;</span>
    <a href="#" title="${title_reply}"
       class="button-reply"
       tal:define="title_reply title_reply|options.labels['cdbblog_reply_action'];"
       tal:condition="not disable_comment">${title_reply}</a>
    <metal:moreactions define-slot="more_actions" />
  </div>
</metal:footer>

<metal:txt define-macro="posting_input">
  <tal:commenton define="disable_comment disable_comment|False"
                 condition="not disable_comment">
  <div class="cdbblog-posting-input row-fluid"
       tal:define="create_posting create_posting|nothing;
                   ph_label ph_label|'cdbblog_placeholder_new';
                   ph_label_txt options.labels[ph_label]">
    <input class="input-trigger span12" type="text"
           placeholder="${ph_label_txt}" />
    <div class="posting-input-form hide">
      <tal:newposting condition="create_posting">
        <label class="label"
               tal:define="labeltxt topic_description|postingtools.get_topic_description(topic_id)|topic_id;
                           labeltxt labeltxt if labeltxt else ph_label_txt">${labeltxt}</label>
      </tal:newposting>

      <!--! 'elink-posting-reply-to' is the label with text contains placeholder #NAME#,
            which should be replaced with content of '.replyto-title' element -->
      <label class="label label-reply-to"
             tal:condition="not create_posting"
             data-elink-cdbblog-label="cdbblog_replying_to"></label>
      <textarea rows="3" class="posting-text-field"
                data-elink-posting-reply-to=""></textarea>
      <div class="input-actions pull-right">
        <button type="button"
                class="btn btn-mini btn-primary posting-publish ${'create-posting' if create_posting else nothing}"
                disabled="disabled">${options.labels['cdbblog_btn_publish']}</button>
        <button type="button" class="btn btn-mini posting-cancel">${options.labels['cdbblog_btn_cancel']}</button>
      </div>
      <div class="clearfix"></div>
    </div>
  </div>
  </tal:commenton>
</metal:txt>

<metal:pl define-macro="posting_layout">
  <section data-elink-layout-element="posting">
  <div class="cdbblog-posting cdbblog-entity"
       data-elink-cdb_object_id="${posting.cdb_object_id}"
       data-elink-last_comment_date="${postingtools.format_date(posting.last_comment_date)}">
    <div class="posting-icon heading3">
      <metal:pc define-slot="posting_icon">
      <metal:defaulticon use-macro="postingtools.templates()['custom_layouts.html'].macros.default_posting_icon|
                                    postingtools.templates()['layouts.html'].macros.default_posting_icon" />
      </metal:pc>
    </div>
    <div class="posting-content ${posting.GetClassname()}">
      <metal:pc define-slot="posting_content" />
    </div>
  </div>
  </section>
</metal:pl>

<metal:usertext define-macro="cdbblog_user_text">
  <section>
    <div class="posting-detail cdbblog-entity ${blogitem.GetTableName()}"
         data-elink-cdb_object_id="${blogitem.cdb_object_id}"
         tal:define="userinfo postingtools.get_user_info(blogitem);
                     username postingtools.format_user_name(blogitem);
                     userpic userinfo[1];
                     userlink userinfo[2]">
      <a id="${blogitem.cdb_object_id}" class="cdbblog-posting-anchor"></a>
      <div class="user-picture">
        <a href="${userlink}" target="_blank">
          <img src="${options.base_uri}powerscript/cdb.apps.preview.app/pic?cdb_file_id=${userpic}" tal:condition="userpic" />
          <img src="${options.localres_base}cs.activitystream/person.png" tal:condition="not userpic" />
        </a>
      </div>
      <div class="posting-text"
           tal:define="gettxt postingtools.get_blogitem_text(blogitem);
                       postingtext gettxt[0];
                       has_more_text gettxt[1];
                       reply_to_comment postingtools.in_reply_to_comment(blogitem)">
        <!--! '.replyto-title' element will be showed in label of replying form -->
        <h4 class="user-name replyto-title title-text" data-elink-cdbblog-username="${username}">
          <span tal:condition="not reply_to_comment" tal:omit-tag=""><a href="${userlink}" target="_blank">${username}</a></span>
          <span tal:condition="reply_to_comment" tal:omit-tag=""><a href="${userlink}" target="_blank">${username}</a>:
            <span tal:omit-tag="">${options.labels['cdbblog_comment_title']}</span>
            <a href="#${blogitem.in_reply_to}" class="reply-to-comment"
               data-elink-cdbblog-in_reply_to="${blogitem.in_reply_to|nothing}">${postingtools.get_reply_to_title_message_by(blogitem)}</a>
          </span>
        </h4>
        <p class="text-para">
          <span tal:replace="structure postingtext"></span>&nbsp;
          <a href="#" title="${title_more}"
            class="button-more-text"
            tal:condition="has_more_text|nothing"
            tal:define="title_more options.labels['cdbblog_more']">${title_more}&rarr;</a>
        </p>
        <metal:footer use-macro="postingtools.templates()['custom_layouts.html'].macros.posting_footer|
                                 postingtools.templates()['layouts.html'].macros.posting_footer" />
      </div>
    </div>
  </section>
</metal:usertext>

<metal:comments define-macro="cdbblog_comments">
  <div class="posting-comments ${commentscls}"
       tal:define="comment_count comment_count|None;
                   commentsinfo postingtools.get_all_comments(posting, comment_count);
                   commentscls '' if commentsinfo[1] else 'no-comments';
                   morecomments commentsinfo[1] - len(commentsinfo[0])">
    <a class="more-comments" href=""
       tal:condition="morecomments>0">${options.labels['cdbblog_show_all_replies'] % commentsinfo[1]}&nbsp;&raquo;</a>
    <tal:comment repeat="blogitem commentsinfo[0]">
      <metal:comment use-macro="postingtools.templates()['custom_layouts.html'].macros.cdbblog_user_text|
                                postingtools.templates()['layouts.html'].macros.cdbblog_user_text" />
    </tal:comment>
    <metal:inputfield use-macro="postingtools.templates()['custom_layouts.html'].macros['posting_input']|
                                 postingtools.templates()['layouts.html'].macros['posting_input']"
                      tal:define="ph_label reply_ph_label|'cdbblog_placeholder_reply'"/>
  </div>
</metal:comments>

<metal:sp define-macro="base_cdbblog_user_posting"
          tal:define="ctxobj posting.ContextObject">
  <metal:uselayout use-macro="postingtools.templates()['custom_layouts.html'].macros.posting_layout|
                              postingtools.templates()['layouts.html'].macros.posting_layout">
    <metal:spcontent fill-slot="posting_content">
      <div class="posting-title">
        <metal:titletext define-slot="title_text">
        <h3 tal:condition="ctxobj">${options.labels['cdbblog_posting_to_topic']}&nbsp;
          <a href="${ctxobj.MakeURL('CDB_ShowObject')}"
             target="_blank">${ctxobj.GetDescription()}</a></h3>
        </metal:titletext>
        <h3 tal:condition="not ctxobj">${options.labels['cdbblog_posting_to_all']}</h3>
      </div>
      <metal:usertext use-macro="postingtools.templates()['custom_layouts.html'].macros.cdbblog_user_text|
                                 postingtools.templates()['layouts.html'].macros.cdbblog_user_text"
                      tal:define="blogitem posting"/>
      <metal:footer use-macro="postingtools.templates()['custom_layouts.html'].macros.cdbblog_comments|
                               postingtools.templates()['layouts.html'].macros.cdbblog_comments"
                    tal:define="reply_ph_label 'cdbblog_placeholder_reply'"/>
    </metal:spcontent>
  </metal:uselayout>
</metal:sp>

<metal:sp define-macro="cdbblog_user_posting"
          tal:define="ctxobj posting.ContextObject;
                      pluginapp postingtools.plugin(ctxobj) if ctxobj else None">
   <metal:redirect use-macro="pluginapp.getTemplate('macros.html').macros['userposting_plugin']|
                              postingtools.templates()['custom_layouts.html'].macros['base_cdbblog_user_posting']|
                              postingtools.templates()['layouts.html'].macros['base_cdbblog_user_posting']" />
</metal:sp>


<metal:sp define-macro="base_cdbblog_system_posting"
          tal:define="ctxobj posting.ContextObject;
                      no_channels no_channels|None;
                      title_reply options.labels['cdbblog_comment_action']">
  <metal:uselayout use-macro="postingtools.templates()['custom_layouts.html'].macros.posting_layout|
                              postingtools.templates()['layouts.html'].macros.posting_layout">
    <metal:spicon fill-slot="posting_icon"
                  tal:condition="ctxobj" >
      <img src="${ctxobj.GetClassIcon()}" />
    </metal:spicon>
    <metal:spcontent fill-slot="posting_content">
      <div class="system-posting-layout">
        <div class="posting-title">
          <div class="posting-title-actions clearfix">
            <metal:infobtn define-slot="link_buttons">
            <div class="action-buttons pull-right">
              <metal:ops use-macro="global_plugins['components'].macros.operations_dropdown"
                         tal:define="obj ctxobj"
                         tal:condition="ctxobj"/>
            </div>
            </metal:infobtn>
            <span class="label pull-right"
                 tal:condition="not ctxobj">
              ${options.labels['cdbblog_context_object_deleted']}</span>
          </div>
          <div class="posting-title-text">
            <metal:titletext define-slot="title_text"><h3>${posting.getTitle()}</h3></metal:titletext>
          </div>
        </div>
        <div class="replyto-title"></div>
        <tal:withchannels condition="not no_channels">
          <div class="posting-topics"
            tal:define="topics postingtools.get_supplementary_topics(posting)"
            tal:condition="topics">
            <img src="${options.localres_base}cs.activitystream/op_subscribe.png"/>
            <span tal:repeat="topic topics">
              <a href="${topic.MakeURL('CDB_ShowObject')}">${postingtools.short_description(topic.GetDescription(), 100, 24, len(topics))}</a>
              <span class="muted" tal:condition="not repeat.topic.end">&bull;</span>
            </span>
          </div>
        </tal:withchannels>
        <div class="posting-references no-float">
          <metal:ref define-slot="references" />
        </div>
        <metal:footer use-macro="postingtools.templates()['custom_layouts.html'].macros.posting_footer|
                                 postingtools.templates()['layouts.html'].macros.posting_footer"
                      tal:define="blogitem posting"/>
        <metal:footer use-macro="postingtools.templates()['custom_layouts.html'].macros.cdbblog_comments|
                                 postingtools.templates()['layouts.html'].macros.cdbblog_comments"
                      tal:define="title_reply options.labels['cdbblog_reply_action'];
                                  reply_ph_label 'cdbblog_placeholder_comment'"/>
      </div>
    </metal:spcontent>
  </metal:uselayout>
</metal:sp>

<metal:sp define-macro="cdbblog_system_posting"
          tal:define="ctxobj posting.ContextObject;
                      pluginapp postingtools.plugin(ctxobj) if ctxobj else None">
   <metal:redirect use-macro="pluginapp.getTemplate('macros.html').macros['systemposting_plugin']|
                              postingtools.templates()['custom_layouts.html'].macros['base_cdbblog_system_posting']|
                              postingtools.templates()['layouts.html'].macros['base_cdbblog_system_posting']" />
</metal:sp>
