#!/usr/bin/env python
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 2013 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#

__revision__ = "$Id: __init__.py 138740 2016-03-21 08:22:42Z cso $"

from cdb import sqlapi
from cdb import transaction
from cdb.dberrors import DBConstraintViolation


class InitNotificationSettings(object):
    __tables__ = ["cdb_setting", "cdb_usr_setting"]

    def run(self):
        """
        copy defaults and user settings from user.email_with_task (cs.shared)
        """
        with transaction.Transaction():
            for table in self.__tables__:
                columns = sqlapi.RecordSet2("cdb_columns",
                                            "table_name='%s'" % table)
                col_str = ", ".join(c.column_name for c in columns
                                    if c.column_name != "setting_id")
                try:
                    sqlapi.SQLinsert(
                        "INTO %s (setting_id, %s) "
                        "SELECT 'user.email_with_sharing', %s FROM %s "
                        "WHERE setting_id='user.email_with_task'"
                        % (table, col_str, col_str, table))
                except DBConstraintViolation:
                    pass


post = [InitNotificationSettings]


if __name__ == "__main__":
    InitNotificationSettings().run()
