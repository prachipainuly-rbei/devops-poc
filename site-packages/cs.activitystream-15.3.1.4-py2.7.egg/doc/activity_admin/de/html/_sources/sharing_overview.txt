.. _`overview`:
.. _`HELPID_cdb_sharing_admin`:

Objekte teilen
##############


Operationsablauf
================

Die Operation `Teilen (cdb_share_objects)` kann mit oder ohne Kontext aufgerufen
werden. Im Wesentlichen ruft sie die URL des Dialogs zum Teilen auf, ggf.
ergänzt um die cdb_object_ids der Kontextobjekte.

* URL ohne Kontext: `$CADDOK_WWWSERVICE_URL/share_objects`
* URL mit Kontext: `$CADDOK_WWWSERVICE_URL/share_objects?attachments=eb5af880-4be0-11e0-a016-005056c00008,99504583-76e1-11de-a2d5-986f0c508d59`

Im Dialog muss der Nutzer jeweils mindestens ein geteiltes Objekt und einen
Empfänger auswählen. Da auch allgemeine Rollen und |groups| als Empfänger
nutzbar sind, kann die Operation erst nach Abschluss sicher bestimmen, ob die
Auswahl mindestens einen gültigen Empfänger enthält.

Sobald der Dialog erfolgreich abgeschlossen wird, wird im Hintergrund ein Objekt
der Klasse `cdb_sharing (cs.sharing.Sharing)` angelegt. Dieses dient als
Nachrichtenkanal, in dem sofort ein Beitrag mit dem eingegebenen Nachrichtentext
und den geteilten Objekten als Anhang erstellt wird. Das Objekt selbst enthält
ansonsten nur Daten der Änderungsverfolgung, wobei nur Anlagedatum und Ersteller
(`cdb_cdate` respektive `cdb_cpersno`) relevant sind.

Nachrichten abonnierter Kanäle für das `cdb_sharing` Objekt sowie eventuelle E-Mail
Benachrichtigungen (einstellbar in den persönlichen Einstellungen) werden
asynchron durch eine Message Queue erzeugt. Wartende und fehlgeschlagene Aufträge
können Sie unter
:menuselection:`Administration/Konfiguration --> Teilen --> Teilen-Aufträge`
einsehen und ggf. neu starten.


.. _`HELPID_cdb_sharing_admin_group`:

|groups|
========

Nutzer haben die Möglichkeit, sich die aktuelle Auswahl an Empfängern als eigene
|group| zu speichern. Dazu vergeben sie einen Namen und es wird ein Objekt der
Klasse `cdb_personal_sharing_group (cs.sharing.groups.PersonalSharingGroup)`
und die Empfänger als Einträge der Klasse
`cdb_sharing_group_member (cs.sharing.groups.SharingGroupMember)`
angelegt.

Als zugeordnete Empfänger zulässig sind zur Zeit nur Benutzer (`angestellter`), 
allgemeine Rollen (`cdb_global_role`) und |groups| selbst, wobei diese
Einschränkung bei der Anlage nicht geprüft wird.

|groups| können auch administrativ für bestimmte Anwenderkreise (z.B. "public")
eingerichtet werden. Ist eine |group| für eine Rolle eingerichtet, sehen alle
Inhaber dieser Rolle die |group| und können sie verwenden. Änderungsrechte sind
in diesem Fall aber Administratoren vorbehalten.


Objektspezifische |groups|
--------------------------

Geteilte Objekte können dynamische |groups| (Klasse
`cdb_object_sharing_group (cs.sharing.groups.ObjectSharingGroup)`)
besitzen, die der Nutzer als Empfänger auswählen kann. Diese Listen sind
vordefiniert und werden anhand einer Objektregel allen geteilten Objekten
zugeordnet, die diese Regel erfüllen.

Aufgelöst werden diese Listen entweder anhand einer Objektmethode der
Powerscriptklasse des geteilten Objekts oder eines ihrer Attribute. Im ersten
Fall muss die Methode eine Liste von Tupeln aus `subject_id` und `subject_type`
zurück liefern, im zweiten muss das Attribut genau eine Personalnummer
(`angestellter.personalnummer`) enthalten.


Eingebettete |esearch|
======================

Der "Teilen" Dialog nutzt die |esearch| für die Funktionalität des Feldes "Nach
Objekten suchen". Bitte stellen Sie sicher, dass alle hierfür benötigten Dienste
laufen und erreichbar sind.


Einrichtung für eigene Klassen
==============================

Damit Objekte einer Klasse geteilt werden können, muss die Klasse zunächst für
die REST API freigeschaltet werden. Dazu muss in der Klassenkonfiguration die
Option "REST API aktiv" an und ein eindeutiger "REST Name" vergeben sein.


Operation verfügbar machen
--------------------------

Um im Kontextmenü ihrer eigenen Klasse die Operation ``Teilen`` nutzbar zu
machen, müssen Sie zunächst die Operation ``cdb_share_objects`` in der
Operationskonfiguration (
:menuselection:`Administration/Konfiguration --> Administration --> Operationen`
) für die Klasse aktivieren. Anschließend müssen Sie in der Powerscriptklasse
Code analog zu diesem Beispiel einbinden:


.. code-block:: python

    from cs.sharing.share_objects import WithSharing
    from cs.documents import Document

    class MyClass(Document, WithSharing):
        pass


.. _`HELPID_cdb_sharing_admin_object_group`:

Objektspezifische |groups| einrichten
-------------------------------------

Objektspezifische |groups| für die Klasse können wie folgt eingerichtet werden:

#. Anlage einer neuen |group| (oder Auswahl einer bestehenden) unter 
   :menuselection:`Administration/Konfiguration --> Teilen --> Empfängerlisten`
#. Die Objektregel der |group| muss ein Prädikat mit mindestens einem Term für
   die Klasse enthalten. Nur Objekte, die diese Regel erfüllen, bieten die
   |group| im Dialog an.
#. Wenn die |group| nicht mit einem einfachen Attribut auskommt, in dem eine
   Personalnummer steht, muss eine Methode an der Powerscriptklasse eingerichtet
   werden, z.B. so:


.. code-block:: python

    from cdb.objects import Object

    class myObjectsClass(Object):
        def getCustomRecipients(self, sharingGroup):
            "Empfängerliste auflösen/resolve recipient list"
            return [(self.cdb_cpersno, "Person"),
                    (self.subject_id, self.subject_type),
                    ("Administrator", "Common Role")]


.. |group|  replace:: Empfängerliste
.. |groups|  replace:: Empfängerlisten
.. |Group_en|  replace:: Recipient List
.. |Groups_en|  replace:: Recipient Lists
.. |group_en|  replace:: recipient list
.. |groups_en|  replace:: recipient lists
