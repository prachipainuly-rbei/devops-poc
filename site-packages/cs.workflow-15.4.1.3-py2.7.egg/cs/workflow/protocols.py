#!/usr/bin/env python
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 1990 - 2013 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#

"""
Module Protocols

This is the documentation for the Protocols module.
"""

__docformat__ = "restructuredtext en"
__revision__ = "$Id: protocols.py 166021 2017-09-28 09:14:01Z cso $"

import datetime

from cdb import auth, util
from cdb.objects import Forward, Object, Reference

__all__ = ['MSGCANCEL',
           'MSGDONE',
           'MSGINFO',
           'MSGSYSTEM',
           'MSGTASKREADY',
           'MSGUSER',
           'Protocol']

fProcess = Forward("cs.workflow.processes.Process")
fTask = Forward("cs.workflow.tasks.Task")
fUser = Forward("cdb.objects.org.User")

MSGCANCEL = "CANCEL"
MSGDONE = "DONE"
MSGAPPROVED = "APPROVED"
MSGINFO = "INFO"
MSGREFUSE = "REFUSE"
MSGSYSTEM = "SYSTEM"
MSGTASKREADY = "INFO"  # workaround while E026300 is open
MSGUSER = "USER"


class Protocol(Object):

    __maps_to__ = "cdbwf_protocol"
    __classname__ = "cdbwf_protocol"

    Process = Reference(1, fProcess, fProcess.cdb_process_id)
    Task = Reference(1, fTask, fTask.task_id, fTask.cdb_process_id)
    User = Reference(1, fUser, fUser.personalnummer)

    def on_create_pre_mask(self, ctx):
        self.timestamp = datetime.datetime.now()
        self.personalnummer = auth.persno
        if self.task_id and self.Task:
            ctx.set('task_title', self.Task.title)

    def on_create_pre(self, ctx):
        self.msgtype = MSGUSER
        self.entry_id = Protocol.MakeEntryId()

    @classmethod
    def MakeEntryId(cls):
        return util.nextval("cdbwf_protocol.entry_id")
