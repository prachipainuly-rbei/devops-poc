#!/usr/bin/env powerscript
# -*- python -*- coding: utf-8 -*-
#
# Copyright (C) 2018 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/

"""
Module cs.workflow.designer.urls

Calculate "external" urls (those outside of the designer's url namespace)
"""

__docformat__ = "restructuredtext en"
__revision__ = "$Id: urls.py 172249 2018-01-24 11:14:23Z cso $"

import urllib
from cdb import misc as cdb_misc
from cs.platform.web.root.main import _get_dummy_request
from cs.platform.web.uisupport import get_ui_link
from cs.workflow import misc

URL_PATTERN_SAFE_CHARS = '/?='
PROTOCOL_URL_PATTERN = (
    '/info/process_protocol/?search_attrs='
    '{{"cdbwf_protocol.cdb_process_id":"{cdb_process_id}"}}')


def quote(url):
    """
    Replaces url with http-escaped chars. Expects a relative url, e.g. no
    ``protocol://`` prefix, as colons are escaped, too.
    """
    return urllib.quote(url, safe=URL_PATTERN_SAFE_CHARS)


def get_protocol_url(cdb_process_id):
    """
    Returns relative link to protocol entries with given ``cdb_process_id``.
    """
    return quote(PROTOCOL_URL_PATTERN.format(cdb_process_id=cdb_process_id))


def get_object_url(obj):
    """
    Returns absolute link to ``/info/{rest_name}/{rest_key}`` of ``obj``.
    Requires ``CADDOK.WWWSERVICE_URL`` to be set.
    """
    result = get_ui_link(_get_dummy_request(misc.get_base_url()), obj)

    if result is None:
        cdb_misc.log_error(
            "Cannot resolve object URL for {} '{}'. Class or "
            "operation not activated for cs.web?".format(obj.GetClassname(),
                                                         obj.GetDescription()))

    return result
