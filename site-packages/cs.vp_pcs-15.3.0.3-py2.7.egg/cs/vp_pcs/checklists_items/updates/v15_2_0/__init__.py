#!/usr/bin/env powerscript
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 1990 - 2013 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/

from cdb.comparch import protocol
from cdb import sqlapi
from cdb import ue
from cdb import ddl


class UpdateChecklistID(object):
    def run(self):
        try:
            t = ddl.Table(u"cdbpcs_part2cl")
            col = t.getColumn(u"checklist_id")
            t.dropPrimaryKey()

            col2 = ddl.Integer(colname=u"checklist_id2", notnull=0,
                               comment=col.comment, default=col.default)
            t.addAttributes(col2)
            sqlapi.SQL(u"UPDATE cdbpcs_part2cl SET checklist_id2 = checklist_id")
            t.dropAttributes(col)

            col = ddl.Integer(colname=u"checklist_id", notnull=0,
                              comment=col.comment, default=col.default)
            t.addAttributes(col)
            sqlapi.SQL(u"UPDATE cdbpcs_part2cl SET checklist_id = checklist_id2")
            t.dropAttributes(col2)

            col.notnull = 1
            t.modifyAttributes(col)

            pk = ddl.PrimaryKey(u"teilenummer", u"t_index",
                                u"cdb_project_id", u"checklist_id")
            t.setPrimaryKey(pk)
        except Exception, e:
            protocol.logWarning(msg=u"Table 'cdbpcs_part2cl' could not be altered.",
                                details_longtext=e)
            raise e


pre = [UpdateChecklistID]
post = []
