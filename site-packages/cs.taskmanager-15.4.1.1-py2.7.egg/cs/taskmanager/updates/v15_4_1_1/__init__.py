# coding: utf-8
from cdb.comparch import content
from cdb.comparch import modules
from cdb.comparch import protocol


def revert_deleted_patch(module_id, table, **kwargs):
    m = modules.Module.ByKeys(module_id)
    content_filter = content.ModuleContentFilter([table])
    mc = modules.ModuleContent(
        m.module_id,
        m.std_conf_exp_dir,
        content_filter
    )

    for mod_content in mc.getItems(table).values():
        mod_keys = {
            key: mod_content.getAttr(key)
            for key in kwargs.keys()
        }
        if mod_keys == kwargs:
            try:
                # Effectively revert patch
                mod_content.insertIntoDB()
            except:
                pass  # Already there


class EnsureDefaultSettingsExist(object):
    """
    Revert eventual DELETED-Patch for default settings for public.
    """
    def run(self):
        revert_deleted_patch(
            "cs.taskmanager",
            "cs_tasks_user_view",
            cdb_object_id="4fb33321-9570-11e8-ba1d-68f7284ff046",
        )


pre = []
post = [EnsureDefaultSettingsExist]
