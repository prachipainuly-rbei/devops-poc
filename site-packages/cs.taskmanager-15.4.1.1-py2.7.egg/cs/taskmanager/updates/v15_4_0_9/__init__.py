# coding: utf-8
import json
from cdb import sqlapi
from cdb import transactions
from cdb.comparch import protocol
from cs.taskmanager import settings


class UpdateAppSettings(object):
    """
    settings have changed due to usage of standard component SplitterLayout:
    tableWidth and tableHeight are obsolete; layout is renamed to vertical
    """
    def _update_setting(self, persno):
        old = settings.AppSettings.read(persno=persno, use_cache=False)
        new = dict(settings.AppSettings.__fallback__)
        new["notificationInterval"] = old.get("notificationInterval",
                                              new["notificationInterval"])
        new["vertical"] = old.get("layout", "row") == "column"
        settings.AppSettings.write(new, persno=persno)
        protocol.logMessage(
            "updated settings for user '{}' from '{}' to '{}'".format(
                persno, old, new))

    def run(self):
        settings.AppSettings.create_default_settings()
        old = sqlapi.RecordSet2(
            sql="SELECT DISTINCT personalnummer FROM cdb_usr_setting "
                "WHERE setting_id='{}' AND setting_id2='{}'".format(
                    settings.AppSettings.__id1__,
                    settings.AppSettings.__id2__))

        with transactions.Transaction():
            for rec in old:
                self._update_setting(rec.personalnummer)


pre = []
post = [UpdateAppSettings]
