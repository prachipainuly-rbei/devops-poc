/*
 * Copyright (C) 1990 - 2018 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: helpers.js 185099 2018-10-16 06:51:55Z cso $"
 */

import moment from 'moment';
import * as constants from './constants';
import {formatStr} from './i18n';
import {getPlugin, getAppSetup} from 'cs-web-components-base';

const MESSAGE_NOW = 'now';
const MESSAGE_TOMORROW = 'tomorrow';
const MESSAGE_YESTERDAY = 'yesterday';

export const humanizeDuration = (duration) => {
    switch (duration.asDays()) {
        case 0:
            return formatStr(MESSAGE_NOW);
        case -1:
            return formatStr(MESSAGE_YESTERDAY);
        case 1:
            return formatStr(MESSAGE_TOMORROW);
        default:
            return duration.humanize(true);
    }
};

export const humanizeDays = (days) => {
    const duration = moment.duration(days, 'days');
    return humanizeDuration(duration);
};

// table rows and taskInfo objects currently hold @plugin_discriminators
export function getTaskPlugin(rowOrTaskInfo, name, fallback) {
    const discriminators = rowOrTaskInfo.get(constants.PLUGIN_DISCRIMINATORS);
    if (!discriminators) {
        return fallback;
    }
    return getPlugin(name, d => discriminators.includes(d), fallback);
}

export function prefixNS(name) {
    return `${componentNameSpace}-${name}`;
}

export function stopEvent(event) {
    event.preventDefault();
    event.stopPropagation();
}

export const detectIE = function() {
    const ua = window.navigator.userAgent;
    const msie = ua.indexOf('MSIE ');
    if (msie > 0) {
        // IE 10 or older => return version number
        return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
    }

    const trident = ua.indexOf('Trident/');
    if (trident > 0) {
        // IE 11 => return version number
        const rv = ua.indexOf('rv:');
        return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
    }

    const edge = ua.indexOf('Edge/');
    if (edge > 0) {
        // Edge (IE 12+) => return version number
        return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
    }

    // other browser
    return false;
};

// set user's date format as default
let MOMENT_SET_UP = false;

export const setupMoment = () => {
    if (!MOMENT_SET_UP) {
        moment.defaultFormat = getAppSetup().getIn(['formats', 'dateFormat']);
        MOMENT_SET_UP = true;
    }
};

export function getTaskIndex(tasks, task_object_id) {
    return tasks.findIndex(x => x.get('id') === task_object_id);
}

export const basePath = getAppSetup().getIn(['appSettings', 'basePath']);

/*
 * Returns a "debounced" function, which only calls "func" at most once in every "wait" milliseconds
 * (timer starts anew every time the debounced function is called).
 *
 * WARNING: Make sure to cancel debounced functions on componentWillUnmount of React components!
 */
export const debounce = function(func, wait) {
    let timeout, result;

    const later = function(...args) {
        timeout = null;
        result = func(...args);
    };

    const debounced = function(...args) {
        if (timeout) {
            clearTimeout(timeout);
        }

        timeout = setTimeout(function() {
            return later(...args);
        }, wait);

        return result;
    };

    debounced.cancel = function() {
        clearTimeout(timeout);
        timeout = null;
    };

    return debounced;
};

export function debugMode() {
    return window.appSetup.appSettings.debugMode === true;
}

export const getOwnState = state => state[prefixNS('reducer')];
