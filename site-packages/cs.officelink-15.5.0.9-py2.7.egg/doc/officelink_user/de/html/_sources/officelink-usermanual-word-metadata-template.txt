.. _`officelink-usermanual-word-metadata-template`:

Vorlagen zum Datenabgleich erstellen
####################################

Dieser Abschnitt beschreibt die Erstellung von Dokumentvorlagen mit System-
Variablen zum Datenabgleich.

- Abgleich von Dokumentmetadaten (z.B. Titel, Dokument-Nr. ...)
- Abgleich von 1:1 referenzierten Objekten (z.B. Projektname des zugeordneten Projekts)
- Übernahme von 1:N referenzierten Objekten (z.B. Liste mit Offenen Punkten)

.. _`officelink-usermanual-word-metadata-template-format`:

Formatbeschreibung für System-Variablen
=======================================

System-Variablen in Word Dokumenten haben folgendes Format:
cdb.<Mode>.<Beziehung>.<Attribut>.<Kardinalität>

:guilabel:`Mode`
   Der Mode gibt an, ob eine Variable aus dem System ausschließlich gelesen oder auch
   nach Änderung im Dokument im System aktualisiert werden darf. Gültige Werte
   für den Modus sind:

   - :guilabel:`r`

     Nur Datenübernahme aus dem System möglich. Der übernommene Wert kann im Dokument
     verändert werden, jedoch nicht an das System übergeben werden. Bei erneuter
     Datenübernahme wird der geänderte Wert im Dokument wieder durch den System-Wert ersetzt.
   
   - :guilabel:`w`

     Nur Datenübergabe in das System möglich. Durch diesen Modus kann sichergestellt
     werden, dass ein Dokumentfeld durch eine Datenübernahme nicht verändert werden kann,
     eine Aktualisierung im System aber möglich ist (sinnvoll bei Feldern, die durch
     das Dokument berechnet werden). Dieser Modus kann nicht bei 1:N Beziehungen
     verwendet werden.
   
   - :guilabel:`rw`

     Datenübernahme aus dem System und Aktualisierung im System nach Änderung im Dokument
     möglich. Dieser Modus kann nicht bei 1:N Beziehungen verwendet werden.
   
   - :guilabel:`*s`

     Wenn oben genannten Modewerten ein *s* hinzugefügt wird (d.h. *rs*, *ws* oder *rws*), dann
     gelten zwar die gleichen Regeln wie bei den jeweiligen beschriebenen Werten ohne *s*, jedoch
     laufen die Lese- bzw. Schreibeaktionen vollständig serverseitig ab. Dabei kann optional
     das Feld *Parameter* verwendet werden. U.U. bedarf es allerdings für die Verwendung der
     serverseitigen Bearbeitung von Variablen vorbereitend administratives Customizing, welches im
     OfficeLink Administrationshandbuch erläutert wird.

:guilabel:`Beziehung`
   Die Beziehung gibt ausgehend vom Dokument den Pfad zu den durch die Variable
   repräsentierten Daten im System an. Als Beziehung können folgende Ausdrücke
   verwendet werden:

   - :guilabel:`this`

     Der konstante Ausdruck 'this' wird verwendet, um Attribute des Dokuments
     selbst anzugeben.
   
   - :guilabel:`Name einer im System konfigurierten Beziehung`

     Über eine Beziehung können Attribute von referenzierten Objekten übernommen
     und abgeglichen werden.
   
   - :guilabel:`BY_ZNUM_ZIDX_FROM_<table_name>`

     Verwendung einer impliziten Beziehung über die Attribute z_nummer und z_index.
     Hierzu wird der Ausdruck BY_ZNUM_ZIDX_FROM_<table_name> angegeben.
     table_name gibt dabei die Datenbanktabelle an, aus der ein Objekt über z_nummer
     und z_index implizit referenziert wird. Die angegebene Datenbanktabelle
     muss die Attribute z_nummer und z_index enthalten und die Kombination
     aus z_nummer und z_index muss eindeutig sein.

:guilabel:`Attribut`
   Das Attribut spezifiziert ein Attribut eines durch die Beziehung referenzierten
   System-Objekts.

   Sachmerkmale als Attribute von Artikeln:

   Wird eine Artikelbeziehung als Beziehung angegeben, können auch die Sachmerkmale
   des Artikels als Attribut angegeben werden. Dies kann qualifiziert über die Merkmalkennung
   oder unqualifiziert mittels Zählnummer erfolgen:

   - :guilabel:`Sachmerkmale qualifiziert:`

     ``_SML_<mm_mk>``

     .. container:: example
   
        .. rubric:: Word: Datenabgleich - Sachmerkmale qualifiziert

        Sachmerkmal mit der Kennung 'L' des zugeordneten Artikels
        
        .. code-block:: none

            ``cdb.r.cdb_doc_to_part._SML_L``

   - :guilabel:`Sachmerkmale unqualifiziert:`

     ``_SMLN<nummer> für Merkmalskennungen``

     ``_SMLV<nummer> für Merkmalswerte``

     Merkmalkennung und der zugehörige Wert müssen dabei dieselbe Nummer haben.

     .. container:: example
   
        .. rubric:: Word: Datenabgleich - Sachmerkmale unqualifiziert

        Kennung und Wert des erstes Sachmerkmals des zugeordneten Artikels
        
        .. code-block:: none

            ``cdb.r.cdb_doc_to_part._SMLN1``
            ``cdb.r.cdb_doc_to_part._SMLV1``

   .. important::

      SML Attribute können nicht schreibend synchronisiert werden!

:guilabel:`Kardinalität`
   Gibt die Kardinalität der Beziehung an. Wenn keine Kardinalität angegeben wurde,
   wird von der Kardinalität 1 ausgegangen. Bei der Erstellung neuer Dokumentvorlagen
   sollte die Kardinalität explizit angegeben werden. Folgende Werte können für die
   Kardinalität verwendet werden:

   - :guilabel:`1`

     Für Beziehungen vom Typ ``this, BY_ZNUM_ZIDX_FROM_<table_name>``
     und für 1-stellige homogene Beziehungen.
   
   - :guilabel:`N`

     Für n-stellige homogene Beziehungen. Variablen, die n-stellige Beziehungen verwenden,
     müssen spaltenweise in der Kopfzeile einer Liste platziert werden (siehe Verwendung
     von System-Variablen im Dokument). Beim Abgleich mit dem System wird die Liste auf die zur
     Darstellung des Ergebnisses benötigte Anzahl Zeilen angepasst. Die erste Zeile nach
     der Kopfzeile dient dabei als Formatvorlage. Die Sortierung der Liste erfolgt anhand
     der ersten Spalte.

     .. container:: example
   
        .. rubric:: Word: Datenabgleich - System-Variablen

        Zeichnungsnummer des Dokuments:
        
        .. code-block:: none

            "cdb.r.this.z_nummer"
        
        Übernahme und Abgleich der Bemerkung des Dokuments:
        
        .. code-block:: none

            "cdb.rw.this.z_bemerkung"
        
        Übernahme der Artikelnummer des zugeordneten Artikels:
        
        .. code-block:: none

            "cdb.r.cdb_doc_to_part.teilenummer"
        
        Übernahme und Abgleich der Artikelbenennung des zugeordneten Artikels:
        
        .. code-block:: none

            "cdb.rw.cdb_doc_to_part.benennung"
        
        Übernahme der Begründung aus der Änderungshistorie mittels impliziter Beziehung:
        
        .. code-block:: none

            "cdb.r.BY_ZNUM_ZIDX_FROM_aenderung.begruend"

:guilabel:`Parameter`
   Über dieses Feld können bei der serverseitigen Bearbeitung von Variablen zusätzliche für die
   jeweilige Variable spezifische konstante Werte übergeben werden. Das können beispielsweise
   Identifikatoren sein, welche das Verlinken von Ergebnissen aus 1:N Beziehungen mit einzelnen
   Dokumentfeldern statt mit dynamischen Listen ermöglichen. Beispielsweise wird der folgenden
   Variable der Parameter *PRIMARY* hinzugefügt, welches einem zuvor speziell dafür bereitgestelltem
   Userexit übermittelt, dass man den Ursprungsnamen der Primärdatei des Dokuments haben möchte.

   .. code-block:: none

       cdb.rs.document2cdb_file.cdbf_original_name.N.string.PRIMARY

.. _`officelink-usermanual-word-metadata-template-definition`:

Definition von System-Variablen
===============================

Die Definition von System-Variablen erfolgt mit einem Assistenten, der über die Schaltfläche
:guilabel:`[ Verwalten ]` der OfficeLink-Symbolleiste aufgerufen wird. Damit die Schaltfläche 
verfügbar ist, muss sie zuvor in dem Einstellungsdialog aktiviert worden sein. Der Dialog 
bietet auf der linken Seite die Möglichkeit neue Variablen im System-Format anzulegen 
(siehe :ref:`officelink-usermanual-word-metadata-template-format` ). Auf der rechten 
Seite werden alle im Dokument enthaltenen System-Variablen angezeigt. Durch Markierung einer 
Variablen wird gleichzeitig das entsprechende Textfeld in dem Word Dokument markiert. Durch 
Betätigung der Schaltfläche :guilabel:`[ Variable löschen ]` kann die markierte 
Variable aus dem Dokument entfernt werden.

.. _`officelink-usermanual-word-metadata-template-definition-dialog`:

.. figure:: images/word2007_docvar_dialog.png
   :align: center

   Word: Datenabgleich - Dialog zur Erstellung von System-Variablen

- :guilabel:`Beziehung:`   

  Die Beziehung gibt ausgehend vom Dokument den Pfad zu einem Attribut eines oder 
  mehrerer referenzierter System-Objekte an. Der Katalog bietet alle im System 
  konfigurierten Dokumentenbeziehungen an, bei denen das Dokument das Startobjekt 
  darstellt. Für Attribute des Dokuments selbst, muss in diesem Feld 
  ``this`` eingetragen werden. 

  Zur Verwendung einer impliziten Beziehung, die über die Schlüsselattribute 
  Dokumentennummer und Index hergestellt wird, muss in diesem Feld 
  ``BY_ZNUM_ZIDX_FROM_`` ausgewählt werden und 
  im Feld Datenbanktabelle eine Relation als Datenquelle ausgewählt werden.

- :guilabel:`Datenbanktabelle:`   

  Eine Datenbanktabelle muss nur dann ausgewählt werden, wenn im Feld Beziehung 
  der spezielle Eintrag ``BY_ZNUM_ZIDX_FROM_`` für 
  implizite Beziehungen ausgewählt wurde. In der ausgewählten Relation muss die 
  Kombination der Attribute z_nummer und z_index eindeutig sein. 

- :guilabel:`Attribut:`   

  Das Attribut spezifiziert ein Attribut eines durch die Beziehung referenzierten 
  System-Objekts.

- :guilabel:`Abgleichmodus:`   

  Der Modus gibt an, ob eine Variable aus dem System ausschließlich gelesen oder auch 
  nach Änderung im Dokument im System aktualisiert werden darf:

  r: nur lesend

  w: nur schreibend

  rw: lesender und schreibender Zugriff im System

  rs: nur serverseitig lesend

  ws: nur serverseitig schreibend

  rws: serverseitig lesender und schreibender Zugriff im System

- :guilabel:`Parameter:`

  Optionaler nur für das serverseitige Bearbeiten von Variablen verwendeter Wert.

- :guilabel:`System Variable:`

  In diesem Feld wird der aus den anderen Feldern erzeugte Ausdruck für die zu 
  erstellenden System-Variable angezeigt. Das manuelle Ändern dieses Ausdrucks 
  ist nur zur Angabe von Sachmerkmalen bei Artikelbeziehungen erforderlich.

Beim Hinzufügen der Variablen durch Betätigung der Schaltfläche :guilabel:`[ Variable hinzufügen ]`
wird der in dem Feld System-Variable angezeigte Ausdruck überprüft 
und bei Ungültigkeit eine entsprechende Fehlermeldung angezeigt. Ansonsten wird die 
Variable als neue System-Variable in dem aktiven Dokument angelegt und mit dem Wert 
``<Attribut>`` als Platzhalter initialisiert. Die System-Variablen 
werden durch Felder vom Typ DocVariable repräsentiert und sind nach dem Einfügen 
frei im Dokument positionierbar.

.. _`officelink-usermanual-word-metadata-template-change`:

Ändern von System-Variablen
===========================

Die Änderung der Textfelder, welche System-Variablen beinhalten, erfolgt durch Mausklick in das zu
ändernde Feld. Der Cursor befindet sich dann innerhalb des Feldes und ermöglicht eine freie Bearbeitung.
Dieser Mechanismus funktioniert nur dann, wenn das Feld aus mindestens zwei Zeichen besteht.
Besteht das Feld aus nur einem Zeichen, ist ein Mausklick in das Feld und eine direkte Bearbeitung
nicht mehr möglich. Zu diesem Zweck enthält die OfficeLink-Symbolleiste in Word das zusätzliche
Buttonuntermenü :guilabel:`[ Dokumentvariablenwert ändern ]`, welches einen speziellen Dialog zum
Ändern des Wertes öffnet.

.. _`officelink-usermanual-word-metadata-template-usage`:

Verwendung von System-Variablen im Dokument
===========================================

System-Variablen sollten im Dokument für den Anwender kenntlich gemacht werden, 
um versehentliches Löschen oder Überschreiben zu vermeiden. Der Schutz von 
Dokumentenvariablen ist nur bedingt möglich. Eine Möglichkeit ist die Erstellung 
von Formularen.

.. note:: 

   Beim Datenabgleich von Variablen in das System werden Attributänderungen auch dann 
   vorgeblendet, wenn das Feld laut Maskenkonfiguration durch den Anwender nicht 
   interaktiv änderbar oder nur via Katalogauswahl änderbar wäre. Bei der Verwendung 
   von System-Variablen mit schreibenden Zugriff ist dies zu berücksichtigen. Gegebenenfalls 
   ist die Gültigkeit der Werte durch eine entsprechende Prüfung im User Exit abzusichern.

System-Variablen, die n-stellige Beziehungen verwenden, müssen unter Word spaltenweise 
in der Kopfzeile einer Tabelle platziert werden. Beim Abgleich mit dem System wird die Tabelle auf 
die zur Darstellung des Ergebnisses benötigte Anzahl Zeilen angepasst. Die erste Zeile 
nach der Kopfzeile dient dabei als Formatvorlage.

.. important::

   Falls n-stellige Beziehungen in der Kopf- oder Fußzeile eines Dokuments eingebaut werden,
   und dann anschließend die Kopfzeilen in sprechende Texte geändert werden (z.B. von
   "<z_nummer>" in "Document number"), müssen diese Kopfzeilen unbedingt per CTRL+F11 gesperrt
   werden. Falls man diese Felder nicht sperrt, werden die sprechenden Text aufgrund einer
   Eigenart in Word bei einer späteren PDF Konvertierung in ihre ursprünglichen Platzhalternamen
   geändert (z.B. zurück von "Document number" auf "<z_nummer>"). Bei Bedarf kann die Sperre
   per CTRL+SHIFT+F11 aufgehoben werden.

.. rubric:: Tabellen in Microsoft Office Word für n-stellige Beziehungen:

#. Tabelle mit zwei Zeilen und der gewünschten Anzahl Spalten einfügen
#. Spaltentitel in die erste Zeile eintragen und wie gewünscht formatieren
#. Als Spaltentitel die System-Variablen mit dem Assistenten einfügen   (siehe :ref:`officelink-usermanual-word-metadata-template-definition` ).
   Alle Variablen müssen dabei dieselbe Beziehung verwenden und von der Kardinalität 
   N sein.

   .. _`officelink-usermanual-word-metadata-template-usage-list-empty-1`:

   .. figure:: images/word2007_docvar_list_empty_1.png
      :align: center
   
      Word: Datenabgleich - Tabelle für n-stellige Beziehungen [leer] (1)

#. System Variablen umbenennen, damit deren Attribute nicht mehr sichtbar sind.

   .. important:: 

      Beim Ändern der Variable darf diese vorher nicht komplett selektiert werden, da dadurch die
      Variable gelöscht wird. Siehe dazu Bemerkung im Abschnitt "Ändern von System-Variablen".

   .. _`officelink-usermanual-word-metadata-template-usage-list-empty-2`:

   .. figure:: images/word2007_docvar_list_empty_2.png
      :align: center

      Word: Datenabgleich - Tabelle für n-stellige Beziehungen [leer] (2)

#. Zweite Zeile formatieren. Diese Zeile dient als Kopiervorlage zum Einfügen weiterer Zeilen beim Datenabgleich.
#. Über den Tabelleneigenschaftendialog einmaligen Titel für die Tabelle definieren. Dies ist nötig,
   falls in einem Dokument die gleichen Variablen in mehrere Tabellen gleichzeitig ausgeleitet
   werden sollen, oder falls die Tabelle über eine Seite hinaus in die nächste Seite wachsen könnte.

Bei Durchführung einer Datenübernahme wird die Tabelle auf die benötigte Anzahl 
Zeilen expandiert und mit der Ergebnismenge der verwendeten Beziehung gefüllt.

.. _`officelink-usermanual-word-metadata-template-usage-list-filled`:

.. figure:: images/word2007_docvar_list_filled.png
   :align: center

   Word: Datenabgleich - Tabelle für n-stellige Beziehungen [gefüllt]

Felder-Formatierung
-------------------

Insbesondere bei Datumswerten ist es zuweilen wünschenswert, dass die Werte der abgeglichenen Felder
in einem bestimmten Format dargestellt werden. Dies erreichen Sie durch folgende Schritte:

#. Drücken Sie ALT+F9 um die Feldfunktionen statt deren Ergebnisse anzuzeigen
#. Ersetzen Sie den String :emphasis:`* MERGEFORMAT` mit der gewünschten Formatierungsformel
   (z.B. :emphasis:`@ "dd.MM.yyyy"`)
#. Drücken Sie erneut ALT+F9 um wieder Ergebnisse statt Feldfunktionen anzuzeigen

.. _`officelink-usermanual-word-metadata-template-autoupdate`:

Automatisches Aktualisieren von Metadaten
=========================================

Die Metadaten aller System-Variablen mit lesendem Zugriff werden beim Laden eines Dokuments aus CDB automatisch übernommen.
Die Bedingungen dafür sind, dass das Dokument:

#. im Client im "Bearbeiten" Modus geöffnet wurde (oder direkt aus Office heraus über "Laden")
#. eine "Zeichnung" ist (d.h. die Eigenschaft "vorlage_kz" hat)
#. keine Vorlage ist (d.h. "vorlage_kz=0")
