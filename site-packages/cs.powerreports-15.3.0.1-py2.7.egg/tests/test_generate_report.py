#!/usr/bin/env python
# -*- python -*- coding: UTF-8 -*-
#
# Copyright (C) 2017 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/

import os

from cdb import CADDOK, testcase
from cdb.objects.org import Person

from cs.tools import powerreports


def test_generate_report():
    print "Generating report..",
    try:
        from cs import powerreports_fixture  # require demo data
    except ImportError:
        print "SKIPPED"
        return
    testcase.run_level_setup()

    ctx = MockedContext()
    ctx.objects = Person.Query()
    report_tmpl = {"name": "TestReportPersons",
                   "iso_code": "de",
                   "report_title": "TestReportPersons"}
    old_client = powerreports.client
    powerreports.client = lambda: None
    powerreports.client.viewDir = CADDOK.TMPDIR
    powerreports_fixture.PersonWithPowerReports.generate_report(
        report_tmpl, ctx, rep_exec_type="Client")
    powerreports.client = old_client
    print "OK"


class MockedContext(object):

    def __init__(self):
        self.dialog = lambda: None
        self.dialog.get_attribute_names = lambda: []

    def file(self, fname):
        assert os.stat(fname).st_size != 0, "Template file is empty"
        os.remove(fname)

    def upload_to_client(self, srv_filename, client_filename=None, delete_file_after_upload=1):
        assert os.stat(srv_filename).st_size != 0, "XML zip file is empty"
        os.remove(srv_filename)
