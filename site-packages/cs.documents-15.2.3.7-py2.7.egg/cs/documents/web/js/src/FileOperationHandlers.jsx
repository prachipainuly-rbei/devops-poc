/*
 * Copyright (C) 2017 CONTACT Software GmbH
 * All rights reserved.
 * http://www.contact-software.com
 *
 * Revision "$Id: FileOperationHandlers.jsx 175631 2018-04-09 10:44:36Z cla $"
 */

import React from 'react';
import Immutable from 'immutable';
import {PropTypes, ImmutablePropTypes} from 'cs-web-components-externals';
import {
    FileDropzone, ClassViewRaw, OperationModalRaw, WithOperationHandler, Form
} from 'cs-web-components-base';
import {prefixNS} from './helpers';
import {formatStr} from './i18n';

export const FILES_PARAM = 'cs-documents-web:files';

let uiExtensionCounter = 0;

class WithFiles extends React.Component {
    constructor(props) {
        super(props);
        this.addFiles = this.addFiles.bind(this);
        this.removeFile = this.removeFile.bind(this);
    }

    removeFile(file) {
        this.props.removeFiles(Immutable.List([file]));
    }

    addFiles(files) {
        this.props.addFiles(files);
    }

    render() {
        const files = this.props.operationState.get('files', Immutable.List());
        return this.props.children(
            <FileDropzone
                key={prefixNS(`WithFiles-${++uiExtensionCounter}`)}
                className={prefixNS('WithFiles')}
                onDrop={this.addFiles}
            >
                <FileDropzone.Preview
                    files={files}
                    onDelete={this.removeFile} />
                <div className={prefixNS('form-upload-placeholder')}>
                    {formatStr('dropzone_modify_label')}
                </div>
            </FileDropzone>
        );
    }
}

WithFiles.propTypes = {
    operationState: ImmutablePropTypes.map.isRequired,
    addFiles: PropTypes.func.isRequired,
    removeFiles: PropTypes.func.isRequired,
};

// Default OperationHandlers from cs-web-components-base extended WithFiles

export const ClassViewWithFiles = WithOperationHandler(
    Form.applyExtension(ClassViewRaw, WithFiles),
    'editor'
);

export const OperationModalWithFiles = WithOperationHandler(
    Form.applyExtension(OperationModalRaw, WithFiles),
    'modal'
);

export const FormWithFiles = WithOperationHandler(
    Form.applyExtension(Form.Form, WithFiles),
    'editor'
);
