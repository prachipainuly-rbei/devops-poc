# -*- mode: python; coding: utf-8 -*-
#
# Copyright (C) 1990 - 2016 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/

__docformat__ = "restructuredtext en"
__revision__ = "$Id: __init__.py 184441 2018-09-26 12:52:35Z cso $"

import os
import sys
from cdb import ue
from cdb import rte
from cdb import sig
from cdb.platform.mom.fields import DDField
from cs.platform.web import static
from cs.taskmanager.mixin import WithTasksIntegration

FILE = __file__.decode(sys.getfilesystemencoding())
PLUGIN = "cs-tasks-issue-plugin"
VERSION = "15.1.0"
APPDIR = os.path.dirname(FILE)

from cs.taskmanager.web import constants


class IssueWithCsTasks(WithTasksIntegration):
    __cs_tasks_name_attr__ = "issue_name"

    def getCsTasksContexts(self):
        return [self.Project]

    def csTasksDelegate_get_default(self):
        return self.csTasksDelegate_get_project_manager()

    def csTasksDelegate(self, ctx):
        prj_id = None
        for obj in ctx.objects:
            if not prj_id:
                prj_id = obj[u"cdb_project_id"]
            if prj_id and prj_id != obj[u"cdb_project_id"]:
                raise ue.Exception(u"cdbpcs_delegate")
        self.Super(IssueWithCsTasks).csTasksDelegate(ctx)

    def preset_csTasksDelegate(self, ctx):
        prj_id = None
        for obj in ctx.objects:
            if not prj_id:
                prj_id = obj[u"cdb_project_id"]
            if prj_id and prj_id != obj[u"cdb_project_id"]:
                raise ue.Exception(u"cdbpcs_delegate")
        ctx.set("cdb_project_id", prj_id)
        self.Super(IssueWithCsTasks).preset_csTasksDelegate(ctx)

    def getCsTasksBasePriority(self, request=None):
        if self.priority == "hoch":
            return constants.PRIO_MEDIUM
        if self.priority == "kritisch":
            return constants.PRIO_HIGH
        return constants.PRIO_LOW

    def getProceedAttributes(self, status):
        if status == 70:  # waiting for ...
            waiting_for = DDField.ByKeys("cdbpcs_issue", "waiting_for")
            reason = DDField.ByKeys("cdbpcs_issue", "reason")
            return {
                "waiting_for_persno": {
                    "mandatory": True,
                    "label": "{} (ID)".format(waiting_for.getLabel()),
                },
                "waiting_for_name": {
                    "mandatory": True,
                    "label": waiting_for.getLabel(),
                },
                "waiting_reason": {
                    "mandatory": True,
                    "label": reason.getLabel(),
                },
            }
        else:
            return {}


@sig.connect(rte.APPLICATIONS_LOADED_HOOK)
def _register_libraries():
    lib = static.Library(
        PLUGIN,
        VERSION,
        os.path.join(APPDIR, 'js', 'build'))
    lib.add_file("{}.js".format(PLUGIN))
    lib.add_file("{}.js.map".format(PLUGIN))
    static.Registry().add(lib)
