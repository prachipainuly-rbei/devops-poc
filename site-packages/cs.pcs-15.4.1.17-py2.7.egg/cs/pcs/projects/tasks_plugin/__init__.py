# -*- mode: python; coding: utf-8 -*-
#
# Copyright (C) 1990 - 2016 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/

__docformat__ = "restructuredtext en"
__revision__ = "$Id: __init__.py 180928 2018-07-23 15:16:01Z cso $"

import os
import sys
from cdb import ue
from cdb import rte
from cdb import sig
from cs.platform.web import static
from cs.taskmanager import settings
from cs.taskmanager.mixin import WithTasksIntegration

FILE = __file__.decode(sys.getfilesystemencoding())
PLUGIN = "cs-tasks-pcs-task-plugin"
VERSION = "15.1.0"
APPDIR = os.path.dirname(FILE)


class TaskWithCsTasks(WithTasksIntegration):
    def getCsTasksContexts(self):
        return [self.Project]

    def csTasksDelegate_get_default(self):
        return self.csTasksDelegate_get_project_manager()

    def csTasksDelegate(self, ctx):
        prj_id = None
        for obj in ctx.objects:
            if not prj_id:
                prj_id = obj[u"cdb_project_id"]
            if prj_id and prj_id != obj[u"cdb_project_id"]:
                raise ue.Exception(u"cdbpcs_delegate")
        self.Super(TaskWithCsTasks).csTasksDelegate(ctx)

    def preset_csTasksDelegate(self, ctx):
        prj_id = None
        for obj in ctx.objects:
            if not prj_id:
                prj_id = obj[u"cdb_project_id"]
            if prj_id and prj_id != obj[u"cdb_project_id"]:
                raise ue.Exception(u"cdbpcs_delegate")
        ctx.set("cdb_project_id", prj_id)
        self.Super(TaskWithCsTasks).preset_csTasksDelegate(ctx)


@sig.connect(settings.REGISTER_TABLE_SETTINGS)
def register_table_settings(register_file):
    register_file(os.path.join(APPDIR, "table_settings.json"))


@sig.connect(rte.APPLICATIONS_LOADED_HOOK)
def _register_libraries():
    lib = static.Library(
        PLUGIN,
        VERSION,
        os.path.join(APPDIR, 'js', 'build'))
    lib.add_file("{}.js".format(PLUGIN))
    lib.add_file("{}.js.map".format(PLUGIN))
    static.Registry().add(lib)
