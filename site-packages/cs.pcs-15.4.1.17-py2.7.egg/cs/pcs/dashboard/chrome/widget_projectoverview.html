<!--! Project overview widget
============================= -->
<metal:widget define-macro="block_widget"
              tal:define="macrofile getattr(plugin, '__plugin_macro_file__', 'macros.html');
                          pluginmacros plugin.getTemplate(macrofile).macros;
                          kosmodromtools kosmodromtools|plugin.kosmodromtools">
<article>
  <a class="project-anchor" name="${project.cdb_project_id}"></a>
  <div class="projecttiles"
       data-elink-cdb_project_id="${project.cdb_project_id}">
    <tal:layout
        metal:use-macro="global_plugins['collapsible_blocks'].macros['block_container']">
      <metal:filltitle fill-slot="block_title">
        <h2>
          <metal:projtitle use-macro="pluginmacros.block_widget_title" />
        </h2>
      </metal:filltitle>
      <metal:menu fill-slot="dropdown_menu"
                  use-macro="pluginmacros.widget_dropdown" />
      <metal:cnt fill-slot="block_content"
                 use-macro="pluginmacros.widget_content">
      </metal:cnt>
    </tal:layout>
  </div>
</article>
</metal:widget>

<metal:widget define-macro="collapsible_widget"
              tal:define="macrofile getattr(plugin, '__plugin_macro_file__', 'macros.html');
                          pluginmacros plugin.getTemplate(macrofile).macros;
                          kosmodromtools kosmodromtools|plugin.kosmodromtools">
  <tal:layout
    metal:use-macro="global_plugins['collapsible_blocks'].macros['collapsible_block_container']"
    define="block_id string:detail_overview;
            block_order detail_widget_order;
            block_expanded widget_expanded">
    <metal:filltitle fill-slot="block_title">
      <h2><metal:title use-macro="pluginmacros.widget_title" /></h2>
    </metal:filltitle>
    <metal:cnt fill-slot="block_content"
               use-macro="pluginmacros.widget_content">
  </tal:layout>
</metal:widget>

<metal:widget_title define-macro="block_widget_title">
  <tal:dummy define="project_title project.GetDescription()">
		<a href="${options.base_uri + kosmodromtools.get_detail_url(project)}"
		   target="${options.default_link_target}" title="${project_title}">
		  ${project_title}</a>
  </tal:dummy>
</metal:widget_title>

<metal:widget_dropdown define-macro="widget_dropdown">
  <metal:menu use-macro="global_plugins['components'].macros.operations_dropdown_menu"
              tal:define="oplist options.operations.get_object_operations_for_context(project)">
  </metal:menu>
</metal:widget_dropdown>

<metal:widget_title define-macro="widget_title">
<i class="cdb-icon-project-overview"></i><img src="${project.GetObjectIcon()}" tal:condition="nothing"/>
${options.labels.cdbpcs_elink_project_overview}
</metal:widget_title>

<metal:widget_content define-macro="widget_content">
<div class="kosmodrom-project-overview-widget">
  <div class="project-preview">
      <tal:previewImage metal:use-macro="global_plugins['picture_uploader'].macros['preview_image']"
                        define="prev_img kosmodromtools.get_preview_img(project);
                                img_link options.base_uri + kosmodromtools.get_detail_url(project)"/>
  </div>
  <div class="project-info"
       tal:define="pstate project.get_manual_light();
                   todayinfo project.get_time_completion()">
    <div class="project-state state${pstate}"></div>
    <div class="info-list">
      <ul class="unstyled">
        <tal:showlink define="widget plugin.get_widget_links('task')" condition="widget">
          <li tal:define="cntall widget.get_count(project.cdb_project_id, ['filter_overdue']);
                          cntmine widget.get_count(project.cdb_project_id, ['filter_overdue', 'filter_mine'])">
            <span class="badge badge-info">${'%s %s' % (cntmine, options.labels['cdbpcs_elink_own']) if cntmine else ''}</span>
            <a class="project-list-link"
               data-elink-kosmodrom-detail-widget="task"
               data-elink-kosmodrom-detail-filters="filter_overdue">
            <span class="info-label">${options.labels['cdbpcs_elink_overdue_tasks']}</span>&nbsp;
            <img src="${widget.get_icon()}"/>
            <strong>${cntall}</strong>&nbsp;&nbsp;</a>
          </li>
        </tal:showlink>
        <tal:showlink define="widget plugin.get_widget_links('issue')" condition="widget">
          <li tal:define="cntall widget.get_count(project.cdb_project_id, []);
                          cntmine widget.get_count(project.cdb_project_id, ['filter_mine'])">
            <span class="badge badge-info">${'%s %s' % (cntmine, options.labels['cdbpcs_elink_own']) if cntmine else ''}</span>
            <a class="project-list-link"
               data-elink-kosmodrom-detail-widget="issue"
               data-elink-kosmodrom-detail-filters="">
            <span class="info-label">${options.labels['cdbpcs_elink_active_issues']}</span>&nbsp;
            <img src="${widget.get_icon()}"/>
            <strong>${cntall}</strong>&nbsp;&nbsp;</a>
          </li>
        </tal:showlink>
        <tal:showlink define="widget plugin.get_widget_links('document')" condition="widget">
          <li tal:define="cntall widget.get_count(project.cdb_project_id, ['filter_recently_created']);
                          cntmine widget.get_count(project.cdb_project_id, ['filter_recently_created', 'filter_mine'])">
            <span class="badge badge-info">${'%s %s' % (cntmine, options.labels['cdbpcs_elink_own']) if cntmine else ''}</span>
            <a class="project-list-link"
               data-elink-kosmodrom-detail-widget="document"
               data-elink-kosmodrom-detail-filters="filter_recently_created,filter_categ_document">
            <span class="info-label">${options.labels['cdbpcs_elink_new_documents']}</span>&nbsp;
            <img src="${widget.get_icon()}"/>
            <strong>${cntall}</strong>&nbsp;&nbsp;</a>
          </li>
        </tal:showlink>
        <tal:showlink define="widget plugin.get_widget_links('item')" condition="widget">
          <li tal:define="cntall widget.get_count(project.cdb_project_id, ['filter_recently_created']);
                          cntmine 0">
            <span class="badge badge-info">${'%s %s' % (cntmine, options.labels['cdbpcs_elink_own']) if cntmine else ''}</span>
            <a class="project-list-link"
               data-elink-kosmodrom-detail-widget="item"
               data-elink-kosmodrom-detail-filters="filter_recently_created">
            <span class="info-label">${options.labels['cdbpcs_elink_new_parts']}</span>&nbsp;
            <img src="${widget.get_icon()}"/>
            <strong>${cntall}</strong>&nbsp;&nbsp;</a>
          </li>
        </tal:showlink>
      </ul>
    </div>
    <div class="timeline"
         tal:define="ticks [];
          		     mstones kosmodromtools.get_milestones(project, todayinfo[0], todayinfo[1])">
      <div class="timeline-x">
        <div class="timeline-tooltips">
          <tal:ticks repeat="mstone mstones">
            <div class="milestone-tooltip-container-${mstone[3]}">
              <span class="milestone-tooltip"
                    title="${mstone[0].task_name}"
                    tal:condition="(mstone[3]>0)">${mstone[0].task_name}</span>
            </div>
          </tal:ticks>
        </div>
        <div class="timeline-tooltips-lines">
          <tal:ticks repeat="mstone [mst for mst in mstones if mst[3] > 0]">
            <div style="width: ${mstone[1]-25}%; right: ${100-mstone[1]}%;"
                 class="lineleft left"
                 tal:condition="(mstone[3]==1) and (mstone[1]>25)"></div>
            <div style="width: ${25-mstone[1]}%; left: ${mstone[1]}%;"
                 class="lineleft right"
                 tal:condition="(mstone[3]==1) and (mstone[1]<=25)"></div>
            <div style="width: ${75-mstone[1]}%; left: ${mstone[1]}%;"
                 class="lineright right"
                 tal:condition="(mstone[3]==2) and (mstone[1]<75)"></div>
            <div style="width: ${mstone[1]-75}%; right: ${100-mstone[1]}%;"
                 class="lineright left"
             	 tal:condition="(mstone[3]==2) and (mstone[1]>=75)"></div>
          </tal:ticks>
        </div>
        <div class="timeline-grid">
          <tal:ticks repeat="tick ticks">
            <div class="timeline-tick" style="left:${tick}%;"></div>
          </tal:ticks>
          <tal:todaydef
            define="today kosmodromtools.get_today_position(todayinfo[0], todayinfo[1])">
            <div class="today-marker-container">
              <span class="today-marker" style="left:${today}%"></span>
            </div>
          </tal:todaydef>
          <tal:progdef>
            <div class="project-progress" style="width:${project.percent_complet}%"></div>
          </tal:progdef>
        </div>
        <div class="timeline-points">
          <tal:ticks repeat="mstone mstones">
            <div
              class="timeline-milestone with-tooltip ms-${mstone[2]} ms-tool-${mstone[3]}"
              style="left: ${mstone[1]}%;" rel="popover"
              id="${mstone[0].cdb_object_id}"
              data-placement="top" data-html="true"
              data-original-title="<a class='close' data-dismiss='popover'>&times;</a>
                                   ${mstone[0].task_name}"
              data-content="<small class='muted'>${plugin.get_milestone_label(mstone[0], 'subject_id')}: </small><span>${mstone[0].subject_id}</span><br />
                            <small class='muted'>${plugin.get_milestone_label(mstone[0], 'end_time_fcast')}: </small><span>${mstone[0].getEndTime()}</span><br />
                            <small class='muted'>${plugin.get_milestone_label(mstone[0], 'joined_status_name')}: </small><span>${mstone[0].joined_status_name}</span>"
              tal:condition="(mstone[3]>=1)"></div>
            <div
              class="timeline-milestone ms-${mstone[2]} ms-tool-${mstone[3]}"
              style="left: ${mstone[1]}%;" rel="popover"
              data-placement="top" data-html="true"
              data-original-title="<a class='close' data-dismiss='popover'>&times;</a>
                                   ${mstone[0].task_name}"
              data-content="<small class='muted'>${plugin.get_milestone_label(mstone[0], 'subject_id')}: </small><span>${mstone[0].subject_id}</span><br />
                            <small class='muted'>${plugin.get_milestone_label(mstone[0], 'end_time_fcast')}: </small><span>${mstone[0].getEndTime()}</span><br />
                            <small class='muted'>${plugin.get_milestone_label(mstone[0], 'joined_status_name')}: </small><span>${mstone[0].joined_status_name}</span>"
              tal:condition="(mstone[3]==0)"></div>
          </tal:ticks>
        </div>
      </div>
    </div>
    <div class="time-plan">
      <small class="pull-left">${kosmodromtools.date_to_str(todayinfo[0])}</small>
      <small>${options.labels.cdbpcs_elink_total_duration % todayinfo[4]}</small>
      <small class="pull-right">${kosmodromtools.date_to_str(todayinfo[1])}</small>
    </div>
  </div>
</div>
</metal:widget_content>
