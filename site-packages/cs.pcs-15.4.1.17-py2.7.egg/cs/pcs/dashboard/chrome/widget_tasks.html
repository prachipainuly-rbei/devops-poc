<metal:widget define-macro="collapsible_widget"
              tal:define="macrofile getattr(plugin, '__plugin_macro_file__', 'macros.html');
                          pluginmacros plugin.getTemplate(macrofile).macros;
                          kosmodromtools kosmodromtools|plugin.kosmodromtools;
                          dashboard_widget plugin.dashboard_widget">
  <tal:layout
    metal:use-macro="global_plugins['collapsible_blocks'].macros['collapsible_block_container']"
    define="block_id string:detail_tasks;
            block_order detail_widget_order;
            block_expanded widget_expanded;
            widget_data dashboard_widget.get_data(project.cdb_project_id)['widget_data']">
    <metal:filltitle fill-slot="block_title">
      <h2><metal:title use-macro="pluginmacros.widget_title" /></h2>
    </metal:filltitle>
    <metal:menu fill-slot="dropdown_menu"
                use-macro="pluginmacros.widget_dropdown" />
    <metal:content fill-slot="block_content">
      <metal:using use-macro="pluginmacros.widget_filters" />
      <metal:using use-macro="pluginmacros.widget_content" />
    </metal:content>
  </tal:layout>
</metal:widget>

<metal:title define-macro="widget_title">
<i class="cdb-icon-task"></i><img src="${widget_data['widget_icon']}" tal:condition="nothing" />
${options.labels.cdbpcs_elink_active_tasks}&nbsp;(${options.labels.cdbpcs_elink_filtered_count % widget_data['filtered_counter']})
</metal:title>

<metal:dropdown define-macro="widget_dropdown">
    <metal:menu use-macro="global_plugins['components'].macros.operations_dropdown_menu"
                tal:define="opnames ['CDB_Search'];
                            oplist options.operations.get_class_operations(opnames, 'cdbpcs_task', cdb_project_id=project.cdb_project_id)" />
</metal:dropdown>

<metal:filters define-macro="widget_filters">
<div class="kosmodrom-detail-filters" data-elink-kosmodrom-detail-target="filters">
  <div class="btn-group pull-left" data-toggle="buttons-checkbox">
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
               tal:define="filtername 'filter_mine';
                           cnt widget_data['all_counters'][filtername]|0;
                           filtertitle options.labels.cdbpcs_elink_my_tasks">
      <metal:cnt fill-slot="filter_content">
      <img src="${options.getIcon('cdb_person')}" />&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
  </div>
  <div class="btn-group pull-left" data-toggle="buttons-checkbox">
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
            tal:define="filtername 'filter_overdue';
                        cnt widget_data['all_counters'][filtername]|0;
                        filtertitle options.labels.cdbpcs_elink_filter_overdue">
      <metal:cnt fill-slot="filter_content">
      ${options.labels.cdbpcs_elink_filter_overdue}&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
            tal:define="filtername 'filter_today';
                        cnt widget_data['all_counters'][filtername]|0;
                        filtertitle options.labels.cdbpcs_elink_tooltip_today">
      <metal:cnt fill-slot="filter_content">
      ${options.labels.cdbpcs_elink_today}&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
            tal:define="filtername 'filter_tomorrow';
                        cnt widget_data['all_counters'][filtername]|0;
                        filtertitle options.labels.cdbpcs_elink_tooltip_tomorrow">
      <metal:cnt fill-slot="filter_content">
      ${options.labels.cdbpcs_elink_tomorrow}&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
            tal:define="filtername 'filter_later';
                        cnt widget_data['all_counters'][filtername]|0;
                        filtertitle options.labels.cdbpcs_elink_tooltip_later % dashboard_widget.get_later_days()">
      <metal:cnt fill-slot="filter_content">
      ${options.labels.cdbpcs_elink_later}&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
  </div>
  <div class="btn-group pull-left" data-toggle="buttons-checkbox">
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
            tal:define="filtername 'filter_not_begun';
                        cnt widget_data['all_counters'][filtername]|0;
                        filtertitle options.labels.cdbpcs_elink_tooltip_not_begun">
      <metal:cnt fill-slot="filter_content">
      ${options.labels.cdbpcs_elink_not_begun}&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
  </div>
  <div class="btn-group pull-left" data-toggle="buttons-checkbox">
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
               tal:define="filtername 'filter_categ_task_group';
                           cnt widget_data['all_counters'][filtername]|0;
                           filtertitle options.labels.cdbpcs_elink_tooltip_task_groups">
      <metal:cnt fill-slot="filter_content">
      <img src="${options.getIcon('cdbpcs_task_object', milestone=0, is_group=1)}" />&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
               tal:define="filtername 'filter_categ_task';
                           cnt widget_data['all_counters'][filtername]|0;
                           filtertitle options.labels.cdbpcs_elink_tooltip_single_tasks">
      <metal:cnt fill-slot="filter_content">
      <img src="${options.getIcon('cdbpcs_task_object', milestone=0, is_group=0)}" />&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
    <metal:btn use-macro="kosmodromtools.templates()['layout.html'].macros.filter_button"
               tal:define="filtername 'filter_categ_milestone';
                           cnt widget_data['all_counters'][filtername]|0;
                           filtertitle options.labels.cdbpcs_elink_tooltip_milestones">
      <metal:cnt fill-slot="filter_content">
      <img src="${options.getIcon('cdbpcs_task_object', milestone=1, is_group=0)}" />&nbsp;(${cnt})
      </metal:cnt>
    </metal:btn>
  </div>
  <div class="no-float"></div>
</div>
</metal:filters>

<metal:widgetcontent define-macro="widget_content">
<div id="projectdetail-tasks" class="kosmodrom-detail-object-list"
     data-elink-kosmodrom-detail-widget="task">
  <tal:objs tal:repeat="obj widget_data['objects']">
    <metal:show use-macro="kosmodromtools.templates()['layout.html'].macros['object_info']"
                tal:define="responsible_label options.labels.cdbpcs_elink_responsible;
                            responsible_name obj.getSubjectName();
                            deadline_field 'end_time_fcast'" />
  </tal:objs>
  <metal:pg use-macro="global_plugins['pagination'].macros.paginator"
            tal:define="paginator widget_data['paginator']"/></div>
</metal:widgetcontent>
