var bPageModified = true;
var bPageRefresh = false;
var showModal = false;
var rulesEntries = new Array();

function replaceUnderscore(idflag) {
  var str = idflag.replace("_","-");
  return str.replace("_","-");
}

function tm(timestamp) {
    var d = new Date(timestamp);
    var day = (d.getDate() < 10) ? ('0'+d.getDate()) : d.getDate();
    var month = ((d.getMonth()+1) < 10) ? ('0'+(d.getMonth()+1)) : (d.getMonth()+1);
    var year = d.getFullYear()
    return day + '.' + month + '.' + d.getFullYear();
}


function changeClass(elem, from, to) {
  var classes = elem.attr('class').split(/\s+/);

  if(classes[0] == from) {
    elem.toggleClass(to);
  }
  else {
    elem.toggleClass(from);
  }
}

function setPageModified(bEnabled) {
  if (bPageModified != bEnabled) {
    try {
      window.external.cdbEFSetModifiedFlag(bEnabled);
    }
    catch(e) {}
    bPageModified = bEnabled;
  }
  setPageRefresh(!bEnabled);
}

function setPageRefresh(bEnabled) {
  // Auto. REFRESH?
  if (bPageRefresh != bEnabled) {
    try {
      window.external.cdbEFEnableNotifyChanges(bEnabled);
    }
    catch(e) {}
    bPageRefresh = bEnabled;
  }
}
//Default: enable auto refresh; not modified
//setPageRefresh(true);
setPageModified(false);

function enableBtnGroup(input) {
  if(input.toString().indexOf("input#project_name__") != 0) {
      $($(input).parent().parent().parent()).children("td.h__buttons").find("div").children().attr("disabled", !"disabled");
    }
}

function showDropDown(ctlToShowDropDown) {
  if(ctlToShowDropDown.toString().indexOf("input#project_name__") != 0) {
    $($(ctlToShowDropDown).parent().parent().parent()).children("td.h__buttons").find("div").children().attr("disabled", !"disabled");
  }
  showModal = true;
  ctlToShowDropDown.focus();
  ctlToShowDropDown.openDropDown(true);
}

function acFormatItem1(row) {
  if (row[0]!=""){
    return $("<div/>").text(row[0]).html();
  }
  else {
    return "-";
  }
}

function acFormatItem2(row) {
  if (row[0]!=""){
    return $("<div/>").text("["+row[1]+"] "+row[0]).html();
  }
  else {
    return "-";
  }
}

function acFormatResult1(row) {
  if (row[0]!="-" && row[0]!=""){
    return !this.extraParams || !this.extraParams.by_name || parseInt(this.extraParams.by_name, 10) ? row[0] : row[1];
  }else {
    return false;
  }
}

function mustFillField(fld) {
  var txt = $("input#text_info_not_compl").val();
  txt = txt + "\n";
  txt = txt + "  " + $("th.h__"+fld).text();
  var viewdiv = $("#error_modal");
  $("#error_modal_container", viewdiv).html(txt);
  viewdiv.modal("show");
}

function validateTSFields(idflag, showmsg) {
  var checkfields = ["cdb_project_id", "task_id", "hours", "description"];
  if (ts_mandatory_fields) {
    checkfields = ts_mandatory_fields;
  }
  for (var i=0; i<checkfields.length; i++) {
    var chkfield = checkfields[i];
    var elmt = $("input#" + chkfield + "__" + idflag);
    if (elmt.val()==null || elmt.val()=="") {
      if (showmsg==true) {
        mustFillField(chkfield);
      }
      return false;
    }
  }
  return true;
}

function showDayAction(elemts, vflag) {
  if (vflag==true) {
    elemts.show();
  } else {
    elemts.hide();
  }
  setTableWidth();
}

function submitEffort(idflag) {
  var clk_img = $("button#clock__"+idflag + " img");

  if (clk_img.length==1) {
    var srcpath = clk_img.attr("src");
    if (srcpath.indexOf("stop")>-1) {
      toggleClock(idflag);
    }
  }

  if (!validateTSFields(idflag, true)) {
    return false;
  }

  $("input#update_effort").val(idflag);
  var hourselmt = $("input#hours__" + idflag);
  hourselmt.val(parse_ts_hours(hourselmt.val()));
  setPageModified(false);
  $.ajax({
    url: window.location.pathname + "/../update_timesheet",
    dataType: "json",
    type: "POST",
    async: false,
    data: $("form#form1").serialize(),
    success: function (data) {
      if (data.success == 1) {
        submitForm1();
      } else if (data.message) {
        alert(data.message);
      }
    }
  });
}

function deleteEffortByID(ts_id) {
  setPageModified(false);
  $.ajax({
    url: window.location.pathname + "/../delete_timesheet",
    dataType: "json",
    type: "POST",
    async: false,
    data: ({delete_effort_id: ts_id}),
    success: function (data) {
      if (data.success == 1) {
        submitForm1();
      } else if (data.message) {
        alert(data.message);
      }
    }
  });
}


function changeEffort(ts_id, idflag) {
  cancelChange(idflag);
  var checkfields = ["cdb_project_id", "cdb_project_name", "task_id", "task_name",
                     "hours", "description", "activity_type_object_id", "activity_type", "effort_id"];
  for (var i=0; i<checkfields.length; i++) {
    var chkfield = checkfields[i];
    var elmt = $("#ts_" + chkfield + "__" + ts_id);
    var target_elmt = $("input#" + chkfield + "__" + idflag);
    if (elmt.length==1 && target_elmt.length==1) {
      if(elmt.is('input')) {
        if (chkfield!="hours") {
          target_elmt[0].value = elmt.val();
          var displayedInput = target_elmt.next("div.input-append").children("input");
          if (displayedInput.length) {
            displayedInput[0].value = elmt.val();
          }
        }else {
          var spanelmt = $("#span_ts_hours__" + ts_id);
          if (spanelmt.length==1) {
            target_elmt[0].value = spanelmt.text();
          }
        }
      }else {
        target_elmt[0].value = elmt.text();
      }
      target_elmt.removeClass("default_text");
    }
  }
  $("#btn_multi_day__" + idflag).addClass("hide_elmt");
  setPageModified(true);

  var tstd = $("#ts_effort_id__" + ts_id);
  var hdtd = $("input#effort_id__" + idflag);
  $("input#task_name__"+idflag).hide();
  var tstr = tstd.closest("tr");
  var hdtr = hdtd.closest("tr");
  checkfields = ["cdb_project_name", "cdb_project_id", "task_id","hours", "description", "activity_type_object_id", "buttons"];
  for (var i=0; i<checkfields.length; i++) {
    var chkfield = checkfields[i];
    tstr.children("td.t__" + chkfield).hide();
    hdtr.children("td.h__" + chkfield).appendTo(tstr);
    $("<td class='dummytd h__"+chkfield+"' />").appendTo(hdtr);
  }
  $("input#task_name__"+idflag).show();
  $("input#task_name__"+idflag).focus();
  enable_cpoi_button(idflag);
  tstr.addClass("ts_edit");
  tstr.children("td.h__buttons").find("div").children().attr("disabled", !"disabled");
  setTableWidth();
  $("input#project_name__" + idflag).focus();
}

function cancelChange(idflag) {

  var hdtd = $("input#effort_id__" + idflag);
  var ts_id = null;
  if (hdtd.length==1) {
    ts_id = hdtd.val();
  }

  var checkfields = ["cdb_project_id", "cdb_project_name", "task_id", "task_name", "hours",
                     "description", "activity_type_object_id", "activity_type",
                     "effort_id", "multi_day"];
  for (var i=0; i<checkfields.length; i++) {
    var chkfield = checkfields[i];
    var target_elmt = $("input#" + chkfield + "__" + idflag);
    if (target_elmt.length==1) {
      target_elmt[0].value = "";
      var displayedInput = target_elmt.next("div.input-append").children("input");
      if (displayedInput.length) {
        displayedInput[0].value = "";
      }
    }
  }
  var md_field = $("multi_day__" + idflag);
  changeMultiDay(md_field, idflag);

  $("#btn_multi_day__" + idflag).removeClass("hide_elmt");
  // force to close the clock and drop the time
  toggleClock(idflag, true, true);
  var wd_hours = $("input#wd_hours__"+idflag);
  var wd_sum = $("input#wd_sum_total__"+idflag);
  var hours_elmt = $("input#hours__"+idflag);
  if (wd_hours.length==1) {
    var hnum = parseFloat(wd_hours.val());
    var snum = 0;
    if (wd_sum.length==1) {
      snum = parseFloat(wd_sum.val());
    }
    if (hours_elmt.length==1) {
      hours_elmt[0].value = format_ts_hours(hnum-snum, " ");
      hours_elmt.addClass("default_text");
    }
  }
  setPageModified(false);
  var hdtr = hdtd.closest("tr");
  if (ts_id!="" && ts_id!=null) {
    var tstd = $("#ts_effort_id__" + ts_id);
    var tstr = tstd.closest("tr");
    checkfields = ["cdb_project_name", "cdb_project_id", "task_id","hours", "description",
                   "activity_type_object_id", "buttons"];
    for (var i=0; i<checkfields.length; i++) {
      var chkfield = checkfields[i];
      hdtr.children("td.dummytd").remove();
      tstr.children("td.h__" + chkfield).appendTo(hdtr);
      tstr.children("td.t__" + chkfield).show();
    }
    tstr.removeClass("ts_edit");
  }
  hdtr.children("td.h__buttons").find("div").children().attr("disabled", "disabled");

  enable_cpoi_button(idflag);
}


function toggleDay(idflag) {
  setPageModified(false);
  $.ajax({
    url: window.location.pathname + "/../switch_day",
    dataType: "json",
    type: "POST",
    async: false,
    data: ({
      close_workday: $("input#day__" + idflag).val(),
      cdb_person_id: $("input#cdb_person_id").val()
    }),
    success: function (data) {
      if (data.success == 1) {
        submitForm1();
      } else if (data.message) {
        alert(data.message);
      }
    }
  });
}

function selectDefaultTask(idflag) {
  $.ajax({
    url: window.location.pathname + "/../get_tasks",
    dataType: "json",
    type: "POST",
    data: ({cdb_project_id: $("input#cdb_project_id__"+idflag).val(),
      cdb_person_id: $("input#cdb_person_id").val(),
      max : 2,
      no_structure: 1,
      withdesc: idflag=="filter"?"":"1"
    }),
    success: function (data) {
      if (data.success == 1) {
        var rows = data.result;
        var currinput = $("input#task_name__"+idflag);
        var dflttask = false;
        if (rows.length == 1) {
          var row = rows[0];
          if (row.length > 1 && row[1]!="cdbpcs_timesheet_show_more") {
            $("input#task_id__"+idflag).val(row[1]);
            currinput.addClass("default_text").val(row[0]);
            if (row.length > 2 && idflag!='filter') {
              $("input#description__"+idflag).addClass("default_text").val(row[2]);
            }
            if (row.length > 4 && idflag!='filter') {
              $("input#activity_type__"+idflag).addClass("default_text").val(row[3]);
              $("input#activity_type_object_id__"+idflag).val(row[4]);
            }
            dflttask = true;
          }
        }
        if (!dflttask) {
          $("input#task_id__"+idflag).val("");
          currinput.removeClass("default_text").val("");
        }
        if (idflag=='filter') {
          //submitForm1();
        } else {
          enable_cpoi_button(idflag);
        }
      }
    }
  });
}

function toggleClock(idflag, forceclose, canceltime) {
  var clk = $("button#clock__"+idflag);
  var clk_img =$("button#clock__"+idflag + " img");
  var clk_st = $("span#clock_starttime__"+idflag);
  var clk_value = $("input#clock_value__"+idflag);
  var hfield = $("input#hours__"+idflag);
  if (clk.length==1 && clk_img.length==1 && clk_value.length==1
      && hfield.length==1 && clk_st.length==1) {
    var srcpath = clk_img.attr("src");
    // clock does not run yet
    if (srcpath.indexOf("run")>-1 && !forceclose) {
      var checkfields = ["cdb_project_id", "task_id"];
      for (var i=0; i<checkfields.length; i++) {
        var chkfield = checkfields[i];
        var elmt = $("input#" + chkfield + "__" + idflag);
        if (elmt.val()==null || elmt.val()=="") {
          mustFillField(chkfield);
          return false;
        }
      }
      srcpath = srcpath.replace("clock_run.png", "clock_stop.png");
      $(".icon-time").attr("class", "icon-ban-circle");
      clk_img.attr("src", srcpath);
      var clkv = new Date();
      clk_value.val(clkv.getTime());
      clk_st.removeClass("hide_elmt");
      var clkmin = clkv.getMinutes();
      clkmin = clkmin<10?"0"+clkmin:clkmin;
      clk_st.text(clkv.getHours()+":"+clkmin);
      // Keep and remind changes as clock runs!
      setPageModified(true);
    }else {
      srcpath = srcpath.replace("clock_stop.png", "clock_run.png");
      $(".icon-ban-circle").attr("class", "icon-time");
      clk_img.attr("src", srcpath);
      clk_st.addClass("hide_elmt");
      if (!canceltime) {
        var olddate = new Date();
        olddate.setTime(parseInt(clk_value.val()));
        var nowdate = new Date();
        var timediff = nowdate.getTime() - parseInt(clk_value.val());
        // base on minute
        timediff = Math.ceil(timediff / (1000*60));
        var oldsum = parse_ts_minutes(hfield.val());
        hfield.val(format_ts_minutes(oldsum+timediff, " "));
        hfield.removeClass("default_text");
      }
    }
  }
}

function submitForm1() {
  document.form1.submit();
}

var TASK_KEY = {
    UP : 38,
    DOWN : 40,
    DEL : 46,
    TAB : 9,
    RETURN : 13,
    ESC : 27,
    SPACE: 32
};

$(document).ready(function() {
  $('#tsheader_datepicker').click(function() {
        $('#tsheader_datepicker').datepicker({
            language: cdb.elink.currentLanguage,
            format: 'dd-mm-yyyy',
            weekStart: 1,
            autoclose: true
        }).on('changeDate', function(e){
          document.form1.sel_date.value=tm(e.date.valueOf());
          submitForm1();
        }).datepicker('show');
    });

  $("input#person_name").autocomplete(
      window.location.pathname + "/../get_persons",
      {
        formatItem: acFormatItem1,
        formatResult: acFormatResult1,
        minChars:0,
        matchContains:false,
        max:1000,
        autoFill:true,
        cacheLength:1,
        async: false,
        dataType: "json",
        extraParams: {"q_contains":0}
      }
  ).result(function (event, data, formatted) {
    if (data!=null) {
      $("input#cdb_person_id").val(data[1]);
      submitForm1();
    }
  }
  );

  function getProjects(byName, i) {
    var idflag = $(this).attr('id').replace(byName ? "project_name__" : "project_id__", "");
    $(this).autocomplete(
        window.location.pathname + "/../get_projects",
        {
          formatItem: acFormatItem2,
          formatResult: acFormatResult1,
          minChars:0,
          mustMatch:true,
          matchContains:false,
          max:1000,
          autoFill:false,
          cacheLength:0,
          async: false,
          emptyItem: "|",
          downward: true,
          dataType: "json",
          highlightOdd: true,
          extraParams: {
            "by_name": byName ? "1" : "0",
            "q_contains":1,
            "idflag":idflag,
            "cdb_person_id": function () {
              return $("input#cdb_person_id").val();
            },
            "filter_all_status" : get_filter_all_status,
            "filter_all_tasks" : get_filter_all_tasks,
            "filter_all_projects" : get_filter_all_projects
          }
        }
    ).result(function (event, data, formatted) {
      //fill other field  
      if (data) {
        if (byName) {
          $("input#project_id__" + idflag).val(data[1]);
        } else {
          $("input#project_name__" + idflag).val(data[0]);
        }
      }
      var oldid = $("input#cdb_project_id__"+idflag).val();
      var pidobj = $("input#cdb_project_id__"+idflag);
      if (data!=null && data[1]!="") {
        pidobj.val(data[1]);
        if (oldid!=data[1]) {
          selectDefaultTask(idflag);
          if (idflag!="filter") {
            showDayAction(pidobj.closest("tr").children("td.h__buttons").find("button"), true);
          }
        }
      }
      else {
        pidobj.val("");
        var oldtask = $("input#task_id__"+idflag).val();
        $("input#task_id__"+idflag).val("");
        $("input#task_name__"+idflag).val("");
        if ($("input#description__"+idflag).hasClass("default_text")) {
          $("input#description__"+idflag).val("");
        }
        if ($("input#activity_type__"+idflag).hasClass("default_text")) {
          $("input#activity_type__"+idflag).val("");
          $("input#activity_type_object_id__"+idflag).val("");
        }
        if (oldid!="" || oldtask!="") {
          if (idflag=='filter') {
            //submitForm1();
          }else {
            if ($("input#description__"+idflag).val()=="" &&
                $("input#activity_type_object_id__"+idflag).val()=="" &&
                $("input#hours__"+idflag).hasClass("default_text")) {
              showDayAction(pidobj.closest("tr").children("td.h__buttons").find("button"), false);
            } else {
              showDayAction(pidobj.closest("tr").children("td.h__buttons").find("button.save_button"), false);
            }
          }
        }
      }
    });
  }
  // Project fields
  $("input[id^=project_name__]").each(function (i) {
    getProjects.call(this, true, i);
  });
  $("input[id^=project_id__]").each(function (i) {
    getProjects.call(this, false, i);
  });

  // Task fields
  $("input[id^=task_name__]").each(function (i) {
    var idflag = $(this).attr('id').replace("task_name__", "");
    $(this).autocomplete(
        window.location.pathname + "/../get_tasks",
        {
          formatItem: acFormatItem1,
          formatResult: function(row) {
            if (row[1]!="cdbpcs_timesheet_show_more"){
              return acFormatResult1(row);
            }else {
              return $("input#task_name__"+idflag).val();
            }
          },
          minChars:0,
          matchContains:false,
          max:1000,
          mustMatch:false,
          autoFill:false,
          cacheLength:0,
          async: false,
          emptyItem: "||||",
          downward: true,
          dataType: "json",
          highlightOdd: true,
          extraParams: {
            "q_contains":0,
            "idflag":idflag,
            "cdb_project_id": function () {
              return $("input#cdb_project_id__"+idflag).val();
            },
            "cdb_person_id": function () {
              return $("input#cdb_person_id").val();
            },
            "withdesc": idflag=="filter"?"":"1",
                "filter_all_status" : get_filter_all_status,
                "filter_all_tasks" : get_filter_all_tasks,
                "filter_all_projects" : get_filter_all_projects
          }
        }
    ).result(function (event, data, formatted) {
      var oldtask = $("input#task_id__"+idflag).val();
      var currinput = $("input#task_name__"+idflag);
      var do_submit = true;
      if (data!=null) {
        if (data[1]!="cdbpcs_timesheet_show_more") {
          $("input#task_id__"+idflag).val(data[1]);
          $("input#description__"+idflag).val(data[2]);
          $("input#activity_type__"+idflag).val(data[3]);
          $("input#activity_type_object_id__"+idflag).val(data[4]);
        }else {
          if (currinput.val()==data[0]) {
            currinput.val("");
          }
          do_submit = false;
          selectMoreTask(idflag);
        }
      }
      else {
        $("input#task_id__"+idflag).val("");
      }
      enable_cpoi_button(idflag);
      if (idflag=='filter' && oldtask!=$("input#task_id__"+idflag).val() && do_submit) {
        //submitForm1();
      }
    }).focus(function () {
      $(this).removeClass("default_text");
    });
  });

  $("input[id^=description__]").focus(function () {
    $(this).removeClass("default_text");
  });

  // activity types
  $("input[id^=activity_type__]").each(function (i) {
    var idflag = $(this).attr('id').replace("activity_type__", "");
    $(this).autocomplete(
        window.location.pathname + "/../get_activity_types",
        {
          formatItem: acFormatItem1,
          formatResult: acFormatResult1,
          minChars:0,
          mustMatch:true,
          matchContains:false,
          max:1000,
          autoFill:true,
          cacheLength:0,
          async: false,
          emptyItem: "|",
          downward: true,
          highlightOdd: true,
          dataType: "json"
        }
    ).result(function (event, data, formatted) {
      var typeidobj = $("input#activity_type_object_id__"+idflag);
      if (data!=null && data[1]!="") {
        typeidobj.val(data[1]);
      }
      else {
        typeidobj.val("");
      }
    });
  });

  $("input[id^=activity_type__]").focus(function () {
    $(this).removeClass("default_text");
  }).keyup(function (eventobj) {
    if(eventobj.keyCode==13) {
      // submit!
      var idflag = $(this).attr('id').replace("activity_type__", "");
      $(this).blur();
      submitEffort(idflag);
    }
  });

  $("input[id^=hours__]").focus(function () {
    var elmt = $(this);
    if(elmt.hasClass("default_text")) {
      elmt.removeClass("default_text");
      var elmtv = parse_ts_hours(elmt.val());
      if(elmtv < 0) {
        elmt.val(format_ts_hours(0, " "));
      }
    }
  });

  $(".hourstext").each(function () {
    if($(this).is('input')) {
      $(this).val(format_ts_hours($(this).val(), " "));
    }else {
      if($(this).hasClass("diffhours")) {
        $(this).text(format_ts_hours($(this).text(), "\u00A0", true));
      }else {
        $(this).text(format_ts_hours($(this).text(), "\u00A0"));
      }
    }
  });

  // just do it again bcz. the scrollbar width of div#table_view
  // can't be measured yet after first resizing
  setTableWidth();
  $("div#table_view").removeClass("invisibleInit");
  init_rule_view();
  $("#structure_view").keydown(function(eventobj) {
    switch(eventobj.which) {
    case TASK_KEY.UP:
      move_focus_in_structure_view(-1);
      break
    case TASK_KEY.DOWN:
      move_focus_in_structure_view(1);
      break;
    case TASK_KEY.SPACE:
      var felem = $(document.activeElement);
      if (felem && felem.is("#structure_view #task_struct span:visible")) {
        felem.trigger("click");
      }
      break;
    case TASK_KEY.RETURN:
      var felem = $(document.activeElement);
      if (felem && felem.is("#structure_view #task_struct span:visible")) {
        felem.trigger("click");
      }
      if($("#structure_view button#structure_select_button").is(":disabled")) {
        close_structure_view();
      } else {
        close_structure_view_on_select(null);
      }
      break;
    case TASK_KEY.ESC:
      close_structure_view();
      break;
    case TASK_KEY.TAB:
      if(!eventobj.altKey) eventobj.preventDefault();
      break;
    default:
      //alert(eventobj.which);
      break;
    }
  });


  $("tr.is_today").each(function() {
    var targetField = $("input[id^=task_name].ac_input", this);
    if (!targetField.val()) {
      if (!targetField.hasClass('no_default_task')) {
        selectDefaultTask($("#hiddenDate").val());
      }
      if(location.href.indexOf("projid") != -1) {
        showDayAction($(this).children("td.h__buttons").find("button"), true);
        $(this).children("td.h__buttons").find("div").children().attr("disabled", !"disabled");
      }
    }
    else {
      targetField.trigger("search");
      $(this).children("td.h__buttons").find("div").children().attr("disabled", !"disabled");
    }

  });
});

function setTableWidth() {
  var tblwd;
  if ($.browser.msie) {
    tblwd = document.all.table_view.clientWidth;
  }else {
    tblwd = $("table#timesheets_table").parent().clientWidth;
  }

  $("table#timesheets_table").width(tblwd);
  var tidoffset = $("th.h__date").outerWidth() +
  $("th.h__dateactions").outerWidth() +
  $("th.h__cdb_project_id").outerWidth() +
  $("th.h__cdb_project_name").outerWidth() +
  $("th.h__task_id").outerWidth();

  var tdw = $("table#timesheets_header th.h__date").width();
  $("table#timesheets_table td.h__date div.dayname").width(tdw);
  $("table#timesheets_table td.h__date").width(tdw);
  $("table#timesheets_table td.t__date").width(tdw);


  var checkfields = ["cdb_project_id", "cdb_project_name", "task_id", "hours", "description", "activity_type_object_id"];
  var woffset = 33;
  for (var i=0;i<checkfields.length;i++) {
    tdw = $("table#timesheets_header th.h__"+checkfields[i]).width();
    $("table#timesheets_table td.h__"+checkfields[i]).width(tdw);
    $("table#timesheets_table td.t__"+checkfields[i]).width(tdw);
    $("table#timesheets_table td.h__"+checkfields[i]+" input[type='text']:not([id*='hours'])").width(tdw-woffset);
    $("table#timesheets_table td.t__"+checkfields[i]+" input[type='text']:not([id*='hours'])").width(tdw-woffset);
  }

  var tblhg = $("table#timesheets_table").height();
  var tbldiv = $("div#table_view");
  if (tblhg < tbldiv.height()) {
    tbldiv.height(tblhg);
  }

  tidoffset = $("table#timesheets_table td.h__date").outerWidth() +
  $("table#timesheets_table td.h__dateactions").outerWidth() +
  $("table#timesheets_table td.h__cdb_project_id").outerWidth() +
  $("table#timesheets_table td.h__cdb_project_name").outerWidth() +
  $("table#timesheets_table td.h__task_id").outerWidth();
  var sumwd = tidoffset +
  $("td#week_sum_label").width() -
  $("td#week_sum_label").innerWidth() - 15;

  $("td#week_sum_label").width(sumwd);
  $("td#week_sum_number").width($("table#timesheets_table td.h__hours").width());
}

var page_decimal_sep = ".";

function parse_ts_minutes(timestr) {
  var minutes = 0;
  var msgn = 1;
  if (timestr.charAt(0) == '-') {
    timestr = timestr.replace("-", "");
    msgn = -1;
  }
  if (timestr.indexOf(":") > 0) {
    var strgrp = timestr.split(":");
    minutes = parseInt(strgrp[0]) * 60;
    if (strgrp.length > 1) {
      minutes += parseInt(strgrp[1]);
    }
  }else {
    try {
      var timevalue = parseFloat(timestr);
      var hrs = Math.floor(timevalue);
      minutes = hrs * 60;
      minutes += (timevalue - hrs) * 60;
    }catch(e){};
  }
  return Math.round(minutes*msgn);
}

function parse_ts_hours(timestr) {
  if (timestr.indexOf(":") > 0) {
    var hours = 0;
    var msgn = 1;
    if (timestr.charAt(0) == '-') {
      timestr = timestr.replace("-", "");
      msgn = -1;
    }
    var strgrp = timestr.split(":");
    hours = parseInt(strgrp[0]);
    if (strgrp.length > 1) {
      try {
        hours += parseFloat(strgrp[1])/60.0;
      }catch(e) {}
    }
    return hours*msgn;
  }
  return timestr;
}


function format_ts_hours(h, sptxt, showplus) {
  var signsym = " ";
  if (h<0) {
    signsym = "-";
  }
  if (h>0) {
    signsym = "+";
  }

  var h0 = Math.abs(h);
  var hh = (Math.floor(h0)).toString();
  var mm = (Math.round((h0-Math.floor(h0))*60)).toString();
  if (mm.length < 2) {
    mm = "0" + mm;
  }
  if (h<0||showplus==true) {
    hh = signsym + hh;
  }
  if (hh.length < 2) {
    hh = sptxt + hh;
  }
  return hh+":"+mm;
}

function format_ts_minutes(m, sptxt) {
  var hh = (Math.floor(m/60)).toString();
  var mm = (m%60).toString();
  if (mm.length < 2) {
    mm = "0" + mm;
  }
  if (hh.length < 2) {
    hh = sptxt + hh;
  }
  return hh+":"+mm;
}

function timeonly(myfield, e, float_field) {
  var key;
  var keychar;

  if (window.event) {
    key = window.event.keyCode;
  } else if (e) {
    key = e.which;
  } else {
    return true;
  }
  keychar = String.fromCharCode(key);

  if ((key==null) || (key==0) || (key==8) ||
      (key==9) || (key==13) || (key==27) ) {
    // control keys
    return true;
  } else if ((("0123456789-: ").indexOf(keychar) > -1)) {
//    numbers
    return true;
  } else if (float_field && (keychar == ".")) {
    return true;
  } else {
    return false;
  }
}

function chooseMultiDay(idflag) {
    var date = replaceUnderscore(idflag);
    $('#btn_multi_day__'+idflag).attr('data-date',date);

      $('#btn_multi_day__'+idflag).datepicker({
        language: cdb.elink.currentLanguage,
        format: 'dd-mm-yyyy',
        startDate: date,
        weekStart: 1,
        autoclose: true
      }).on('changeDate', function(e){
        document.forms['form1'].elements['multi_day__'+idflag].value = tm(e.date.valueOf());
        document.forms['form1'].elements['multi_day__'+idflag].onchange();
        $('#btn_multi_day__'+idflag).datepicker('hide');
            }).datepicker('show');

}

function format_ts_date(dstr) {
  var dgrp = dstr.split(".");
  for (var i=0;i<dgrp.length;i++) {
    if(dgrp[i].charAt(0)=="0") {
      dgrp[i] = dgrp[i].slice(1);
    }
  }
  var result = parseInt(dgrp[0])+".";
  if (dgrp.length>1) {
    result = result + parseInt(dgrp[1]);
  }
  return result;
}

function changeMultiDay(elmt, idflag) {
  var tval = $(elmt).val();
  var dayelmt = $("input#day__" + idflag);
  var txtelmt = $("#text_multi_day__" + idflag);
  var selmt = txtelmt.siblings("span.to_symbol");
  if (tval==dayelmt.val()) {
    $(elmt).val("");
    tval = "";
  }
  if (tval=="" || tval==null || tval=='undefined') {
    txtelmt.addClass("hide_elmt");
    selmt.addClass("hide_elmt");
  }else {
    var spanelmt = $("#text_multi_day__" + idflag + " span");
    var dgrp = tval.split(".");
    for (var i=0;i<dgrp.length;i++) {
      if(dgrp[i].charAt(0)=="0") {
        dgrp[i] = dgrp[i].slice(1);
      }
    }

    var wtext = "";
    if (dgrp.length>1) {
      var thatday = new Date(parseInt(dgrp[2]),parseInt(dgrp[1])-1,parseInt(dgrp[0]));
      var wdnr = thatday.getDay();
      var nameKey = cdb.elink.currentLanguage == 'de' ? 'daysMin' : 'daysShort';
      wtext = $.fn.datepicker.dates[cdb.elink.currentLanguage][nameKey][wdnr];
    }
    spanelmt.text(wtext+" "+dgrp[0]+"."+dgrp[1]);
    txtelmt.removeClass("hide_elmt");
    selmt.removeClass("hide_elmt");
  }
}

function selectMoreTask(idflag) {
  $.ajax({
    url: window.location.pathname + "/../get_task_structure",
    dataType: "html",
    type: "POST",
    data: ({cdb_project_id: $("input#cdb_project_id__"+idflag).val(),
      cdb_person_id: $("input#cdb_person_id").val(),
      filter_all_status : get_filter_all_status(),
      filter_all_tasks : get_filter_all_tasks(),
      filter_all_projects : get_filter_all_projects()
    }),
    success: function (data) {
      var oldtask = $("input#task_id__"+idflag).val();
      var sltask = $("#structure_view #task_struct span.task_selectable[oid="+oldtask+"]");
      show_structure_view(idflag, data);

      if (sltask) {
        sltask.addClass("task_selected");
        sltask.parents("#task_struct li").each(function() {
          $(this).children("div.hitarea.expandable-hitarea").click();
        });
        $("#structure_view button#structure_select_button").removeAttr("disabled");
      }
    },
    error: function(jqXHR, textStatus, errorThrown) {
    }
  });
}

function close_structure_view() {
  var viewdiv = $("#structure_view");
  viewdiv.modal('hide');
  var topul = $("#task_struct", viewdiv);
  var fieldname = viewdiv.attr("curr_idflag");
  if (topul.attr("fill_target_field")=="description") {
    fieldname = "description__" + fieldname;
  } else {
    fieldname = "task_name__" + fieldname;
  }
  viewdiv.removeAttr("curr_idflag");
  topul.attr("disabled", "disabled");
  if (fieldname) {
    $("input#"+fieldname).focus();
  }
}

function close_structure_view_on_select(evtobj) {
  var viewdiv = $("#structure_view");
  var idflag = viewdiv.attr("curr_idflag");
  if (idflag) {
    var topul = $("#task_struct", viewdiv);
    if (topul) {
      var tsel = $("span.task_selected", viewdiv).first();
      var currinput = $("input#task_name__"+idflag);
      if (topul.attr("fill_target_field")=="task") {
        var oldtask = $("input#task_id__"+idflag).val();
        if (tsel) {
          $("input#task_id__"+idflag).val(tsel.attr("oid"));
          var tname = tsel.siblings("input:hidden.hidden_task_name").val();
          currinput.val(tname);
        }
        else {
          $("input#task_id__"+idflag).val("");
          currinput.val("")
        }
        enable_cpoi_button(idflag);
        if (idflag=='filter' && oldtask!=$("input#task_id__"+idflag).val()) {
          submitForm1();
        }
      }
      else if (topul.attr("fill_target_field")=="description") {
        if (tsel) {
          $("input#description__"+idflag).val(tsel.attr("objtype") + " " + tsel.text());
        }
      }
    }
    close_structure_view();
  }
}

function close_rule_view() {
  var viewdiv = $("#rule_view");
  $("input:checkbox[name]", viewdiv).each(function() {
    if($(this).is(":checked")) {
      if ($(this).attr('last_checked')=="0") {
        $(this).removeAttr("checked");
      }
    }
    else {
      if($(this).attr('last_checked')=="1") {
        $(this).attr("checked", "checked");
      }
    }
  });
  viewdiv.modal('hide');
}

function save_rule_view() {
  var viewdiv = $("#rule_view");
  $("input:checkbox[name]", viewdiv).each(function() {
    if($(this).is(":checked")) {
      $(this).attr("last_checked", "1");
      $.cookie($(this).attr('name'), "1");
      if($.inArray($(this).attr('name'), rulesEntries)==-1){
        rulesEntries.push($(this).attr('name'));
      }
    }
    else {
      $.cookie($(this).attr('name'), "0");
      if( $.inArray($(this).attr('name'), rulesEntries)!==-1){
        rulesEntries.splice( $.inArray($(this).attr('name'), rulesEntries), 1);
      }
    }
  });
  viewdiv.modal('hide');
  saveRuleOnServer();
}

function saveRuleOnServer(){
//  console.log(rulesEntries.join(","))
  $.ajax({
    url: window.location.pathname + "/../save_rule",
    dataType: "json",
    type: "POST",
    data: ({"rule_values":rulesEntries.join(",")}),
    success: function (data) {
//      console.log(data)
    },
    error: function(jqXHR, textStatus, errorThrown) {
//      console.log( errorThrown)
    }
  });
}

function loadRuleOnServer(){
  if($.cookie("ruleReady")==null){
    $.ajax({
      url: window.location.pathname + "/../load_rule",
      dataType: "json",
      type: "POST",
      async: false,
      data: ({}),
      success: function (data) {
        if(data.result !== "" && data.result!==null){
          rulesEntries = data.result.split(",");
        }
        $.cookie("ruleReady","1");
      },
      error: function(jqXHR, textStatus, errorThrown) {
//        console.log( errorThrown)
      }
    });
  }
}

function init_rule_view() {
  loadRuleOnServer();
  $("#rule_view input:checkbox[name]").each(function() {
    var cval = $.cookie($(this).attr('name'));
    if((cval=='1') || ($.inArray($(this).attr('name'), rulesEntries)!==-1)){
      $(this).attr("last_checked", "1");
      $(this).attr("checked", "checked");
    }else {
      $(this).attr("last_checked", "0");
      $(this).removeAttr("checked");
    }
  });
}

function show_rule_selection() {
  init_rule_view();
  var viewdiv = $("#rule_view");
  viewdiv.modal('show');
}

function get_filter_all_status() {
  return $("#rule_view input:checkbox[name=filter_all_status]").is(':checked')?1:0;
}

function get_filter_all_tasks() {
  return $("#rule_view input:checkbox[name=filter_all_tasks]").is(':checked')?1:0;
}

function get_filter_all_projects() {
  return $("#rule_view input:checkbox[name=filter_all_projects]").is(':checked')?1:0;
}

function show_cpoi_view(elmt) {
  var idflag = $(elmt).attr('id').replace("cpoi__", "");
  var projid = $("input#cdb_project_id__"+idflag).val();
  var taskid = $("input#task_id__"+idflag).val();
  if (projid && taskid) {
    $.ajax({
      url: window.location.pathname + "/../get_cpoi_structure",
      dataType: "html",
      type: "POST",
      data: ({cdb_project_id: projid,
        task_id: taskid,
        cdb_person_id: $("input#cdb_person_id").val()
      }),
      success: function (data) {
        show_structure_view(idflag, data);
      },
      error: function(jqXHR, textStatus, errorThrown) {
      }
    });
  }
}

function enable_cpoi_button(idflag) {
  var btnobj = $("button#cpoi__"+idflag);
  if (btnobj) {
    btnobj.attr("disabled", "disabled");
    var projid = $("input#cdb_project_id__"+idflag).val();
    var taskid = $("input#task_id__"+idflag).val();
    if (projid && taskid) {
      $.ajax({
        url: window.location.pathname + "/../has_cpoi",
        dataType: "json",
        type: "POST",
        data: ({cdb_project_id: projid,
          task_id: taskid,
          cdb_person_id: $("input#cdb_person_id").val()
        }),
        success: function (data) {
          if (data.success == 1 && (data.result == 1 || data.result == "1")) {
            btnobj.removeAttr("disabled");
          }
        }
      });
    }
  }
}

function show_structure_view(idflag, data) {
  if(showModal) {
    $("#task_struct").remove();
    var viewdiv = $("#structure_view");
    viewdiv.attr("curr_idflag", idflag);
    $("#structure_container", viewdiv).html(data);
    $("#task_struct").treeview({collapsed: true});
    $("button#structure_select_button", viewdiv).attr("disabled", "disabled");
    $("#task_struct span.task_selectable").click(function() {
      $("#task_struct span.task_selectable.task_selected").removeClass("task_selected");
      $(this).addClass("task_selected");
      close_structure_view_on_select();

    }).dblclick(function(evtobj) {evtobj.preventDefault();});
    $("#task_struct span:not(.task_selectable)").click(function() {
      $(this).closest("li").children("div.hitarea").click();
    });
    viewdiv.modal('show');
    $("#task_struct li.toplevel_object").children("div.hitarea").click();
    $("#structure_view #task_struct span:visible").first().focus();
    if (document.selection) {
      document.selection.empty();
    }
  }
}

function detect_focus_in_structure_view() {
  var felem = $(document.activeElement);
  if (!felem || !felem.is("#structure_view #task_struct span:visible")) {
    felem = $("#structure_view #task_struct span:visible").first();
    felem.focus();
  }
  return felem;
}

function move_focus_in_structure_view(mstep) {
  var felem = detect_focus_in_structure_view();
  var allelem = $("#structure_view #task_struct span:visible");
  var tidx = allelem.index(felem);
  tidx += mstep;
  if (tidx<0) {
    tidx = allelem.length - 1;
  }
  else if (tidx>=allelem.length) {
    tidx = 0;
  }
  var nextelem = allelem.eq(tidx);
  nextelem.focus();
}

// Prevents submitting the form again by refreshing
cdb.elink.reloadPage = function(pullAgain) {
  cdb.elink.replacePage(window.location.href);
};
