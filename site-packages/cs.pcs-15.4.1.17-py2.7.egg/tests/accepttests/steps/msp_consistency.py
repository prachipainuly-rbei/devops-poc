#!/usr/bin/env python
# coding: utf-8
#
# Copyright (C) 2016 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#
from cdb import CADDOK
from cdb import ue
from cdb.platform.gui import Message
from cdb.validationkit import run_with_project_roles
from cdb.validationkit import then
from cdb.validationkit import when
from common import getTestData


@when("^(?P<role>.*?) calls MSP consistency function$")
def step(context, role):
    @run_with_project_roles(context.project, role.split(","))
    def check_consistency():
        for task in context.project.TopTasks:
            task.msp_to_cdb_consistency_check()

    try:
        check_consistency()
    except ue.Exception, uexc:
        context.exception = uexc


@then("^exception '(?P<exc>.*?)' is thrown$")
def step(context, exc):
    msg = Message.ByKeys(exc)[CADDOK.LANGUAGE].split("%s")[0]
    assert hasattr(context, "exception"), (
        "no exception thrown, expected '%s'\n%s" % (msg, getTestData(context)))
    assert str(context.exception).startswith(msg), (
        "expected exception '%s', found '%s'\n%s" % (
            msg, context.exception, getTestData(context)))
