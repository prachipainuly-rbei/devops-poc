#!/usr/bin/env powerscript
# -*- python -*- coding: utf-8 -*-
#
# Copyright (C) 2016 CONTACT Software GmbH
# All rights reserved.
# http://www.contact-software.com
#

__docformat__ = "restructuredtext en"
__revision__ = "$Id: test_tasks_mixin.py 182034 2018-08-10 12:22:21Z umu $"

import unittest

from cdb import testcase
from cdb.constants import kOperationNew
from cdb.objects.operations import form_input
from cdb.objects.operations import operation

from cs.pcs.projects import Project
from cs.pcs.projects.tasks import Task


class TasksMixInTestCase(testcase.RollbackTestCase):
    def _delegate(self, new_sid, new_stype, *objs):
        for obj in objs:  # FIXME operation does not support multiselect
            operation(
                "cs_tasks_delegate",
                obj,
                form_input(
                    obj,
                    subject_id=new_sid,
                    subject_type=new_stype))

    def _setup_project(self):
        self.project = operation(kOperationNew, Project, cdb_project_id="#")
        self.task_one = operation(
            kOperationNew,
            Task,
            cdb_project_id=self.project.cdb_project_id,
            task_id="#",
        )
        self.task_two = operation(
            kOperationNew,
            Task,
            cdb_project_id=self.project.cdb_project_id,
            task_id="#",
        )

    def test_delegate_single_pcs_task(self):
        self._setup_project()
        self.task_one.Update(subject_id="caddok", subject_type="Person")
        self.assertEqual(self.task_one.subject_id, "caddok")
        self._delegate("Projektleiter", "PCS Role", self.task_one)
        self.assertEqual(self.task_one.subject_id, "Projektleiter")
        self._delegate("caddok", "Person", self.task_one)
        self.assertEqual(self.task_one.subject_id, "caddok")

    def test_delegate_multiple_pcs_task(self):
        self._setup_project()
        for task in [self.task_one, self.task_two]:
            task.Update(subject_id="caddok", subject_type="Person")
            self.assertEqual(task.subject_id, "caddok")

        self._delegate("Projektleiter", "PCS Role", self.task_one, self.task_two)

        for task in [self.task_one, self.task_two]:
            self.assertEqual(task.subject_id, "Projektleiter")

        self._delegate("caddok", "Person", self.task_one, self.task_two)

        for task in [self.task_one, self.task_two]:
            self.assertEqual(task.subject_id, "caddok")


# Allow running this testfile directly
if __name__ == "__main__":
    unittest.main()
