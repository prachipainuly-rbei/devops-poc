#!/usr/bin/env python
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 1990 - 2012 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#

__docformat__ = "restructuredtext en"
__revision__ = "$Id: __init__.py 146158 2016-09-09 09:13:00Z wme $"

import os
import io

from cdb import CADDOK
from cdb import util
from cs.documents import Document


_CDBWSCALL_FILE = u"""<?xml version="1.0"?>
<cdbwsinfo>
   <command>loadworkspacebyid</command>
   <parameters>
     <parameter>{cdb_object_id}</parameter>
   </parameters>
</cdbwsinfo>
"""


class Workspace(Document):
    __classname__ = "cdb_wsp"
    __match__ = Document.cdb_classname >= __classname__

    def stateChangeAllowed(self, target_state, batch):
        return True

    def disable_activity_stream_reg(self, ctx):
        ctx.disable_registers(["cdb_elink_activitystream"])

    def setDocumentNumber(self, ctx):
        if not self.teilenummer:
            self.z_nummer = "W%06d" % (util.nextval("WS_NR_SEQ"))
        else:
            self.z_nummer = self.makeNumber(self)

    def open_file(self, ctx=None):
        filename = os.path.join(CADDOK.TMPDIR, "open_ws.cdbwscall")
        f = io.open(filename, "w", encoding="utf-8")
        f.write(_CDBWSCALL_FILE.format(cdb_object_id=self.cdb_object_id))
        f.close()
        if ctx is not None:
            ctx.file(filename,
                     delete_file_after_view=True,
                     view_extern=True)

    event_map = {("cdb_wsp_edit", "now"): "open_file",
                 (("query", "requery"), "pre_mask"): "disable_activity_stream_reg"
                 }
