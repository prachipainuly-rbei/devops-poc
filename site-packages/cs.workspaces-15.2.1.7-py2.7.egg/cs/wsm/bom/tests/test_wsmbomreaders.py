#!/usr/bin/env python
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 1990 - 2013 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#
import json

import re

from cdb import sqlapi, util, sig, rte, misc
from cdb.comparch.packages import Package
from cdb.objects import OBJECT_STORE, ByID

from cs.documents import Document
from cs.vp.items import Item
from cs.vp.bom import AssemblyComponent
from cdb.testcase import RollbackTestCase, PlatformTestCase, \
    error_logging_disabled, without_error_logging

from cs.vp.bomcreator.bom import UserHintList, SharedPosition, \
    BOMEntry, BOM, GeneratedBOM, ReplaceDatetimeDecoder, ReplaceDatetimeEncoder, value_is_equal
from cs.vp.bomcreator.bomconfig import BOMConfig
from cs.vp.bomcreator.bomreader import BOMContext, create_bom_from_bom_context, \
    make_recursive_reader_type, ResultOrder, create_and_save_bom, \
    delete_unused_new_articles, create_bom, SimpleBOMReader
from cs.vp.bomcreator.factory import Factory
from cs.vp.bomcreator.takereaderfromdocument import TakeReaderFromDocument

from cs.wsm.virtualworkspace import VirtualWorkspace
from cs.wsm.bom.cadbominforeader import CADBomInfoReader, CADBomInfoReaderWithReferences
from cs.wsm.bom.componentstructurebomreader import ComponentStructureBOMReader

from testsupport_STL import Doc, createDocumentStructure, createItem, File, \
    PrimaryFile, PrimaryFileWithReplicationError, Variant, Uplink, LinkItem, \
    prefix, Directory
from cdbwrapc import CDBMsg


# mock bom settings with a factory mock up
def FactoryMockup(ReaderClass,
                  display_attrs=None,
                  key_attrs=None,
                  sync_from_cad_attrs=None,
                  sync_attrs=None,
                  headers=None,
                  new_position_step=10,
                  cadsource_to_replace=""):
    # defaults
    if display_attrs is None:
        display_attrs = ['position']
    if key_attrs is None:
        key_attrs = ['teilenummer', 't_index']
    if sync_from_cad_attrs is None:
        sync_from_cad_attrs = []
    if sync_attrs is None:
        sync_attrs = ['menge']
    if headers is None:
        headers = []

    class F(Factory):
        def __init__(self, bom_context):
            object.__init__(self)  # don't call Factory.__init__!

            self._context = bom_context
            self.cadsource = self._context.cadsource
            self.reader_class = ReaderClass
            self.display_attrs = display_attrs
            self.key_attrs = key_attrs
            self.sync_from_cad_attrs = sync_from_cad_attrs
            self.sync_attrs = sync_attrs
            if cadsource_to_replace:
                self.sync_attrs.append("cadsource")
            self.headers = headers
            self.new_positions_step = new_position_step
            self.mockWorkspace = None
            self.floatFormatting = util.get_prop('flfo')
            self.cadsource_to_replace = cadsource_to_replace
            self._init_component_field_types()

        mockWorkspace = None

        def createVirtualWorkspace(self, *args, **kwargs):
            if F.mockWorkspace:
                return F.mockWorkspace
            else:
                return VirtualWorkspace(*args, **kwargs)
    return F


class BOMTestCase(object):
    def setUp(self):
        # (some of) these attributes are set in derived classes
        self.workspace = None
        self.assembly = None
        self.expectedPositions = None
        self.expectedDisplay = None
        self.expectedStatus = None
        self.expectedMessages = None
        self.expectedInDatabase = None
        self.expectedOccurrences = None
        # default config
        self.config = FactoryMockup(ComponentStructureBOMReader,
                                    ['teilenummer', 't_index', 'menge', 'Item.designation', 'Item.mengeneinheit'],
                                    ['teilenummer', 't_index'],
                                    [('netto_laenge', u'length', False),
                                     ('netto_hoehe', u'height', False),
                                     ('netto_breite', u'width', False),
                                     ('netto_durchm', u'diameter', False)
                                     ],
                                    ['menge', 'position'],
                                    ['Artikelnummer', 'Artikelindex', 'Menge', 'Position', 'Bezeichnung', 'Mengeneinheit'],
                                    10
                                    )
        # we expect German error messages
        self.originalIsoLang = rte.environ.get('CADDOK_ISOLANG')
        rte.environ['CADDOK_ISOLANG'] = "de"

    def tearDown(self):
        if self.originalIsoLang is None:
            del rte.environ['CADDOK_ISOLANG']
        else:
            rte.environ['CADDOK_ISOLANG'] = self.originalIsoLang

    def runTestCase(self, erzeugsystem='ProE'):
        # prepare
        topDoc = createDocumentStructure(self.workspace)

        # do it
        context = BOMContext(topDoc.cdb_object_id,
                             self.assembly.teilenummer,
                             self.assembly.t_index,
                             erzeugsystem,
                             UserHintList())
        boms = create_bom_from_bom_context(context, None, self.config)
        bom = boms[0]
        hints = bom.user_hints

        for b in boms:
            b.synchronize()
            # delete BOM from disc (as side effect of deserialization)
            GeneratedBOM.from_json(json.loads(b.json, cls=ReplaceDatetimeDecoder))
            try:
                b2 = rebirth_bom(b, self.config)  # test serialization
                b2.write(hints)
            except Exception as e:
                print "Exception occurred when writing BOM: %s" % e

        bom.get_factory().reader.post_write_boms(boms, hints)

        # verify
        self._verifyMergedBOM(bom, self.expectedPositions)
        self._verifyDisplayedBOM(bom)
        self._verifySavedBOM(bom)
        self._verifyMessages(hints)
        return boms

    def _verifyMergedBOM(self, bom, expectedPositions):
        print "entries:"
        for e in bom.entries():
            print e.attrs

        if expectedPositions is not None:
            self.assertEqual(len(expectedPositions), len(bom.entries()))
            for entry, expected in zip(bom.entries(), expectedPositions):
                for k, v in expected.iteritems():
                    if not entry.attrs[k] == v:
                        print "k: %s, should: %s, is: %s" % (k, v, entry.attrs[k])
                    assert entry.attrs[k] == v

    def _verifyDisplayedBOM(self, bom):
        print "display columns:"
        displayed_rows = bom.non_deleted_entries + bom.deleted_entries
        for e in displayed_rows:
            print e.display_row.columns
        if self.expectedDisplay is not None:
            assert len(self.expectedPositions) == len(displayed_rows)
            for entry, expected in zip(displayed_rows, self.expectedDisplay):
                if entry.display_row.columns != expected:
                    pass
                assert entry.display_row.columns == expected

        print "status:"
        for e in bom.entries():
            print e.status_message
        if self.expectedStatus is not None:
            assert len(self.expectedStatus) == len(bom.entries())
            for entry, expected in zip(bom.entries(), self.expectedStatus):
                assert entry.status_message == expected

    def _verifySavedBOM(self, bom):
        print "from db:"
        # reget assembly from db!
        assembly = bom._assembly
        for c in assembly.Components:
            attrs = dict((field, c[field]) for field in c.GetFieldNames())
            print attrs
        expectedInDatabase = self.expectedInDatabase
        if expectedInDatabase is None:
            expectedInDatabase = self.expectedPositions
        if expectedInDatabase is not None:
            if len(expectedInDatabase) != len(assembly.Components):
                misc.cdblogv(misc.kLogMsg, 0, "expected len: %s" % len(expectedInDatabase))
                misc.cdblogv(misc.kLogMsg, 0, "actual len:   %s" % len(assembly.Components))

            assert len(expectedInDatabase) == len(assembly.Components)
            expectedByPosition = {}
            for p in expectedInDatabase:
                expectedByPosition[p['position']] = p
            for comp in assembly.Components:
                expected = expectedByPosition[comp.position]
                for k, v in expected.iteritems():
                    if not (comp[k] == v or (v is None and comp[k] is None)):
                        misc.cdblogv(misc.kLogMsg, 0, "expected: %s" % v)
                        misc.cdblogv(misc.kLogMsg, 0, "actual:   %s" % comp[k])
                    assert comp[k] == v or (v is None and comp[k] is None)

        if self.expectedOccurrences is not None:
            for comp, occs in zip(assembly.Components, self.expectedOccurrences):
                assert len(comp.Occurrences) == len(occs)

                expectedById = {}
                for p in occs:
                    expectedById[p['occurrence_id']] = p

                for occ in comp.Occurrences:
                    expected = expectedById[occ.occurrence_id]
                    for k, v in expected.iteritems():
                        assert occ[k] == v

    def _verifyMessages(self, hints):
        if self.expectedMessages is not None:
            print "errors and hints:"
            for m in hints:
                print m
            for msg in self.expectedMessages:
                messageFound = any([re.match(msg, hint) for (hint, alertType) in hints])
                assert messageFound, "Message not found: '%s'" % msg


class Test_wsmbomtools(BOMTestCase, RollbackTestCase):

    def setUp(self):
        BOMTestCase.setUp(self)
        RollbackTestCase.setUp(self)

    def tearDown(self):
        RollbackTestCase.tearDown(self)
        BOMTestCase.tearDown(self)

    def test_simpleBOM(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o3" sortval="3"> <cadreference path="doc2.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o4" sortval="4"> <cadreference path="doc3.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o5" sortval="5"> <cadreference path="doc4.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")),
                Doc(part1, PrimaryFile("doc2.prt")),
                Doc(part2, PrimaryFile("doc3.prt")),
                Doc(part3, PrimaryFile("doc4.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 3.0},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 30, 'teilenummer': part3.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu', 'neu', 'neu']
        self.expectedDisplay = [
            [part1.teilenummer, part1.t_index, '3', u'part1', u'Stk'],
            [part2.teilenummer, part2.t_index, '1', u'part2', u'Stk'],
            [part3.teilenummer, part3.t_index, '1', u'part3', u'Stk'],
        ]

        self.runTestCase()

    def test_occurrenceBOM(self):
        self.config = FactoryMockup(ComponentStructureBOMReader,
                                    key_attrs=["occurence_id"],
                                    sync_attrs=["occurence_id"])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o3" sortval="3"> <cadreference path="doc2.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o4" sortval="4"> <cadreference path="doc3.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o5" sortval="5"> <cadreference path="doc4.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")),
                Doc(part1, PrimaryFile("doc2.prt")),
                Doc(part2, PrimaryFile("doc3.prt")),
                Doc(part3, PrimaryFile("doc4.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'occurence_id': "o1"},
            {'position': 20, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'occurence_id': "o2"},
            {'position': 30, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'occurence_id': "o3"},
            {'position': 40, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'occurence_id': "o4"},
            {'position': 50, 'teilenummer': part3.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'occurence_id': "o5"},
        ]
        self.expectedStatus = ['neu', 'neu', 'neu', 'neu', 'neu']

        self.runTestCase()

    def test_wrongDisplayConfiguration(self):
        self.config = FactoryMockup(ComponentStructureBOMReader,
                                    display_attrs=['', 'unknown', 'Item.', 'Item.unknown', 'unknownqual.lala', 'Item.something.more', 'cdb_cdate'])

        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu']
        self.expectedDisplay = [
            ["Error: Unknown attribute '' of ''.",
             "Error: Unknown attribute 'unknown' of ''.",
             "Error: Unknown attribute '' of 'Item'.",
             "Error: Unknown attribute 'unknown' of 'Item'.",
             "Error: Unknown qualifier 'unknownqual'. The only allowed qualifiers are 'Item' and the empty qualifier.",
             "Syntax error: 'Item.something.more' is not an expression of the form 'A' or 'A.B'.",
             "-"]
        ]

        self.runTestCase()

    def test_newChangedDeleted(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        # 1. create new position
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu']
        self.expectedOccurrences = [[{'occurrence_id': "o1",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': ''}]]
        self.runTestCase()

        # 2. create position again: this time the status is "unchanged"
        self.expectedStatus = [u'unverändert']
        self.runTestCase()

        # 3. change it by creating one more occurrence, which also has a variant id
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc1.prt" variantid="v2"/> </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0},
        ]
        self.expectedStatus = [u'geändert']
        self.expectedOccurrences = [[{'occurrence_id': "o1",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': ''
                                      },
                                     {'occurrence_id': "o2",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': 'v2'
                                      }]]
        self.runTestCase()

        # 4. change occurrence info only
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o3" sortval="2"> <cadreference path="doc1.prt" variantid="v2"/> </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0},
        ]
        self.expectedStatus = [u'geändert (wg. Verbauungsinformationen)']
        self.expectedOccurrences = [[{'occurrence_id': "o1",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': ''
                                      },
                                     {'occurrence_id': "o3",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': 'v2'
                                      }]]
        self.runTestCase()

        # 5. create again without occurrences -> position is deleted
        appinfo = """
        <occurrences>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0},
        ]
        self.expectedInDatabase = []
        self.expectedStatus = [u'gelöscht']
        self.expectedOccurrences = [[]]
        self.runTestCase()

    def test_newChangedDeleted_fastMode(self):
        class FastModeReader(ComponentStructureBOMReader):
            def use_kernel_operations(self):
                return False

        self.config = FactoryMockup(FastModeReader)

        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        # 1. create new position
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu']
        self.expectedOccurrences = [[{'occurrence_id': "o1",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': ''}]]
        self.runTestCase()

        # 2. create position again: this time the status is "unchanged"
        self.expectedStatus = [u'unverändert']
        self.runTestCase()

        # 3. change it by creating one more occurrence, which also has a variant id
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc1.prt" variantid="v2"/> </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0},
        ]
        self.expectedStatus = [u'geändert']
        self.expectedOccurrences = [[{'occurrence_id': "o1",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': ''
                                      },
                                     {'occurrence_id': "o2",
                                      'reference_path': 'doc1.prt',
                                      'assembly_path': 'assembly.asm',
                                      'occurrence_variant_id': 'v2'
                                      }]]
        self.runTestCase()

        # 4. create again without occurrences -> position is deleted
        appinfo = """
        <occurrences>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0},
        ]
        self.expectedInDatabase = []
        self.expectedStatus = [u'gelöscht']
        self.expectedOccurrences = [[]]
        self.runTestCase()

    @without_error_logging
    def test_NULLAttributeIsReplaced(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['position', 'netto_hoehe'],
                                    sync_from_cad_attrs=[('netto_hoehe', 'netto_hoehe', True)],
                                    sync_attrs=['menge', 'netto_hoehe', 'position'])
        self.assembly = createItem()
        part = createItem(benennung="part")

        # 1. create a position where netto_hoehe is NULL
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
        </bom>""" % (part.teilenummer, part.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu']
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_hoehe': None},
        ]
        self.expectedDisplay = [[10, "-"]]
        self.runTestCase()

        # now run again such that NULL is replaced with a real value
        # check that this situation is displayed correctly
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10">
            <properties>
              <property id="netto_hoehe" value="2" type="float"/>
            </properties>
          </bomposition>
        </bom>""" % (part.teilenummer, part.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_hoehe': 2.0},
        ]
        self.expectedStatus = [u'geändert']
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_hoehe': 2.0},
        ]
        self.expectedDisplay = [[10, "2.0 (bisher: -)"]]
        self.runTestCase()

    def test_emptyPropertyStringForFloatIsNull(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['position', 'netto_hoehe'],
                                    sync_from_cad_attrs=[('netto_hoehe', 'netto_hoehe', True)],
                                    sync_attrs=['menge', 'netto_hoehe', 'position'])
        self.assembly = createItem()
        part = createItem(benennung="part")

        # GIVEN: an appinfo BOM position with an empty value for netto_hoehe
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10">
            <properties>
              <property id="netto_hoehe" value=""/>
            </properties>
          </bomposition>
        </bom>""" % (part.teilenummer, part.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]

        # WHEN: I create a CDB BOM from it
        # THEN: the mapped float attribute netto_hoehe will receive the value None/NULL
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_hoehe': sqlapi.NULL},
        ]
        self.expectedStatus = [u'geändert']
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_hoehe': sqlapi.NULL},
        ]
        self.expectedStatus = ['neu']
        self.runTestCase()

        # AND WHEN: I create the BOM again
        # THEN: it will be unchanged
        self.expectedStatus = [u'unverändert']
        self.runTestCase()

    def test_emptyPropertyStringForStringIsNotNull(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['position', 'netto_hoehe'],
                                    sync_from_cad_attrs=[('stlbemerkung', 'netto_hoehe', True)],
                                    sync_attrs=['menge', 'stlbemerkung', 'position'])
        self.assembly = createItem()
        part = createItem(benennung="part")

        # GIVEN: an appinfo BOM position with an empty value for netto_hoehe
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10">
            <properties>
              <property id="netto_hoehe" value=""/>
            </properties>
          </bomposition>
        </bom>""" % (part.teilenummer, part.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]

        # WHEN: I create a CDB BOM from it
        # THEN: the mapped string attribute stlbemerkung_hoehe will receive the value ""
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'stlbemerkung': ""},
        ]
        self.expectedStatus = [u'geändert']
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'stlbemerkung': ""},
        ]
        self.expectedStatus = ['neu']
        self.runTestCase()

        # AND WHEN: I create the BOM again
        # THEN: it will be unchanged
        self.expectedStatus = [u'unverändert']
        self.runTestCase()

    @without_error_logging
    def test_readBomInfo(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['position'],
                                    sync_from_cad_attrs=[('netto_breite', 'prop_width', True),
                                                         ('pos_z', 'prop_float', True)],
                                    sync_attrs=['menge', 'pos_z'])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="20">
            <properties>
              <property id="prop_width" value="42" type="int"/>
              <property id="prop_float" value="0.2" type="float"/>
            </properties>
          </bomposition>
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" posno="10" />
        </bom>""" % (part2.teilenummer, part2.t_index, part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_breite': 42, 'pos_z': 0.2},
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu', 'neu']
        self.expectedDisplay = [[10], [20]]
        self.runTestCase()

    def test_propertyType_DoesNotMatch_DBType(self):
        # GIVEN: a configuration that maps the property "prop_width" to "netto_breite"
        self.config = FactoryMockup(CADBomInfoReader,
                                    sync_from_cad_attrs=[('netto_breite', 'prop_width', True)],
                                    sync_attrs=['menge', 'netto_breite'])

        # AND: a cad document with a BOM in the appinfo, containing the property
        #      with type string
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10">
            <properties>
              <property id="prop_width" value="42" type="string"/>
            </properties>
          </bomposition>
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        # WHEN: I create a BOM for the document
        # THEN: CIM DB automatically convert the string property to int
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_breite': 42},
        ]
        self.expectedStatus = ['neu']
        self.runTestCase()

        # WHEN: I create the BOM again
        # THEN: the position is still considered unchanged although the
        #       appinfo type is string while the database type is int
        self.expectedStatus = [u'unverändert']
        self.runTestCase()

    def test_readBomInfo_sorting(self):
        # GIVEN: a BOM reader which discards posnos and sorts by netto_breite
        class CADBomInfoReaderWithSorting(CADBomInfoReader):
            def adjust_and_filter(self, attributes):
                attributes.pop('position', None)
                return True

            def sort_key(self, entry):
                return entry.attrs['netto_breite']

        # AND a configuration which uses this BOM reader
        #     and maps the property "prop_width" to the CDB attrib netto_breite
        self.config = FactoryMockup(CADBomInfoReaderWithSorting,
                                    display_attrs=['position'],
                                    sync_from_cad_attrs=[('netto_breite', 'prop_width', True)],
                                    )
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        # WHEN: I import this BOM (it has values for the property prop_width)
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10">
            <properties>
              <property id="prop_width" value="200" type="int"/>
            </properties>
          </bomposition>
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" posno="20">
            <properties>
              <property id="prop_width" value="100" type="int"/>
            </properties>
          </bomposition>
        </bom>""" % (part1.teilenummer, part1.t_index, part2.teilenummer, part2.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]

        # THEN: the resulting BOM will be sorted by netto_breite and
        #       positions numbers are assigned accordingly
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_breite': 100},
            {'position': 20, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_breite': 200},
        ]
        self.runTestCase()

    def test_readBomInfo_positionUpdate(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    key_attrs=['teilenummer', 't_index'],
                                    display_attrs=['position'],
                                    sync_attrs=['menge', 'position'])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" quantity="1" posno="10" />
        </bom>""" % part1.teilenummer

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.runTestCase()

        appinfo = """
        <bom>
          <bomposition id="p2" partno="%s" quantity="1" posno="10" />
          <bomposition id="p1" partno="%s" quantity="1" posno="20" />
        </bom>""" % (part2.teilenummer, part1.teilenummer)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 20, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 10, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = [u'geändert', u'neu']
        self.runTestCase()

    def test_warningForDuplicatePositionWithDifferentCadSource(self):
        # GIVEN: a BOM with a "manuell" entry at position 10
        self.config = FactoryMockup(CADBomInfoReader, key_attrs=['teilenummer', 't_index', 'position'])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
            <bom>
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>""" % (part1.teilenummer, part1.t_index)
        self.workspace = [Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))]
        self.runTestCase("manuell")

        # WHEN: I try to create a CAD entry at position 10
        #       (with a different component than the manuell entry)
        appinfo = """
            <bom>
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>""" % (part2.teilenummer, part2.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        # THEN: a warning is displayed
        self.expectedMessages = ['Auf der Position 10 gibt es bereits einen Eintrag in der Datenbank mit abweichender CAD-Quelle .*']
        self.runTestCase("ProE")
        #  AND: saving the BOM still works
        assert len(self.assembly.Components) == 2

    @without_error_logging
    def test_errorForDuplicatePositionWithDifferentCadSourceButSameComponent(self):
        # GIVEN: a BOM with a "manuell" entry at position 10
        self.config = FactoryMockup(CADBomInfoReader, key_attrs=['teilenummer', 't_index', 'position'])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
            <bom>
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>""" % (part1.teilenummer, part1.t_index)
        self.workspace = [Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))]
        self.runTestCase("manuell")

        # WHEN: I try to create a CAD entry at position 10
        #       (with the same component)
        appinfo = """
            <bom>
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        # THEN: an error displayed
        self.expectedMessages = [u'Auf der Position 10 gibt es bereits einen Eintrag in der Datenbank mit identischem Schlüssel, aber abweichender CAD-Quelle .*']
        self.runTestCase("ProE")
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'cadsource': "manuell"},
        ]

    @without_error_logging
    def test_readBomInfo_imperfectData(self):
        # partver and mapped properties are missing
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['position'],
                                    sync_from_cad_attrs=[('netto_breite', 'prop_width', True),
                                                         ('pos_z', 'prop_bool', True)],
                                    sync_attrs=['menge', 'pos_z'])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" quantity="1" posno="20" />
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" posno="10" />
        </bom>""" % (part2.teilenummer, part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu', 'neu']
        self.expectedDisplay = [[10], [20]]
        self.runTestCase()

    def test_readMultipleBomsInAppinfo(self):
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        asm1 = createItem()
        asm2 = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <boms>
            <bom id="b1" partno="%s" partver="%s">
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>
            <bom id="b2" partno="%s">
              <bomposition id="p2" partno="%s" partver="%s" quantity="2" posno="10" />
            </bom>
        </boms>""" % (asm1.teilenummer, asm1.t_index,
                      part1.teilenummer, part1.t_index,
                      asm2.teilenummer,
                      part2.teilenummer, part2.t_index)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.runTestCase()

        # check result
        OBJECT_STORE.set_dirty()
        a1 = Item.ByKeys(teilenummer=asm1.teilenummer, t_index=asm1.t_index)

        assert len(a1.Components) == 1
        assert a1.Components[0].menge == 1
        assert a1.Components[0].teilenummer == part1.teilenummer

        a2 = Item.ByKeys(teilenummer=asm2.teilenummer, t_index="")
        assert len(a2.Components) == 1
        assert a2.Components[0].menge == 2
        assert a2.Components[0].teilenummer == part2.teilenummer

    def test_CADBOMInfoReaderWithReferences_variantWithoutItem(self):
        self.config = FactoryMockup(CADBomInfoReaderWithReferences)
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        # GIVEN: two BOMs whose target is identified by the anchor file path
        #        one of the BOMs references a variant and that variant has
        #        NO ITEM
        appinfo = """
        <boms>
            <bom id="b1">
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            <cadreference path="assembly.asm"/>
            </bom>
            <bom id="b2">
              <bomposition id="p2" partno="%s" partver="%s" quantity="2" posno="10" />
            <cadreference path="assembly.asm" variantid="variant1"/>
            </bom>
        </boms>""" % (part1.teilenummer, part1.t_index,
                      part2.teilenummer, part2.t_index)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Variant(None, "variant1"))
        ]

        # WHEN: I try to create a BOM from it
        # THEN: the assembly will receive the first BOM
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0}
        ]
        self.runTestCase()

    def test_CADBOMInfoReaderWithReferences_variantWithItem(self):
        self.config = FactoryMockup(CADBomInfoReaderWithReferences)
        self.assembly = createItem()
        assembly2 = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        # GIVEN: two BOMs whose target is identified by the anchor file path
        #        one of the BOMs references a variant and that variant has
        #        an associated item
        appinfo = """
        <boms>
            <bom id="b1">
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            <cadreference path="assembly.asm"/>
            </bom>
            <bom id="b2">
              <bomposition id="p2" partno="%s" partver="%s" quantity="2" posno="10" />
            <cadreference path="assembly.asm" variantid="variant1"/>
            </bom>
        </boms>""" % (part1.teilenummer, part1.t_index,
                      part2.teilenummer, part2.t_index)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Variant(assembly2, "variant1"))
        ]

        # WHEN: I try to create a BOM from it
        # THEN: the assembly of the doc will receive the first BOM and
        #       the assembly of the variant will receive the other BOM
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0}
        ]
        self.runTestCase()

        OBJECT_STORE.set_dirty()
        a2 = Item.ByKeys(teilenummer=assembly2.teilenummer, t_index="")
        assert len(a2.Components) == 1
        assert a2.Components[0].menge == 2
        assert a2.Components[0].teilenummer == part2.teilenummer

    def test_readSingleBomWithoutPartInBoms(self):
        # given: a fresh document with an assembly and a newly created part
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        # when: I try to read a BOM without partno from appinfo and it is
        # the only BOM inside of a BOMS element
        appinfo = """
        <boms>
            <bom id="b1">
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>
        </boms>""" % (part1.teilenummer, part1.t_index)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]

        # then: the imported BOM will be assigned to the assembly
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.runTestCase()

    def test_multipleBomsWithoutPartInBoms(self):
        # given: a fresh document with an assembly and a newly created part
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        # when: I try to read multiple BOMs without partno from appinfo
        appinfo = """
        <boms>
            <bom id="b1">
              <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
            </bom>
            <bom id="b2">
              <bomposition id="p1" partno="%s" partver="%s" quantity="2" posno="20" />
            </bom>
        </boms>""" % (part1.teilenummer, part1.t_index, part1.teilenummer, part1.t_index)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]

        # then: no BOM is imported and an error message is shown
        self.expectedPositions = []
        self.expectedMessages = ["Die Dateiinformationen enthalten eine Stückliste oder Stücklistenposition ohne Baugruppenbezug. Das Element wird ignoriert."]
        self.runTestCase()

    def test_readBomInfoWithRefs(self):
        self.config = FactoryMockup(CADBomInfoReaderWithReferences)

        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <bom>

          <!-- a position without partno -->
          <bomposition id="p1" quantity="1" posno="10">
            <cadreference path="part1.prt"/>
          </bomposition>

          <!-- a position with empty partno -->
          <bomposition id="p2" partno="" quantity="1" posno="20">
            <cadreference path="part1.prt"/>
          </bomposition>

          <!-- a position with parto to non-existing part -->
          <bomposition id="p3" partno="unknown" quantity="1" posno="30">
            <cadreference path="part1.prt"/>
          </bomposition>

          <!-- a position referencing a non existing file -->
          <bomposition id="p4" partno="" quantity="1" posno="40">
            <cadreference path="missingpart.prt"/>
          </bomposition>
        </bom>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0},
        ]

        self.runTestCase()

    # runs a test using the default configuration
    # we can't know the result unless we assume a specific configuration
    # so we don't compare; this test just ensures that there is some
    # code path which does not crash
    def test_defaultConfig(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]

        self.runTestCase()

    def test_automaticBomCreation(self):
        config = FactoryMockup(CADBomInfoReader)
        assembly = createItem()
        part1, part2 = createItem(benennung="part1"), createItem(benennung="part2")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" posno="20" />
        </bom>""" % (part1.teilenummer, part1.t_index,
                     part2.teilenummer, part2.t_index)

        workspace = [
            Doc(assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        assemblyDoc = createDocumentStructure(workspace)

        errorsAndHints = UserHintList()
        success = create_and_save_bom(assemblyDoc, errorsAndHints, config)
        assert success

        OBJECT_STORE.set_dirty()

        item = Item.ByKeys(teilenummer=assembly.teilenummer, t_index=assembly.t_index)
        assert len(item.Components) == 2
        components = sorted(item.Components, key=lambda c: c.position)
        assert components[0].teilenummer == part1.teilenummer
        assert components[1].teilenummer == part2.teilenummer

    def test_is_applicable_to(self):
        self.assembly = createItem()
        assemblyDoc = Document.Create(z_nummer=prefix + "1",
                                      z_index='',
                                      teilenummer=self.assembly.teilenummer,
                                      t_index=self.assembly.t_index)
        # first, check the is_applicable_to class method
        assemblyDoc.bom_method = ""
        assert not TakeReaderFromDocument.is_applicable_to(assemblyDoc.cdb_object_id)
        assemblyDoc.bom_method = None
        assert not TakeReaderFromDocument.is_applicable_to(assemblyDoc.cdb_object_id)
        assemblyDoc.bom_method = "Unknown method"
        assert not TakeReaderFromDocument.is_applicable_to(assemblyDoc.cdb_object_id)
        assemblyDoc.bom_method = "Auslesen aus der Appinfo"
        assert TakeReaderFromDocument.is_applicable_to(assemblyDoc.cdb_object_id)

    def test_documentSpecificMethod(self):
        self.config = FactoryMockup(TakeReaderFromDocument)

        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                bom_method="Auslesen aus der Appinfo")
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]

        self.runTestCase()

        # check use of non-standard key to prevent merging of entries with identical part, but different netto_laenge
        # also check numbering of positionless new/changed entries with the customized step size (13)
    @without_error_logging
    def test_mergeNonStandard(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    key_attrs=['teilenummer', 't_index', 'netto_laenge'],
                                    sync_attrs=['menge', 'netto_hoehe'],
                                    sync_from_cad_attrs=[('netto_laenge', 'length', True), ('netto_hoehe', 'height', True)],
                                    new_position_step=13)

        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <bom>

          <bomposition id="p1" partno="%s" quantity="1">
              <properties>
                  <property id="length" value="1.0" type="float"/>
                  <property id="height" value="1.0" type="float"/>
              </properties>
          </bomposition>

          <bomposition id="p2" partno="%s" quantity="1">
              <properties>
                  <property id="length" value="2" type="int"/>
              </properties>
          </bomposition>

          <bomposition id="p3" partno="%s" quantity="1">
              <properties>
                  <property id="length" value="2.0" type="float"/>
              </properties>
          </bomposition>

        </bom>""" % (part1.teilenummer, part1.teilenummer, part1.teilenummer)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            # also check that the int value of the middle position is automatically converted to float and the positions are merged
            {'position': 13, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0, 'netto_laenge': 2.0},
            {'position': 26, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_laenge': 1.0, 'netto_hoehe': 1.0},
        ]
        self.runTestCase()

        # repeat with changed property
        appinfo = """
        <bom>

          <bomposition id="p1" partno="%s" quantity="1">
              <properties>
                  <property id="length" value="1.0" type="float"/>
                  <property id="height" value="2.0" type="float"/>
              </properties>
          </bomposition>

          <bomposition id="p2" partno="%s" quantity="1">
              <properties>
                  <property id="length" value="2" type="int"/>
              </properties>
          </bomposition>

          <bomposition id="p3" partno="%s" quantity="1">
              <properties>
                  <property id="length" value="2.0" type="float"/>
              </properties>
          </bomposition>

        </bom>""" % (part1.teilenummer, part1.teilenummer, part1.teilenummer)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            # also check that the int value of the middle position is automatically converted to float and the positions are merged
            {'position': 13, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 2.0, 'netto_laenge': 2.0},
            {'position': 26, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'netto_laenge': 1.0, 'netto_hoehe': 2.0},
        ]
        self.runTestCase()

        # check sync with existing entries
        #  - including position, menge and netto_laenge
    def test_syncWithExisting(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    key_attrs=['teilenummer', 't_index'],
                                    sync_from_cad_attrs=[('netto_laenge', 'length', True)],
                                    sync_attrs=['menge', 'position', 'netto_laenge'])

        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part1")

        # create first version
        appinfo = """
        <bom>

          <bomposition id="p1" partno="%s" quantity="3" posno="4">
              <properties>
                  <property id="length" value="1.0" type="float"/>
              </properties>
          </bomposition>

          <bomposition id="p2" partno="%s" quantity="6" posno="11">
              <properties>
                  <property id="length" value="2.0" type="float"/>
              </properties>
          </bomposition>

        </bom>""" % (part1.teilenummer, part2.teilenummer)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 4, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 3.0, 'netto_laenge': 1.0},
            {'position': 11, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 6.0, 'netto_laenge': 2.0},
        ]
        self.runTestCase()

        # update and check
        appinfo = """
        <bom>

          <bomposition id="p1" partno="%s" quantity="7" posno="99">
              <properties>
                  <property id="length" value="3.0" type="float"/>
              </properties>
          </bomposition>

          <bomposition id="p2" partno="%s" quantity="12" posno="111">
              <properties>
                  <property id="length" value="4.0" type="float"/>
              </properties>
          </bomposition>

        </bom>""" % (part1.teilenummer, part2.teilenummer)
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 99, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 7.0, 'netto_laenge': 3.0},
            {'position': 111, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 12.0, 'netto_laenge': 4.0},
        ]
        self.expectedStatus = [u'geändert', u'geändert']
        self.runTestCase()

    def test_occurrenceWithVariant(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="variant1"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt"),
                    Variant(part2, "variant1")
                    ))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.runTestCase()

    def test_occurrenceWithVariant_whitespaceInVariantId(self):
        # GIVEN: an CAD doc with an occurrence refering to a variant by an id
        #        with leading/trailing whitespace
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid=" variant1 "/>  <!-- whitespace -->
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt"),
                    Variant(part2, "variant1")  # no whitespace
                    ))
        ]
        # WHEN: I try to create a BOM
        # THEN: the variant is found even though the id does not match exactly
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.runTestCase()

    def test_multipleVariantsOfTopLevelAssembly(self):
        # GIVEN: a cad document representing an assembly with multiple variants
        self.assembly = createItem()
        self.variantAssembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2">
            <cadreference path="part2.prt"/>
          </occurrence>
        </occurrences>
        <variants>
          <variant id="var1" name="var1">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part1.prt"/>
              </occurrence>
            </occurrences>
          </variant>
          <variant id="var2" name="var2">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part2.prt"/>
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Variant(self.variantAssembly, "var1"),
                Variant(None, "var2"),
                Doc(part1, PrimaryFile("part1.prt")),
                Doc(part2, PrimaryFile("part2.prt")))
        ]
        # WHEN: I create BOMS for this cad document
        # THEN: the main assembly gets the expected BOM
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        boms = self.runTestCase()
        # AND: there is BOM for var1 because it has an associated assembly
        variantBom = boms[1]
        expectedVariantPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.variantAssembly.teilenummer, 'b_index': self.variantAssembly.t_index},
        ]
        self._verifyMergedBOM(variantBom, expectedVariantPositions)
        # AND: there is NO BOM for var2 because it doesn't have an assembly
        assert len(boms) == 2

    def test_multipleVariantsWithSameItem(self):
        # GIVEN: a cad document representing an assembly with multiple variants
        self.assembly = createItem()
        self.variantAssembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2">
            <cadreference path="part2.prt"/>
          </occurrence>
        </occurrences>
        <variants>
          <variant id="var1" name="var1">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part1.prt"/>
              </occurrence>
            </occurrences>
          </variant>
          <variant id="var2" name="var2">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part2.prt"/>
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Variant(self.variantAssembly, "var1"),
                Variant(self.variantAssembly, "var2"),
                Doc(part1, PrimaryFile("part1.prt")),
                Doc(part2, PrimaryFile("part2.prt")))
        ]
        # WHEN: I create BOMS for this cad document
        # THEN: the main assembly gets the expected BOM
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        boms = self.runTestCase()
        # AND: there is BOM for var1 because it has an associated assembly
        variantBom = boms[1]
        expectedVariantPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.variantAssembly.teilenummer, 'b_index': self.variantAssembly.t_index},
        ]
        self._verifyMergedBOM(variantBom, expectedVariantPositions)
        # AND: there is NO BOM for var2 because it has the same assembly as var1
        assert len(boms) == 2

    def test_variantWithSameItemAsDocument(self):
        # GIVEN: a cad document representing an assembly with multiple variants
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2">
            <cadreference path="part2.prt"/>
          </occurrence>
        </occurrences>
        <variants>
          <variant id="var1" name="var1">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part1.prt"/>
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Variant(self.assembly, "var1"),
                Doc(part1, PrimaryFile("part1.prt")),
                Doc(part2, PrimaryFile("part2.prt")))
        ]
        # WHEN: I create BOMS for this cad document
        # THEN: the main assembly gets the expected BOM
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        boms = self.runTestCase()
        # AND: there no BOM for var1 because it has the same assembly as the document
        assert len(boms) == 1

    def test_referencePathWithWhitespace(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part with whitespace.prt"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part with whitespace.prt"))
                )
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.runTestCase()

    def test_referencePathInSubDir(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="subdir/part with whitespace.prt"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, Directory("subdir", PrimaryFile("part with whitespace.prt")))
                )
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.runTestCase()

    def test_occurrenceWithVariantWithoutPart(self):
        # -> part of main document is used
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="variant1"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt"),
                    Variant(None, "variant1")
                    ))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.expectedMessages = ["Der Variante 'variant1' des Dokuments .* ist kein Artikel zugeordnet. Stattdessen wird der dem Dokument zugeordnete Artikel benutzt."]
        self.runTestCase()

    def test_occurrenceWithMissingVariant(self):
        # -> part of main document is used
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="missingvariant"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.runTestCase()

    def test_occurrenceWithVariantWithMissingPart(self):
        # -> part of main document is used (with warning)
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="variant1"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt"),
                    Variant(item=None, variantId="variant1", teilenummer="missingpart", t_index="")
                    ))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.expectedMessages = ["Artikel 'missingpart-' von Variante 'variant1' von Dokument .* nicht gefunden. Stattdessen wird der dem Dokument zugeordnete Artikel benutzt."]
        self.runTestCase()

    def test_occurrenceWithVariantWithNullTIndex(self):
        # -> part of main document is used
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="variant1"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt"),
                    Variant(item=None, variantId="variant1", teilenummer=part2.teilenummer, t_index=None)
                    ))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'menge': 1.0, 'baugruppe': self.assembly.teilenummer, 'b_index': self.assembly.t_index}
        ]
        self.runTestCase()

    def test_fileErrors(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="missingfile.prt"/>
          </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2">
            <cadreference path="nonanchor.prt"/>
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, File("nonanchor.prt")))
        ]
        self.expectedPositions = []
        self.expectedMessages = [
            "Die Datei 'missingfile.prt' ist auf dem Server nicht verfügbar.*",
            "Die referenzierte Datei .* ist keine Haupt-/Ankerdatei.*",
        ]
        self.runTestCase()

    def test_appinfoInvalid(self):
        self.assembly = createItem()

        appinfo = """<nonClosedTag>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = []
        self.expectedMessages = ["Workspace Manager-Dateiinformation 'assembly.asm' ist ungültig."]
        with error_logging_disabled():
            self.runTestCase()

    def test_appinfoMissing(self):
        self.assembly = createItem()

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm"))
        ]
        self.expectedPositions = []
        self.expectedMessages = ["Das Dokument 'assembly.asm' wurde nicht mittels Workspace Manager importiert oder es sind keine Workspace Manager-Dateiinformationen vorhanden."]
        with error_logging_disabled():
            self.runTestCase()

    @without_error_logging
    def test_missingRights(self):
        self.assembly = createItem()
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", ""))
        ]
        self.expectedPositions = []
        bom = self.runTestCase()[0]

        bom._has_BOM_rights = lambda: False
        hints = UserHintList()
        bom.write(hints)

        assert hints[0][0].startswith(u"Sie haben nicht die benötigten Zugriffsrechte, um eine Stückliste für die Baugruppe")

    @without_error_logging
    def test_missingSTLLicense(self):
        self.assembly = createItem()
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", ""))
        ]
        self.expectedPositions = []
        bom = self.runTestCase()[0]

        bom._check_STL_license = lambda: False
        hints = UserHintList()
        bom.write(hints)

        assert hints[0][0] == u"Es fehlt die notwendige Lizenz für das Feature 'BOM Creation: Execute' ('BOMCREATOR_001')'. Die Stückliste kann nicht ausgeleitet werden."

    @without_error_logging
    def test_replicationError(self):
        self.assembly = createItem()
        self.workspace = [
            Doc(self.assembly, PrimaryFileWithReplicationError("assembly.asm", ""))
        ]
        self.expectedPositions = []
        self.expectedMessages = [
            u"Die notwendigen Daten konnten nicht vom entfernten Standort ermittelt werden."
            u" Die Stücklistenausleitung ist zurzeit nicht möglich. \(Dateiname 'assembly.asm'\)"
        ]
        self.runTestCase()

    def test_wrongQuantityFormat(self):
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="illegal format" posno="10" />
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 0.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}]
        self.expectedMessages = ["Ungültiges Format für das 'Menge'-Attribut. Es muss eine Zahl sein.*"]
        self.runTestCase()

    def test_wrongPositionFormat(self):
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="illegal position" />
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}]
        self.expectedMessages = ["Ungültiges Format für Positionsnummer.*"]
        self.runTestCase()

    def test_WSM_BOM_part_not_found(self):
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        appinfo = """
        <bom>
          <bomposition id="p1" partno="non-existing teilenummer" partver="" quantity="1" posno="10" />
        </bom>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = []
        self.expectedMessages = [
            u"Der aus einer Stückliste oder Stücklistenposition referenzierte Artikel 'non-existing teilenummer-' konnte nicht gefunden werden. Das Element wird ignoriert."]
        self.runTestCase()

    def test_WSM_BOM_no_bominfo(self):
        self.config = FactoryMockup(CADBomInfoReader)
        self.assembly = createItem()
        appinfo = "<occurrences/>"
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = []
        self.expectedMessages = [
            u"Keine Stücklisteninformationen zu der Datei 'assembly.asm' .*"]
        self.runTestCase()

    def test_documentWithoutArticle(self):
        # -> part of main document is used
        self.assembly = createItem()
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" />
          </occurrence>
        </occurrences>"""
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(None, PrimaryFile("part1.prt"), teilenummer="non existing part", t_index=""))
        ]
        self.expectedPositions = []
        self.expectedMessages = ["Dem Dokument '.*' ist kein Artikel zugeordnet.*"]
        self.runTestCase()

    def test_bomRelevantFlag(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="no" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")),
                Doc(part2, PrimaryFile("doc2.prt")))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.expectedStatus = ['neu']
        self.runTestCase()

    def test_ignore_occurrence_customized(self):
        class IgnoreSuppressedOccurrences(ComponentStructureBOMReader):
            def ignore_occurrence(self, occurrence):
                return not occurrence.isBomRelevant() or occurrence.isSuppressed()

        self.config = FactoryMockup(IgnoreSuppressedOccurrences)

        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" suppressed="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="no" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")),
                Doc(part2, PrimaryFile("doc2.prt")))
        ]

        self.expectedPositions = [
        ]
        self.runTestCase()

    def test_ignoreComponentDocument(self):
        # GIVEN: a bom reader which simulates a match of the object rule
        #        "BOM: Ignore Component Document"
        class IgnoreComponentDocument(ComponentStructureBOMReader):
            def ignore_component_document(self, document, user_hints=None):
                return document.titel == "to ignore"

        self.config = FactoryMockup(IgnoreComponentDocument)

        # WHEN: I create a BOM from a simple component structure
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt"), titel="to ignore"),
                Doc(part2, PrimaryFile("doc2.prt"), titel="not ignore"))
        ]

        # THEN: the first component is ignored because its 'titel' matches the
        #       simulated object rule
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]
        self.runTestCase()

    def test_recursiveReader(self):
        # define our own bom function in order to pass on our own mock
        # configuration (factory)
        def my_create_bom(doc, global_user_hints, custom_state=None, variant_id=None, cadsource=None):
            bs = []
            context = BOMContext(doc.cdb_object_id,
                                 doc.teilenummer, doc.t_index,
                                 doc.erzeug_system, global_user_hints, variant_id)
            boms_of_item = create_bom_from_bom_context(context, custom_state, self.config)
            bs.extend(boms_of_item)
            return bs

        reader_type = make_recursive_reader_type(ComponentStructureBOMReader,
                                                 ResultOrder.BreadthFirst,
                                                 create_from_doc=my_create_bom)
        self.config = FactoryMockup(reader_type)

        # create test data
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part1b = createItem(benennung="part1b")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        topAppinfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="1b"/>
          </occurrence>
        </occurrences>
        """
        part1AppInfo = """"
        <occurrences>
        </occurrences>
        <variants>
          <variant id="1b" name="1b">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part2.prt" />
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """
        part2AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part3.prt" variantid=""/>
          </occurrence>
        </occurrences>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppinfo),
                Doc(part1, PrimaryFile("part1.prt", part1AppInfo),
                    Variant(part1b, "1b"),
                    Doc(part2, PrimaryFile("part2.prt", part2AppInfo),
                        Doc(part3, PrimaryFile("part3.prt", "<occurrences/>")))))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1b.teilenummer, 't_index': part1b.t_index, 'baugruppe': self.assembly.teilenummer}
        ]
        self.expectedMessages = []
        boms = self.runTestCase()

        assert len(boms) == 4
        assert len(boms[1].entries()) == 1
        assert len(boms[2].entries()) == 1
        assert len(boms[3].entries()) == 0
        assert boms[1].entries()[0].attrs['baugruppe'] == part1b.teilenummer
        assert boms[1].entries()[0].attrs['teilenummer'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['baugruppe'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['teilenummer'] == part3.teilenummer
        part1.Reload()
        assert len(part1.Components) == 0

    def test_recursiveReaderWithStandardVariant(self):
        # define our own bom function in order to pass on our own mock
        # configuration (factory)
        def my_create_bom(doc, global_user_hints, custom_state=None, variant_id=None, cadsource=None):
            bs = []
            context = BOMContext(doc.cdb_object_id,
                                 doc.teilenummer, doc.t_index,
                                 'SolidWorks:asm', global_user_hints, variant_id)
            boms_of_item = create_bom_from_bom_context(context, custom_state, self.config)
            bs.extend(boms_of_item)
            return bs

        reader_type = make_recursive_reader_type(ComponentStructureBOMReader,
                                                 ResultOrder.BreadthFirst,
                                                 create_from_doc=my_create_bom)
        self.config = FactoryMockup(reader_type)

        # create test data
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        # GIVEN: a typical SolidWorks assembly where every part has a singleton "Standard" variant,
        #        with no assigned part
        topAppinfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="Standard"/>
          </occurrence>
        </occurrences>
        """
        part1AppInfo = """"
        <occurrences>
        </occurrences>
        <variants>
          <variant id="Standard" name="Standard">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part2.prt" variantid="Standard"/>
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """
        part2AppInfo = """"
        <occurrences>
        </occurrences>
        <variants>
          <variant id="Standard" name="Standard">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part3.prt" variantid="Standard"/>
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppinfo),
                Variant(None, "Standard"),
                Doc(part1, PrimaryFile("part1.prt", part1AppInfo),
                    Variant(None, "Standard"),
                    Doc(part2, PrimaryFile("part2.prt", part2AppInfo),
                        Variant(None, "Standard"),
                        Doc(part3, PrimaryFile("part3.prt", "<occurrences/>"),
                            Variant(None, "Standard"), erzeug_system='SolidWorks:asm'),
                        erzeug_system='SolidWorks:asm'),
                    erzeug_system='SolidWorks:asm'),
                erzeug_system='SolidWorks:asm')
        ]

        # WHEN: I create BOMs recursively for the top asm and the referenced assemblies
        # THEN: BOMs are created as if there were no variants at all.
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'baugruppe': self.assembly.teilenummer}
        ]
        self.expectedMessages = []
        boms = self.runTestCase()

        assert len(boms) == 4
        assert len(boms[1].entries()) == 1
        assert len(boms[2].entries()) == 1
        assert len(boms[3].entries()) == 0
        assert boms[1].entries()[0].attrs['baugruppe'] == part1.teilenummer
        assert boms[1].entries()[0].attrs['teilenummer'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['baugruppe'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['teilenummer'] == part3.teilenummer

    def test_recursiveCustomReader(self):
        # define our own bom function in order to pass on our own mock
        # configuration (factory)
        def my_create_bom(doc, global_user_hints, custom_state=None, variant_id=None, cadsource=None):
            bs = []
            context = BOMContext(doc.cdb_object_id,
                                 doc.teilenummer, doc.t_index,
                                 doc.erzeug_system, global_user_hints, variant_id)
            boms_of_item = create_bom_from_bom_context(context, custom_state, self.config)
            bs.extend(boms_of_item)
            return bs

        wasCalledForBom = {}  # BOM.id -> bool

        class ReaderWithCallback(ComponentStructureBOMReader):
            def __init__(self, bom_context, factory, custom_state):
                ComponentStructureBOMReader.__init__(self, bom_context, factory, custom_state)

            def post_write_component(self, bom, bom_entry, user_hints):
                wasCalledForBom[bom.id] = True

        reader_type = make_recursive_reader_type(ReaderWithCallback,
                                                 ResultOrder.BreadthFirst,
                                                 create_from_doc=my_create_bom)
        self.config = FactoryMockup(reader_type)

        # create test data
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part1b = createItem(benennung="part1b")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        topAppinfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" variantid="1b"/>
          </occurrence>
        </occurrences>
        """
        part1AppInfo = """"
        <occurrences>
        </occurrences>
        <variants>
          <variant id="1b" name="1b">
            <occurrences>
              <occurrence bom-relevant="yes" id="o1" sortval="1">
                <cadreference path="part2.prt" />
              </occurrence>
            </occurrences>
          </variant>
        </variants>
        """
        part2AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part3.prt" />
          </occurrence>
        </occurrences>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppinfo),
                Doc(part1, PrimaryFile("part1.prt", part1AppInfo),
                    Variant(part1b, "1b"),
                    Doc(part2, PrimaryFile("part2.prt", part2AppInfo),
                        Doc(part3, PrimaryFile("part3.prt")))))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1b.teilenummer, 't_index': part1b.t_index, 'baugruppe': self.assembly.teilenummer}
        ]
        self.expectedMessages = []
        boms = self.runTestCase()

        assert len(boms) == 4
        assert len(boms[1].entries()) == 1
        assert len(boms[2].entries()) == 1
        assert len(boms[3].entries()) == 0
        assert boms[1].entries()[0].attrs['baugruppe'] == part1b.teilenummer
        assert boms[1].entries()[0].attrs['teilenummer'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['baugruppe'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['teilenummer'] == part3.teilenummer
        part1.Reload()
        assert len(part1.Components) == 0

        # AND post_write_component was called for every BOM
        for b in boms:
            if b._entries:
                assert b.id in wasCalledForBom

    def test_recursiveReaderWithCycle(self):
        # define our own bom function in order to pass on our own mock
        # configuration (factory)
        def my_create_bom(doc, global_user_hints, custom_state=None, variant_id=None, cadsource=None):
            bs = []
            context = BOMContext(doc.cdb_object_id,
                                 doc.teilenummer, doc.t_index,
                                 'ProE', global_user_hints, variant_id)
            boms_of_item = create_bom_from_bom_context(context, custom_state, self.config)
            bs.extend(boms_of_item)
            return bs

        reader_type = make_recursive_reader_type(ComponentStructureBOMReader,
                                                 ResultOrder.BreadthFirst,
                                                 create_from_doc=my_create_bom)
        self.config = FactoryMockup(reader_type)

        # create test data
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        topAppinfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" />
          </occurrence>
        </occurrences>
        """
        part1AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part2.prt" />
          </occurrence>
        </occurrences>
        """
        part2AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part3.prt" />
          </occurrence>
        </occurrences>
        """
        # cyclic reference to toplevel assembly
        part3AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" />
          </occurrence>
        </occurrences>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppinfo),
                Doc(part1, PrimaryFile("part1.prt", part1AppInfo),
                    Doc(part2, PrimaryFile("part2.prt", part2AppInfo),
                        Doc(part3, PrimaryFile("part3.prt", part3AppInfo),
                            Uplink(levels=2)))))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'baugruppe': self.assembly.teilenummer}
        ]
        self.expectedMessages = []
        boms = self.runTestCase()

        assert len(boms) == 4
        assert len(boms[1].entries()) == 1
        assert len(boms[2].entries()) == 1
        assert len(boms[3].entries()) == 1
        assert boms[1].entries()[0].attrs['baugruppe'] == part1.teilenummer
        assert boms[1].entries()[0].attrs['teilenummer'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['baugruppe'] == part2.teilenummer
        assert boms[2].entries()[0].attrs['teilenummer'] == part3.teilenummer
        assert boms[3].entries()[0].attrs['teilenummer'] == part1.teilenummer
        assert boms[3].entries()[0].attrs['baugruppe'] == part3.teilenummer

    def test_recursiveReaderWithMaxDepth(self):
        # also tests references within one document

        # define our own bom function in order to pass on our own mock
        # configuration (factory)
        def my_create_bom(doc, global_user_hints, custom_state=None, variant_id=None, cadsource=None):
            bs = []
            context = BOMContext(doc.cdb_object_id,
                                 doc.teilenummer, doc.t_index,
                                 'ProE', global_user_hints, variant_id)
            boms_of_item = create_bom_from_bom_context(context, custom_state, self.config)
            bs.extend(boms_of_item)
            return bs

        reader_type = make_recursive_reader_type(ComponentStructureBOMReader,
                                                 ResultOrder.BreadthFirst,
                                                 create_from_doc=my_create_bom,
                                                 max_depth=2)
        self.config = FactoryMockup(reader_type)

        # create test data
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        topAppinfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1.prt" />
          </occurrence>
        </occurrences>
        """
        part1AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part1b.prt" />
          </occurrence>
        </occurrences>
        """
        part1bAppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part2.prt" />
          </occurrence>
        </occurrences>
        """
        part2AppInfo = """"
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1">
            <cadreference path="part3.prt" />
          </occurrence>
        </occurrences>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppinfo),
                Doc(part1,
                    PrimaryFile("part1.prt", part1AppInfo),
                    File("part1b.prt", part1bAppInfo),
                    Doc(part2, PrimaryFile("part2.prt", part2AppInfo),
                        Doc(part3, PrimaryFile("part3.prt")))))
        ]

        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'baugruppe': self.assembly.teilenummer}
        ]
        self.expectedMessages = []
        boms = self.runTestCase()

        assert len(boms) == 2
        assert len(boms[1].entries()) == 1
        assert boms[1].entries()[0].attrs['baugruppe'] == part1.teilenummer
        assert boms[1].entries()[0].attrs['teilenummer'] == part2.teilenummer

    def test_invalidWorkspace(self):
        self.assembly = createItem()
        appinfo = "<occurrences/>"
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                LinkItem("non-existing doc"))
        ]
        self.expectedPositions = []
        self.expectedMessages = [u"Beim Laden des Workspaces sind Fehler aufgetreten.*"]
        self.runTestCase()

    def test_multipleOccurrences(self):
        """Tests that multiple instances of the same occurrence (with the same id)
        in different appinfo files belonging to the same document does work correctly
        (i.e. no problems occur saving such occurrences).
        """
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        topAppInfo = """
        <occurrences>
          <occurrence id="occ1" bom-relevant="yes" sortval="1">
            <cadreference path="internal.prt"/>
          </occurrence>
          <occurrence id="occ2" bom-relevant="yes" sortval="2">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        appInfo2 = """
        <occurrences>
          <occurrence id="occ2" bom-relevant="yes" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppInfo),
                File("internal.prt", appInfo2),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 2.0, 'teilenummer': part1.teilenummer}]
        self.runTestCase()

    def test_multipleOccurrencesOfSubassembly(self):
        # check that handling of occurrences works correctly if
        # there are multiple identical occurrences (of part1.prt),
        # caused by multiple occurrences of a subassembly.
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        topAppInfo = """
        <occurrences>
          <occurrence id="occ1" bom-relevant="yes" sortval="1">
            <cadreference path="internal.asm"/>
          </occurrence>
          <occurrence id="occ2" bom-relevant="yes" sortval="2">
            <cadreference path="internal.asm"/>
          </occurrence>
          <occurrence id="occ3" bom-relevant="yes" sortval="2">
            <cadreference path="internal2.asm"/>
          </occurrence>
        </occurrences>
        """
        appInfo2 = """
        <occurrences>
          <occurrence id="occ1" bom-relevant="yes" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppInfo),
                File("internal.asm", appInfo2),
                File("internal2.asm", appInfo2),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 3.0, 'teilenummer': part1.teilenummer}]
        self.runTestCase()

        # also check that deleting occurrences works, even if the there multiple
        # occurrence where the only difference is the assembly_path
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", topAppInfo),
                File("internal.asm", appInfo2),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 2.0, 'teilenummer': part1.teilenummer}]
        self.runTestCase()

    def test_positionNumberIsReusedWhenNewIndexIsUsed(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1", teilenummer="%s %s" % (prefix, "posReuse"), t_index="")
        part1a = createItem(benennung="part1a", teilenummer="%s %s" % (prefix, "posReuse"), t_index="a")
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}]
        self.runTestCase()

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1a, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1a.teilenummer, 't_index': part1a.t_index},
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}]
        self.expectedStatus = [u'neu', u'gelöscht']
        self.expectedInDatabase = [{'position': 10, 'menge': 1.0, 'teilenummer': part1a.teilenummer, 't_index': part1a.t_index}]
        self.runTestCase()

    def test_automaticPositionsTakeIntoAccountOtherCadsources(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part1")
        # create a position with posno 10
        AssemblyComponent.Create(baugruppe=self.assembly.teilenummer, b_index=self.assembly.t_index,
                                 teilenummer=part2.teilenummer, t_index=part2.t_index,
                                 position=10, menge=1.0, cadsource="manuell",
                                 variante='', auswahlmenge=0.0)

        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [{'position': 20, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}]
        self.expectedInDatabase = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'cadsource': "manuell"},
            {'position': 20, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}]
        self.runTestCase()

    def test_positionNumberIsReusedWhenReplaceByCopy(self):
        # GIVEN: an assembly and two parts, where part1b can be throught of as a copy of part1a
        self.assembly = createItem()
        part1a = createItem(benennung="part1a", teilenummer="%s %s" % (prefix, "posReuseCopyA"), t_index="")
        part1b = createItem(benennung="part1b", teilenummer="%s %s" % (prefix, "posReuseCopyB"), t_index="")
        # AND: the assembly uses part1a
        appinfoA = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="1">
            <cadreference path="part1A.prt"/>
          </occurrence>
          <occurrence id="o2" bom-relevant="yes" sortval="2">
            <cadreference path="part1A.prt"/>
          </occurrence>
        </occurrences>
        """
        # AND: there is a BOM from before, using part1a
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfoA),
                Doc(part1a, PrimaryFile("part1A.prt")))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 2.0, 'teilenummer': part1a.teilenummer, 't_index': part1a.t_index}]
        self.runTestCase()

        # WHEN: I replace part1a with part1b but the same occurrence ids are still used
        # AND: create the BOM again
        appinfoB = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="1">
            <cadreference path="part1B.prt"/>
          </occurrence>
          <occurrence id="o2" bom-relevant="yes" sortval="2">
            <cadreference path="part1B.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfoB),
                Doc(part1b, PrimaryFile("part1B.prt")))
        ]
        # THEN: part1 is replaced in the BOM and the same position number is re-used
        self.expectedPositions = [
            {'position': 10, 'menge': 2.0, 'teilenummer': part1b.teilenummer, 't_index': part1b.t_index},
            {'position': 10, 'menge': 2.0, 'teilenummer': part1a.teilenummer, 't_index': part1a.t_index}
        ]
        self.expectedStatus = [u'neu', u'gelöscht']
        self.expectedInDatabase = [{'position': 10, 'menge': 2.0, 'teilenummer': part1b.teilenummer, 't_index': part1b.t_index}]
        self.runTestCase()

    def test_aPartCanBeUsedInMultipleVersionsInTheSameAssembly(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1", teilenummer="%s %s" % (prefix, "posReuse"), t_index="")
        part1a = createItem(benennung="part1a", teilenummer="%s %s" % (prefix, "posReuse"), t_index="a")
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="1">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence id="o2" bom-relevant="yes" sortval="2">
            <cadreference path="part1a.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")),
                Doc(part1a, PrimaryFile("part1a.prt")))
        ]
        self.expectedPositions = [{'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index},
                                  {'position': 20, 'menge': 1.0, 'teilenummer': part1a.teilenummer, 't_index': part1a.t_index}]
        self.runTestCase()

    def test_sortValOfOccurrenses(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence id="o2" bom-relevant="yes" sortval="7">
            <cadreference path="part2.prt"/>
          </occurrence>
          <occurrence id="o3" bom-relevant="yes" sortval="1">
            <cadreference path="part3.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")),
                Doc(part2, PrimaryFile("part2.prt")),
                Doc(part3, PrimaryFile("part3.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part3.teilenummer, 't_index': part3.t_index},
            {'position': 20, 'menge': 1.0, 'teilenummer': part2.teilenummer, 't_index': part2.t_index},
            {'position': 30, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}
        ]
        self.runTestCase()

    def test_suddenlyOccurrences(self):
        # test that there is no misleading error message if a BOM position
        # without occurrences suddenly receives occurrences (E025904)

        # SETUP
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}
        ]
        self.runTestCase()

        # delete occurrences
        new_com = self.assembly.Components[0]
        occs = new_com.Occurrences
        occs.Delete()

        # ACTUAL TEST
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence id="o2" bom-relevant="yes" sortval="20">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 2.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}
        ]
        [bom] = self.runTestCase()
        hints = bom.user_hints
        assert not hints.has_error()
        assert len(hints) == 1

    @without_error_logging
    def test_docWithoutArticle(self):
        self.workspace = [Doc(item=None)]
        doc = createDocumentStructure(self.workspace)
        hintsAndErrors = UserHintList()
        boms = create_bom(doc, hintsAndErrors)

        assert not boms
        assert len(hintsAndErrors) == 1

        assert "Es ist eine Artikelzuordnung erforderlich" in hintsAndErrors[0][0]

    def test_floatAttribute(self):
        # float attributes as keys;
        # also tests display of float attributes
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['netto_laenge'],
                                    key_attrs=['teilenummer', 't_index', 'netto_laenge'],
                                    sync_from_cad_attrs=[('netto_laenge', 'length', False)])

        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" length="1.8330000000000002" />
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" length="1.833" />
        </bom>""" % (part1.teilenummer, part1.t_index, part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedDisplay = [['1.833']]
        self.expectedPositions = [
            {'position': 10, 'menge': 2.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index}
        ]

        self.runTestCase()

    def test_modifyExistingPosition(self):
        self.assembly = createItem()
        self.workspace = [Doc(self.assembly)]
        with error_logging_disabled():
            [bom] = self.runTestCase()

        part1 = createItem()
        existingEntry = bom.create_and_add_entry(teilenummer=part1.teilenummer, auswahlmenge=1.0)
        assert existingEntry is None
        existingEntry = bom.create_and_add_entry(teilenummer=part1.teilenummer, auswahlmenge=2.0)
        assert existingEntry is not None
        # attributes are not automatically aggregated (except for 'menge')
        assert value_is_equal(existingEntry.attrs['auswahlmenge'], 1.0)
        # update auswahlmenge manually
        existingEntry.attrs['auswahlmenge'] += 2.0
        bom.synchronize()
        GeneratedBOM.from_json(json.loads(bom.json, cls=ReplaceDatetimeDecoder))
        userHints = UserHintList()
        bom.write(userHints)
        # check value in database
        assert len(self.assembly.Components) == 1
        assert value_is_equal(self.assembly.Components[0].auswahlmenge, 3.0)

    def test_internalKeyChangedButDbKeyStayedTheSame(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    key_attrs=['teilenummer', 't_index', 'netto_laenge'],
                                    sync_from_cad_attrs=[('netto_laenge', 'length', False)])

        # setup
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" length="1.0" />
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'netto_laenge': 1.0}
        ]
        self.runTestCase()

        # actual test: change laenge to 2.0
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" length="2.0" />
        </bom>""" % (part1.teilenummer, part1.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedStatus = [u'neu', u'gelöscht']
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'netto_laenge': 2.0},
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'netto_laenge': 1.0}
        ]
        self.expectedInDatabase = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'netto_laenge': 2.0}
        ]
        self.expectedMessages = [u"Die Stückliste .* wurde abgeglichen."]
        self.runTestCase()

    def test_manualPositionsAreNotReplaced(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        # create a manual position
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "manuell"}
        ]
        self.runTestCase("manuell")

        # add a ProE position
        self.expectedPositions = [
            {'position': 20, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"}
        ]
        self.expectedInDatabase = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "manuell"},
            {'position': 20, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"}
        ]
        self.runTestCase()

    def test_manualPositionsAreReplacedIfConfigured(self):
        self.config = FactoryMockup(ComponentStructureBOMReader, cadsource_to_replace="manuell")
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        # create two manual positions
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
          <occurrence id="o2" bom-relevant="yes" sortval="20">
            <cadreference path="part2.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")),
                Doc(part2, PrimaryFile("part2.prt"))
                )
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "manuell"},
            {'position': 20, 'menge': 1.0, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'cadsource': "manuell"}
        ]
        self.runTestCase("manuell")

        # add a ProE position
        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt"))
                )
        ]
        # only the matching position is displayed
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"}
        ]
        # the matching position is replaced
        # the other position is left alone
        self.expectedInDatabase = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"},
            {'position': 20, 'menge': 1.0, 'teilenummer': part2.teilenummer, 't_index': part2.t_index, 'cadsource': "manuell"}
        ]
        self.runTestCase()

    def test_preShowComponent_isCalled(self):
        self.assembly = createItem()
        assembly = self.assembly
        part1 = createItem(benennung="part1")
        globals = {'wasCalled': False}

        class ReaderWithCallback(ComponentStructureBOMReader):
            def __init__(self, bom_context, factory, custom_state):
                ComponentStructureBOMReader.__init__(self, bom_context, factory, custom_state)

            def pre_show_component(self, bom, bom_entry, user_hints):
                globals['wasCalled'] = True
                bom_entry.attrs['strukturzaehler'] = bom_entry.attrs['position']

        self.config = FactoryMockup(ReaderWithCallback,
                                    display_attrs=['position', 'strukturzaehler'])

        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedDisplay = [
            [10, 10]
            ]
        self.expectedPositions = [
            {'position': 10, 'strukturzaehler': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"}
        ]
        self.expectedInDatabase = [
            {'position': 10, 'strukturzaehler': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"}
        ]
        self.runTestCase()

        assert globals['wasCalled']

    def test_postWriteComponent_isCalled(self):
        self.assembly = createItem()
        assembly = self.assembly
        part1 = createItem(benennung="part1")
        globals = {'wasCalled': False}

        class ReaderWithCallback(ComponentStructureBOMReader):
            def __init__(self, bom_context, factory, custom_state):
                ComponentStructureBOMReader.__init__(self, bom_context, factory, custom_state)

            def post_write_component(self, bom, bom_entry, user_hints):
                globals['wasCalled'] = True
                assert bom.get_assembly().teilenummer == assembly.teilenummer
                assert len(bom.entries()) == 1
                assert bom_entry.attrs['teilenummer'] == part1.teilenummer

        self.config = FactoryMockup(ReaderWithCallback)

        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedPositions = [
            {'position': 10, 'menge': 1.0, 'teilenummer': part1.teilenummer, 't_index': part1.t_index, 'cadsource': "ProE"}
        ]
        self.runTestCase()

        assert globals['wasCalled']

    def test_postWriteBom(self):
        self.assembly = createItem()
        assembly = self.assembly
        part1 = createItem(benennung="part1")
        globals = {'wasCalledForMainBom': False, 'wasCalledForExtraBom': False}

        class ReaderWithCallback(ComponentStructureBOMReader):
            def __init__(self, bom_context, factory, custom_state):
                ComponentStructureBOMReader.__init__(self, bom_context, factory, custom_state)
                self.boms[0].set_user_attribute("is_main_bom", True)
                extraBom = factory.create_assembly_and_BOM(t_kategorie="Baugruppe")
                self.boms.append(extraBom)

            def post_write_bom(self, bom, user_hints):
                if bom.get_user_attribute("is_main_bom"):
                    globals['wasCalledForMainBom'] = True
                    assert bom.get_assembly().teilenummer == assembly.teilenummer
                    assert len(bom.entries()) == 1
                    user_hints.append(u"Warning2")
                else:
                    globals['wasCalledForExtraBom'] = True
                    assert len(bom.entries()) == 0

        self.config = FactoryMockup(ReaderWithCallback)

        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedMessages = [u"Warning2"]
        self.runTestCase()

        assert globals['wasCalledForMainBom']
        assert globals['wasCalledForExtraBom']

    def test_postWriteBoms(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        globals = {'postWasCalled': False}

        class ReaderWithCallback(ComponentStructureBOMReader):
            def __init__(self, bom_context, factory, custom_state):
                ComponentStructureBOMReader.__init__(self, bom_context, factory, custom_state)
                extraBom = factory.create_assembly_and_BOM(t_kategorie="Baugruppe")
                self.boms.append(extraBom)

            def post_write_boms(self, boms, user_hints):
                globals['postWasCalled'] = True
                assert len(boms) == 2
                user_hints.append(u"Warning2")

        self.config = FactoryMockup(ReaderWithCallback)

        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedMessages = [u"Warning2"]
        self.runTestCase()

        assert globals['postWasCalled']

    @without_error_logging
    def test_noConfig(self):
        originalFindMethod = BOMConfig.find_config

        def find_config_dummy(_cadsource, _object_id, _only_applicables=True):
            return None
        try:
            BOMConfig.find_config = staticmethod(find_config_dummy)
            userHints = UserHintList()
            context = BOMContext("dummy_object_id", "dummy_teilenummer", "", "acad", userHints)
            factory = Factory(context)
        finally:
            BOMConfig.find_config = staticmethod(originalFindMethod)

    def test_sharedPositionNumbers(self):
        # given: a a document with an assembly and an initially empty bom
        self.assembly = createItem()
        self.workspace = [Doc(self.assembly)]
        doc = createDocumentStructure(self.workspace)
        global_user_hints = UserHintList()
        context = BOMContext(doc.cdb_object_id,
                             doc.teilenummer, doc.t_index,
                             'ProE', global_user_hints)
        with error_logging_disabled():
            [bom] = create_bom_from_bom_context(context, None, self.config)

        # when: I add multiple entries with shared position numbers and save the bom
        part1a = createItem()
        part1b = createItem()
        part2a = createItem()
        part2b = createItem()
        shared1 = SharedPosition()
        shared2 = SharedPosition()
        bom.create_and_add_entry(teilenummer=part1a.teilenummer, t_index=part1a.t_index, position=shared1)
        entry1a = bom.entries()[-1]
        bom.create_and_add_entry(teilenummer=part1b.teilenummer, t_index=part1b.t_index, position=shared1)
        entry1b = bom.entries()[-1]
        bom.create_and_add_entry(teilenummer=part2a.teilenummer, t_index=part2a.t_index, position=shared2)
        entry2a = bom.entries()[-1]
        bom.create_and_add_entry(teilenummer=part2b.teilenummer, t_index=part2b.t_index, position=shared2)
        entry2b = bom.entries()[-1]

        bom.synchronize()
        GeneratedBOM.from_json(json.loads(bom.json, cls=ReplaceDatetimeDecoder))
        bom.write(global_user_hints)

        # then: the SharedPosition objects have been replaced and
        # the entries now share a new, generated position value
        assert not isinstance(entry1a.position(), SharedPosition)
        assert not isinstance(entry2a.position(), SharedPosition)
        assert entry1a.position() == entry1b.position()
        assert entry2a.position() == entry2b.position()
        assert entry2a.position() != entry1a.position()
        positionNumberInDb = entry1a.position()

        # when: I create this BOM again (for the same assembly)
        # and add an additional entry with a shared position
        with error_logging_disabled():
            [bom] = create_bom_from_bom_context(context, None, self.config)
        part1c = createItem()

        shared1 = SharedPosition()
        bom.create_and_add_entry(teilenummer=part1a.teilenummer, t_index=part1a.t_index, position=shared1)
        entry1a = bom.entries()[-1]
        bom.create_and_add_entry(teilenummer=part1b.teilenummer, t_index=part1b.t_index, position=shared1)
        entry1b = bom.entries()[-1]
        bom.create_and_add_entry(teilenummer=part1c.teilenummer, t_index=part1c.t_index, position=shared1)  # !
        entry1c = bom.entries()[-1]
        bom.create_and_add_entry(teilenummer=part2a.teilenummer, t_index=part2a.t_index)
        bom.create_and_add_entry(teilenummer=part2b.teilenummer, t_index=part2b.t_index)

        bom.synchronize()
        GeneratedBOM.from_json(json.loads(bom.json, cls=ReplaceDatetimeDecoder))

        # then: the entries' status is right and the new entry shares the position number
        assert entry1a.status == BOMEntry.Unchanged
        assert entry1a.status == BOMEntry.Unchanged
        assert entry1c.status == BOMEntry.New
        assert entry1a.position() == positionNumberInDb
        assert entry1b.position() == positionNumberInDb
        assert entry1c.position() == positionNumberInDb

    def test_lookupOfCadReferencesIsCaseInsensitive(self):
        # given: a Document/File structure using upper and lower case
        # file names and subdirectories
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part3")

        # when: I try to create a BOM using CAD references which use these
        # file names and directories with different case
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="DOC1.PRT"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o3" sortval="3"> <cadreference path="subdir/SUBSUB/doc3.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")),
                Doc(part2, PrimaryFile("DOC2.PRT")),
                Doc(part3, Directory("SUBDIR", Directory("subsub", PrimaryFile("doc3.prt")))))
        ]

        # then: the references are looked up successfully in spite of the differences in case
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 30, 'teilenummer': part3.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
        ]

        self.runTestCase()

    def test_merge_boms(self):
        # GIVEN: two boms, partly with the same items
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")
        part3 = createItem(benennung="part2")

        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
          <occurrence bom-relevant="yes" id="o2" sortval="2"> <cadreference path="doc2.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")),
                Doc(part2, PrimaryFile("doc2.prt"))),
        ]
        [bom1] = self.runTestCase()

        bom2 = BOM()
        key2 = (part2.teilenummer, part2.t_index)
        bom2.add_entry(BOMEntry(key=key2,
                                attributes={'teilenummer': part2.teilenummer,
                                            't_index': part2.t_index,
                                            'menge': 2.0},
                                display_exprs=[]))
        key3 = (part3.teilenummer, part3.t_index)
        bom2.add_entry(BOMEntry(key=key3,
                                attributes={'teilenummer': part3.teilenummer,
                                            't_index': part3.t_index,
                                            'menge': 1.0},
                                display_exprs=[]))

        # WHEN: I merge the boms
        bom1.merge_bom(bom2)

        # THEN: the entries were merged
        assert len(bom1.entries()) == 3
        keys = set()
        for key, entry in bom1._entries.iteritems():
            keys.add(entry.key)
            # AND THEN: the entries have been assigned to the correct assembly
            assert entry.attrs['baugruppe'] == self.assembly.teilenummer
            assert entry.attrs['b_index'] == self.assembly.t_index

        # AND THEN: all expected entries are there
        key1 = (part1.teilenummer, part1.t_index)
        assert keys == {key1, key2, key3}

        # AND THEN: the amount has been summed correctly
        assert bom1._entries[key2].attrs['menge'] == 3.0

    @without_error_logging
    def test_incompleteAppinfo(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <appinfo incomplete-nodes="structureOnly">
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
        </occurrences>
        </appinfo>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt"))
                )
        ]

        self.expectedPositions = [
        ]
        self.expectedMessages = [
            "Die vorläufigen Dateiinformationen .* sind nicht zur Stücklistenausleitung geeignet.*"
        ]

        self.runTestCase()

    @without_error_logging
    def test_incompleteAppinfo2(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        appinfo = """
        <appinfo incomplete-nodes="noStructure">
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
        </occurrences>
        </appinfo>
        """

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt"))
                )
        ]

        self.expectedPositions = [
        ]
        self.expectedMessages = [
            "Die vorläufigen Dateiinformationen .* sind nicht zur Stücklistenausleitung geeignet.*"
        ]

        self.runTestCase()

    def test_runOnNonDocument(self):
        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        # GIVEN a trivial bom reader that works on a variant
        class VariantReader(SimpleBOMReader):
            def fill_BOM(self, bom_context):
                variant = ByID(bom_context.object_id)
                self.add_position(teilenummer=part1.teilenummer, t_index=part1.t_index, stlbemerkung=variant.variant_id)
                self.add_warning(u"This is just a test")

        self.config = FactoryMockup(VariantReader)

        # AND a cad variant with an assigned item
        self.workspace = [Variant(self.assembly, "variant1")]

        # WHEN I run the bom reader
        # THEN: a bom is created and saved in the database
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'stlbemerkung': "variant1"}
            ]
        self.expectedMessages = [u"This is just a test"]
        self.runTestCase()

    def test_existingPositionWithoutCadSource(self):
        self.assembly = createItem()
        # GIVEN: an existing position without cadsource
        part1 = createItem(benennung="part1")
        appinfo = """
        <occurrences>
          <occurrence bom-relevant="yes" id="o1" sortval="1"> <cadreference path="doc1.prt"/> </occurrence>
        </occurrences>"""

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("doc1.prt")))
        ]
        self.runTestCase()
        # remove its CAD source
        comp1 = self.assembly.Components[0]
        comp1.Update(cadsource=None)

        # WHEN: I create the BOM again
        # THEN: a new position is created (the position without CAD source is left alone)
        self.expectedPositions = [
            {'position': 20, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'cadsource': "ProE"}
            ]
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'cadsource': None},
            {'position': 20, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'cadsource': "ProE"}
            ]
        self.runTestCase()


class Test_wsmbomtools_Transactions(BOMTestCase, PlatformTestCase):
    """
    Test cases that test behaviour in the context of transactions.
    So these test cases cannot use RollbackTestCase
      (no nested transactions).
    """
    def setUp(self):
        PlatformTestCase.setUp(self)
        BOMTestCase.setUp(self)
        self.delete_all()

    def tearDown(self):
        self.delete_all()
        BOMTestCase.tearDown(self)
        PlatformTestCase.tearDown(self)

    def delete_all(self):
        sqlapi.SQLdelete("FROM teile_stamm WHERE teilenummer LIKE '" + prefix + "%'")
        sqlapi.SQLdelete("FROM zeichnung WHERE z_nummer LIKE '" + prefix + "%'")
        sqlapi.SQLdelete("FROM einzelteile WHERE baugruppe LIKE '" + prefix + "%'")
        sqlapi.SQLdelete("FROM bom_item_occurrence WHERE baugruppe LIKE '" + prefix + "%'")
        sqlapi.SQLdelete("FROM cad_variant WHERE variant_name LIKE '" + prefix + "%'")
        OBJECT_STORE.set_dirty()

    @without_error_logging
    def test_postWriteComponent_rollback(self):
        class ReaderWithCallback(ComponentStructureBOMReader):
            def post_write_component(self, bom, bom_entry, user_hints):
                user_hints.append(u"Warning1")
                raise RuntimeError(u"Error generating bom")
        self.config = FactoryMockup(ReaderWithCallback)

        self.assembly = createItem()
        part1 = createItem(benennung="part1")

        appinfo = """
        <occurrences>
          <occurrence id="o1" bom-relevant="yes" sortval="10">
            <cadreference path="part1.prt"/>
          </occurrence>
        </occurrences>
        """
        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo),
                Doc(part1, PrimaryFile("part1.prt")))
        ]
        self.expectedInDatabase = []
        self.expectedMessages = [u"Warning1", u"Error generating bom"]
        self.runTestCase()

    @without_error_logging
    def test_transaction(self):
        self.config = FactoryMockup(CADBomInfoReader,
                                    display_attrs=['position'],
                                    sync_from_cad_attrs=[('auswahlmenge', 'auswahlmenge', True)],
                                    sync_attrs=['menge', 'auswahlmenge', 'position'])
        self.assembly = createItem()
        part1 = createItem(benennung="part1")
        part2 = createItem(benennung="part2")

        # 1. create two positions
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="10" />
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" posno="20">
            <properties>
              <property id="auswahlmenge" value="3.0" type="int"/>
            </properties>
          </bomposition>
        </bom>""" % (part1.teilenummer, part1.t_index, part2.teilenummer, part2.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'auswahlmenge': 3.0},
        ]
        self.expectedStatus = ['neu', 'neu']
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'auswahlmenge': 3.0},
        ]
        self.expectedDisplay = [[10], [20]]
        self.runTestCase()

        # now run again with illegal value for auswahlmenge
        # check that the BOM is not changed in the database
        appinfo = """
        <bom>
          <bomposition id="p1" partno="%s" partver="%s" quantity="1" posno="30" />
          <bomposition id="p2" partno="%s" partver="%s" quantity="1" posno="20">
            <properties>
              <property id="auswahlmenge" value="stringabc" type="int"/>
            </properties>
          </bomposition>
        </bom>""" % (part1.teilenummer, part1.t_index, part2.teilenummer, part2.t_index)

        self.workspace = [
            Doc(self.assembly, PrimaryFile("assembly.asm", appinfo))
        ]
        self.expectedPositions = [
            {'position': 30, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'auswahlmenge': "stringabc"},
        ]
        self.expectedDisplay = None
        self.expectedStatus = None
        # database should stay unchanged:
        self.expectedInDatabase = [
            {'position': 10, 'teilenummer': part1.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0},
            {'position': 20, 'teilenummer': part2.teilenummer, 't_index': u'', 'baugruppe': self.assembly.teilenummer, 'b_index': '', 'menge': 1.0, 'auswahlmenge': 3.0},
        ]
        self.runTestCase()


def rebirth_bom(bom, FactoryClass=None):
    js = json.dumps(bom.to_json(), cls=ReplaceDatetimeEncoder)
    bom2 = GeneratedBOM.from_json(json.loads(js, cls=ReplaceDatetimeDecoder), FactoryClass)
    return bom2


# Guard importing as main module
if __name__ == "__main__":
    import nose
    import sys
    nose.runmodule(argv=sys.argv)
