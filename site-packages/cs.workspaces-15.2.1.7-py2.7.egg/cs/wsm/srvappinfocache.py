#!/usr/bin/env python
# -*- python -*- coding: iso-8859-1 -*-
# $Id: srvappinfocache.py 175677 2018-04-10 08:23:17Z hth $
#
# Copyright (C) 1990 - 2010 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#
# File:     appinfocache.py
# Author:   jro
# Creation: 19.05.10
# Purpose:

"""
Module appinfocache.py

This is the documentation for the appinfocache.py module.
"""

__docformat__ = "restructuredtext en"

from cdb import misc
from cs.wsm.lrucache import LRUCache
from cs.wsm.srvappinfoparser import NoAppinfoContentError


class logClasses(object):
    kLogErr = misc.kLogErr
    kLogMsg = misc.kLogMsg


class AppInfoCache(object):
    def __init__(self, appInfoParser):
        self._lruCache = LRUCache(10000)
        self._appInfoParser = appInfoParser

    def getAppinfo(self, appinfoFileObject):
        revisionBlobId = appinfoFileObject.cdbf_hash
        found, appinfoData = self._lruCache.getObject(revisionBlobId)
        if not found:
            content = appinfoFileObject.get_content()
            if content:
                try:
                    appinfoData = self._appInfoParser.parseAppInfo(content)
                    self._lruCache.addObject(revisionBlobId, appinfoData)
                except NoAppinfoContentError:
                    # Do not crash when appinfo file is empty
                    misc.cdblogv(
                        logClasses.kLogErr, 0,
                        u"AppInfo file '%s' '%s' had empty content." %
                        (appinfoFileObject.cdb_object_id, appinfoFileObject.cdbf_name))
        return appinfoData
