#!/usr/bin/env python
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 1990 - 2012 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#
from cdb import util, sqlapi
from cdb.objects import org
from cdb.validationkit import generateUser
import cdbwrapc

__docformat__ = "restructuredtext en"
__revision__ = "$Id: environment.py 135894 2016-01-14 08:35:18Z wen $"


class EventListener(util.DBEventListener):
    __listener = None

    def __init__(self):
        super(EventListener, self).__init__()
        self.__events = []

    def notify(self, relation, event):
        self.__events.append(
            (event.m_event,
             relation,
             event.m_keys.items()))

    def rollback(self):
        def generateWhere(keys):
            where = ""
            for key, value in keys:
                where += "%s='%s' AND " % (key, value)
            return where[:-5]
        try:
            self.doUnregister()
            self.__events.reverse()
            for t, relation, keys in self.__events:
                if t == util.kRecordInserted and relation != "cdb_global_subj":
                    sqlapi.SQLdelete("FROM %s where %s" % (relation,
                                     generateWhere(keys)))
        finally:
            self.clear()
            self.doRegister()

    def clear(self):
        self.__events = []

    @classmethod
    def getListener(cls):
        if not EventListener.__listener:
            EventListener.__listener = EventListener()
        return EventListener.__listener


def before_all(context):
    # Create a new user to use for testing and login as this one
    users = org.User.KeywordQuery(personalnummer="behave_test")
    if len(users) > 0:
        context.user = users[0]
    else:
        context.user = generateUser("behave_test")

    assert cdbwrapc.set_user(context.user.personalnummer),\
        "The User couldn't be logged in"


def before_feature(context, feature):
    pass


def before_scenario(context, scenario):
    listener = EventListener.getListener()
    listener.doRegister()


def before_step(context, step):
    pass


def after_step(context, step):
    pass


def after_scenario(context, scenario):
    listener = EventListener.getListener()
    listener.rollback()
    listener.doUnregister()


def after_feature(context, feature):
    pass


def after_all(context):
    # Delete the created user
    if hasattr(context, "user"):
        context.user.Delete()


def at_exit():
    pass
