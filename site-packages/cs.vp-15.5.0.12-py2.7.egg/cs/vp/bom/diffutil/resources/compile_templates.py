import os
import codecs
import argparse

from embercompressorcompiler import EmberPrecompiler


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Compile handelbars templates '
                                                 'for ember')
    parser.add_argument('folder', help='Templates folder')
    parser.add_argument('-o', dest='output', nargs='?', help='Output file',
                        default='templates.js')

    args = parser.parse_args()
    templates_folder = os.path.abspath(args.folder)

    compiler = EmberPrecompiler()
    templates = ""

    for root, _, files in os.walk(templates_folder):
        for _filename in files:
            if _filename.endswith('.hbs'):
                filename = os.path.join(root, _filename)
                with codecs.open(filename, 'r', 'utf8') as f:
                    name = filename.replace(templates_folder + os.path.sep, '').\
                        replace(os.path.sep, '/')[:-4]
                    templates += compiler.compile(name, f.read())

    with codecs.open(args.output, 'w+', 'utf8') as f:
        f.write(templates)
