#!/usr/bin/env powerscript
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 2013 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#

from cdb.util import get_label
from cdb import objects

from cs.platform.web import root


DRAWING_RULE = "mBOM Manager: 2D documents"
MODEL_RULE = "3D Models"
THREED_AVAILABLE = None


def _threed_available():
    global THREED_AVAILABLE
    if THREED_AVAILABLE is None:
        try:
            import cs.threed
            THREED_AVAILABLE = True
        except ImportError:
            THREED_AVAILABLE = False
    return THREED_AVAILABLE


def get_available_viewers_for_document(doc, request):
    drawing_rule = objects.Rule.ByKeys(DRAWING_RULE)
    is_drawing = drawing_rule.match(doc)

    model_rule = objects.Rule.ByKeys(MODEL_RULE)
    is_model = model_rule.match(doc)

    result = []
    collection_app = root.get_v1(request).child("collection")

    if is_drawing is True:
        viewing_file = doc.get_primary_pdf()
        component = "cs-web-components-pdf-PDFViewer"
        if viewing_file is None:
            viewing_file = doc.get_primary_png()
            component = "cs-web-components-base-ImageViewer"

        if viewing_file is not None:
            result.append({
                "props": {
                    "filename": viewing_file.cdbf_name,
                    "url": request.link(viewing_file, app=collection_app)
                },
                "label": get_label("cs_vp_preview_twod"),
                "component": component
            })

    if is_model is True:
        if _threed_available():
            result.append({
                "props": {
                    "model": doc.cdb_object_id
                },
                "label": get_label("cs_vp_preview_threed"),
                "component": "cs-threed-hoops-web-cockpit-Preview"
            })
        else:
            viewing_file = doc.get_primary_pdf()
            component = "cs-web-components-pdf-PDFViewer"
            if viewing_file is None:
                viewing_file = doc.get_primary_png()
                component = "cs-web-components-base-ImageViewer"

            if viewing_file is not None:
                result.append({
                    "props": {
                        "filename": viewing_file.cdbf_name,
                        "url": request.link(viewing_file, app=collection_app)
                    },
                    "label": get_label("cs_vp_preview_threed"),
                    "component": component
                })

    return result
