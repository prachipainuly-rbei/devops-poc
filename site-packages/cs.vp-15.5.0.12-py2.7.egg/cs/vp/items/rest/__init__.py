#!/usr/bin/env powerscript
# -*- python -*- coding: iso-8859-1 -*-
#
# Copyright (C) 2013 CONTACT Software GmbH
# All rights reserved.
# http://www.contact.de/
#

from webob.exc import HTTPNotFound

from cs.vp.cad.rest import get_available_viewers_for_document
from cs.vp.items import Item

from cs.platform.web.root import Internal
from cs.platform.web import JsonAPI

__revision__ = "$Id: __init__.py 162706 2017-08-04 06:42:33Z gda $"

__APP_NAME__ = "items"


class VpItemsInternalApp(JsonAPI):
    pass


@Internal.mount(app=VpItemsInternalApp, path=__APP_NAME__)
def _mount_internal():
    return VpItemsInternalApp()


class AvailableViewers(object):
    def __init__(self, object_id):
        self.object_id = object_id

    def get_available_viewers(self, request):
        item = Item.ByKeys(cdb_object_id=self.object_id)
        if item is None:
            raise HTTPNotFound()
        documents = item.get_preview_documents()

        result = []
        for doc in documents:
            result.extend(get_available_viewers_for_document(doc, request))
        return result


@VpItemsInternalApp.path(path="available_viewers/{object_id}", model=AvailableViewers)
def _get_available_viewers(object_id):
    return AvailableViewers(object_id)


@VpItemsInternalApp.json(model=AvailableViewers)
def _get_result(result, request):
    return result.get_available_viewers(request)
