var jQuery = require('jquery');


var _getFirstPage = function(data) {
    if (data && data.query && data.query.pages) {
        // pick a random pages
        for (var page_id in data.query.pages) {
            if (data.query.pages.hasOwnProperty(page_id)) {
                break;
            }
        }

        return data.query.pages[page_id];
    }
};


exports.getImage = function(name, callback) {
    jQuery.ajax({
        url: 'https://en.wikipedia.org/w/api.php',
        dataType: 'jsonp',
        data: {
            action: 'query',
            format: 'json',
            prop: 'pageimages',
            titles: name,
            redirects: true
        },
        success: function(data) {
            var page = _getFirstPage(data);
            if (page && page.pageimage) {
                jQuery.ajax({
                    url: 'https://en.wikipedia.org/w/api.php',
                    dataType: 'jsonp',
                    data: {
                        action: 'query',
                        format: 'json',
                        prop: 'imageinfo',
                        titles: 'File:' + page.pageimage,
                        iiprop: 'url',
                        redirects: true
                    },
                    success: function (data) {
                        var page = _getFirstPage(data);
                        if (page.imageinfo && page.imageinfo.length) {
                            callback(page.imageinfo[0].url);
                        } else {
                            callback();
                        }
                    }
                });
            } else {
                callback();
            }
        },
        error: function() {
            callback();
        }
    });
};
